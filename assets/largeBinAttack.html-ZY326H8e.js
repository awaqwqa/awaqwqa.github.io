import{_ as e}from"./plugin-vue_export-helper-x3n3nnut.js";import{r as p,o,c,a as n,b as s,d as t,e as i}from"./app-mtXdL8hD.js";const l={},u=n("h1",{id:"large-bin-attack学习-int-malloc源码细读",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#large-bin-attack学习-int-malloc源码细读","aria-hidden":"true"},"#"),s(" large Bin Attack学习（_int_malloc源码细读 ）")],-1),k=n("br",null,null,-1),r={href:"https://ctf-wiki.org/pwn/linux/user-mode/heap/ptmalloc2/large-bin-attack/",target:"_blank",rel:"noopener noreferrer"},d=n("br",null,null,-1),v={href:"https://blog.csdn.net/astrotycoon/article/details/52662685",target:"_blank",rel:"noopener noreferrer"},m=n("br",null,null,-1),b={href:"https://www.cnblogs.com/luoleqi/p/15520621.html",target:"_blank",rel:"noopener noreferrer"},f={href:"https://www.cnblogs.com/luoleqi/p/12731875.html#_int_malloc",target:"_blank",rel:"noopener noreferrer"},h=n("br",null,null,-1),_=n("br",null,null,-1),g=i(`<h2 id="源码分析-largebin-malloc" tabindex="-1"><a class="header-anchor" href="#源码分析-largebin-malloc" aria-hidden="true">#</a> 源码分析(largebin malloc)</h2><blockquote><p>每次去看别人文章分析总结的 总感觉比较难记住 每个libc版本的区别 然后也没彻底理解一些操作 所以进行阅读源码</p><p>然后重点是检查机制部分 如果只想看重点就直接跳转到<a href="#largebin">largebin入链操作</a></p></blockquote><ul><li><p>然后在正式阅读源码之前 我们先理清楚largebin的结构（去除了头部的fd_nextsize/bk_nextsize 为了图片干净一点）</p><figure><img src="https://awaqwqa.github.io/img/large_bin_attack/largebin_attack.png" alt="largebin_struct" tabindex="0" loading="lazy"><figcaption>largebin_struct</figcaption></figure><ul><li><p>我们可以简化一下 去除尾链的fd和头链的bk方便我们理清逻辑</p><figure><img src="https://awaqwqa.github.io/img/large_bin_attack/struct.png" alt="large_struct" tabindex="0" loading="lazy"><figcaption>large_struct</figcaption></figure></li><li><p>大概就是这个样子 也就是bin头部通过fd/bk链接chunk size链表的头部和尾部 然后chunk size链表之间通过fd_nextsize/bk_nextsize链接</p></li><li><p>chunksize链表中 同一个大小的chunk通过fd/bk进行链接</p></li><li><p>所以largebin的fd和bk和其他的双向链不同我们不能通过从bin一路通过fd返回到large bin的头部</p></li></ul></li></ul><h3 id="unsortedbin的合并-入链-分配操作" tabindex="-1"><a class="header-anchor" href="#unsortedbin的合并-入链-分配操作" aria-hidden="true">#</a> Unsortedbin的合并/入链/分配操作</h3><h3 id="遍历的开始-梦的开始" tabindex="-1"><a class="header-anchor" href="#遍历的开始-梦的开始" aria-hidden="true">#</a> 遍历的开始（梦的开始）</h3><blockquote><p>后面的操作中最重要的就是Victim变量 这个变量是当前循环到的unsortedbin chunk<br>bck变量 也就是bck &lt;-------&gt; victim 这个关系</p></blockquote><ul><li><p>从unsorted_chunk最后一位开始遍历 直到碰到unsorted_bin的头部 我在这里 没很确定是否unsortedbin可不可以指向自己 我们可以调试看看</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>victim <span class="token operator">=</span> <span class="token function">unsorted_chunks</span> <span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token operator">-&gt;</span>bk<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token function">unsorted_chunks</span> <span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    bck <span class="token operator">=</span> victim<span class="token operator">-&gt;</span>bk<span class="token punctuation">;</span>
    size <span class="token operator">=</span> <span class="token function">chunksize</span> <span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">/* 计算 size */</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><h3 id="调试" tabindex="-1"><a class="header-anchor" href="#调试" aria-hidden="true">#</a> 调试</h3><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>unsortedbin
all: 0x555555559680 —▸ 0x7ffff7fb9be0 <span class="token punctuation">(</span>main_arena+96<span class="token punctuation">)</span> ◂— 0x555555559680
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><p>然后查看chunk结构</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>Free chunk <span class="token punctuation">(</span>unsortedbin<span class="token punctuation">)</span> <span class="token operator">|</span> PREV_INUSE
Addr: 0x555555559680
Size: 0x90 <span class="token punctuation">(</span>with flag bits: 0x91<span class="token punctuation">)</span>
fd: 0x7ffff7fb9be0
bk: 0x7ffff7fb9be0
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>查看unsortedbin的大小</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>pwndbg<span class="token operator">&gt;</span> tel  0x7ffff7fb9be0
00:0000│ rdx r10 r11 0x7ffff7fb9be0 <span class="token punctuation">(</span>main_arena+96<span class="token punctuation">)</span> —▸ 0x5555555597a0 ◂— 0x0
01:0008│             0x7ffff7fb9be8 <span class="token punctuation">(</span>main_arena+104<span class="token punctuation">)</span> ◂— 0x0
02:0010│             0x7ffff7fb9bf0 <span class="token punctuation">(</span>main_arena+112<span class="token punctuation">)</span> —▸ 0x555555559680 ◂— 0x0
03:0018│             0x7ffff7fb9bf8 <span class="token punctuation">(</span>main_arena+120<span class="token punctuation">)</span> —▸ 0x555555559680 ◂— 0x0
04:0020│             0x7ffff7fb9c00 <span class="token punctuation">(</span>main_arena+128<span class="token punctuation">)</span> —▸ 0x7ffff7fb9bf0 <span class="token punctuation">(</span>main_arena+112<span class="token punctuation">)</span> —▸ 0x555555559680 ◂— 0x0
05:0028│             0x7ffff7fb9c08 <span class="token punctuation">(</span>main_arena+136<span class="token punctuation">)</span> —▸ 0x7ffff7fb9bf0 <span class="token punctuation">(</span>main_arena+112<span class="token punctuation">)</span> —▸ 0x555555559680 ◂— 0x0
06:0030│             0x7ffff7fb9c10 <span class="token punctuation">(</span>main_arena+144<span class="token punctuation">)</span> —▸ 0x7ffff7fb9c00 <span class="token punctuation">(</span>main_arena+128<span class="token punctuation">)</span> —▸ 0x7ffff7fb9bf0 <span class="token punctuation">(</span>main_arena+112<span class="token punctuation">)</span> —▸ 0x555555559680 ◂— 0x0
07:0038│             0x7ffff7fb9c18 <span class="token punctuation">(</span>main_arena+152<span class="token punctuation">)</span> —▸ 0x7ffff7fb9c00 <span class="token punctuation">(</span>main_arena+128<span class="token punctuation">)</span> —▸ 0x7ffff7fb9bf0 <span class="token punctuation">(</span>main_arena+112<span class="token punctuation">)</span> —▸ 0x555555559680 ◂— 0x0
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>可以发现fd bk都是指向的unsortedbin中第一个chunk 我们清空unsortedbin看看</p><div class="language-shelll line-numbers-mode" data-ext="shelll"><pre class="language-shelll"><code>pwndbg&gt; tel 0x7ffff7fb9be0
00:0000│ rsi r11 0x7ffff7fb9be0 (main_arena+96) —▸ 0x555555559830 ◂— 0x0
01:0008│         0x7ffff7fb9be8 (main_arena+104) —▸ 0x555555559710 ◂— 0x90
02:0010│         0x7ffff7fb9bf0 (main_arena+112) —▸ 0x7ffff7fb9be0 (main_arena+96) —▸ 0x555555559830 ◂— 0x0
03:0018│         0x7ffff7fb9bf8 (main_arena+120) —▸ 0x7ffff7fb9be0 (main_arena+96) —▸ 0x555555559830 ◂— 0x0
04:0020│         0x7ffff7fb9c00 (main_arena+128) —▸ 0x7ffff7fb9bf0 (main_arena+112) —▸ 0x7ffff7fb9be0 (main_arena+96) —▸ 0x555555559830 ◂— 0x0
05:0028│         0x7ffff7fb9c08 (main_arena+136) —▸ 0x7ffff7fb9bf0 (main_arena+112) —▸ 0x7ffff7fb9be0 (main_arena+96) —▸ 0x555555559830 ◂— 0x0
06:0030│         0x7ffff7fb9c10 (main_arena+144) —▸ 0x7ffff7fb9c00 (main_arena+128) —▸ 0x7ffff7fb9bf0 (main_arena+112) —▸ 0x7ffff7fb9be0 (main_arena+96) —▸ 0x555555559830 ◂— ...
07:0038│         0x7ffff7fb9c18 (main_arena+152) —▸ 0x7ffff7fb9c00 (main_arena+128) —▸ 0x7ffff7fb9bf0 (main_arena+112) —▸ 0x7ffff7fb9be0 (main_arena+96) —▸ 0x55555555983
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>我们会发现fd和bk都是指向了自己本身也就是main_arena+96这个位置</li></ul></li></ul><h3 id="安全检查机制" tabindex="-1"><a class="header-anchor" href="#安全检查机制" aria-hidden="true">#</a> 安全检查机制</h3><blockquote><p>这里的安全机制全是对unsortedbin中的chunk进行的检查</p></blockquote><ul><li><p>不能小于2*SIZE_SZ不能大于av-&gt;system_men也就是该分配去的内存分配总量</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__glibc_unlikely</span> <span class="token punctuation">(</span>size <span class="token operator">&lt;=</span> <span class="token number">2</span> <span class="token operator">*</span> SIZE_SZ<span class="token punctuation">)</span>
              <span class="token operator">||</span> <span class="token function">__glibc_unlikely</span> <span class="token punctuation">(</span>size <span class="token operator">&gt;</span> av<span class="token operator">-&gt;</span>system_mem<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token function">malloc_printerr</span> <span class="token punctuation">(</span><span class="token string">&quot;malloc(): invalid size (unsorted)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><p>对next chunk(物理意义上的紧挨着)也进行一样的操作</p><blockquote><p>mchunkptr next = chunk_at_offset (victim, size); /* 获得指向内存空间中当前 chunk 的下一个chunk 的指针 */</p></blockquote><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__glibc_unlikely</span> <span class="token punctuation">(</span><span class="token function">chunksize_nomask</span> <span class="token punctuation">(</span>next<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">2</span> <span class="token operator">*</span> SIZE_SZ<span class="token punctuation">)</span><span class="token operator">||</span> <span class="token function">__glibc_unlikely</span> <span class="token punctuation">(</span><span class="token function">chunksize_nomask</span> <span class="token punctuation">(</span>next<span class="token punctuation">)</span> <span class="token operator">&gt;</span> av<span class="token operator">-&gt;</span>system_mem<span class="token punctuation">)</span><span class="token punctuation">)</span>
     <span class="token function">malloc_printerr</span> <span class="token punctuation">(</span><span class="token string">&quot;malloc(): invalid next size (unsorted)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div></li></ul></li><li><p>检查next chunk的prev_size 是否等于当前的chunk size</p><blockquote><p>size = chunksize (victim); /* 计算 size */</p></blockquote><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token comment">/* 如果 next chunk 中记录前一个 chunk 大小的 prev_size 与 size 不符，则报错 */</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__glibc_unlikely</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">prev_size</span> <span class="token punctuation">(</span>next<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token operator">~</span><span class="token punctuation">(</span>SIZE_BITS<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> size<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token function">malloc_printerr</span> <span class="token punctuation">(</span><span class="token string">&quot;malloc(): mismatching next-&gt;prev_size (unsorted)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>检查bck的fd是否为当前chunk 或者当前chunk的fd是否是bin的头结点</p><blockquote><p>bck = victim-&gt;bk;</p><p>victim = unsorted_chunks (av)-&gt;bk)</p><p>应该就是检查下一个chunk是否是合法的</p></blockquote><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__glibc_unlikely</span> <span class="token punctuation">(</span>bck<span class="token operator">-&gt;</span>fd <span class="token operator">!=</span> victim<span class="token punctuation">)</span>
              <span class="token operator">||</span> <span class="token function">__glibc_unlikely</span> <span class="token punctuation">(</span>victim<span class="token operator">-&gt;</span>fd <span class="token operator">!=</span> <span class="token function">unsorted_chunks</span> <span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token function">malloc_printerr</span> <span class="token punctuation">(</span><span class="token string">&quot;malloc(): unsorted double linked list corrupted&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>检查当前chunk是否是free的 通过next chunk的p值</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code> <span class="token comment">/* 如果 next chunk 中的显示前一个 chunk 是否正在使用的标志位为1，*/</span>
 <span class="token comment">/* 即前一个 chunk 正在使用，则报错 */</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__glibc_unlikely</span> <span class="token punctuation">(</span><span class="token function">prev_inuse</span> <span class="token punctuation">(</span>next<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
 	<span class="token function">malloc_printerr</span> <span class="token punctuation">(</span><span class="token string">&quot;malloc(): invalid next-&gt;prev_inuse (unsorted)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><h3 id="直接返回smallbin-chunk情况" tabindex="-1"><a class="header-anchor" href="#直接返回smallbin-chunk情况" aria-hidden="true">#</a> 直接返回smallbin_chunk情况</h3><blockquote><p>然后就是从unsortedbin割small chunk 如果符合条件</p><ul><li><p>所需chunk大小在smallbin的范围之内</p></li><li><p>bck为unsortedbin的头 也就是unsortedbin中仅有一个chunk</p></li><li><p>victim为last remainder chunk 也就是分割过一次</p></li><li><p>大小刚好大于所需nb大小+Minsize(这里猜测就是一个最小chunk 这样才能切割)</p></li></ul><p>满足以上条件 就直接分割 然后将victim返回给用户</p></blockquote><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">in_smallbin_range</span> <span class="token punctuation">(</span>nb<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
    bck <span class="token operator">==</span> <span class="token function">unsorted_chunks</span> <span class="token punctuation">(</span>av<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
    victim <span class="token operator">==</span> av<span class="token operator">-&gt;</span>last_remainder <span class="token operator">&amp;&amp;</span>
    <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>size<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>nb <span class="token operator">+</span> MINSIZE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    remainder_size <span class="token operator">=</span> size <span class="token operator">-</span> nb<span class="token punctuation">;</span>
    remainder <span class="token operator">=</span> <span class="token function">chunk_at_offset</span> <span class="token punctuation">(</span>victim<span class="token punctuation">,</span> nb<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">unsorted_chunks</span> <span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token operator">-&gt;</span>bk <span class="token operator">=</span> <span class="token function">unsorted_chunks</span> <span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token operator">-&gt;</span>fd <span class="token operator">=</span> remainder<span class="token punctuation">;</span>
    av<span class="token operator">-&gt;</span>last_remainder <span class="token operator">=</span> remainder<span class="token punctuation">;</span>
    remainder<span class="token operator">-&gt;</span>bk <span class="token operator">=</span> remainder<span class="token operator">-&gt;</span>fd <span class="token operator">=</span> <span class="token function">unsorted_chunks</span> <span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">in_smallbin_range</span> <span class="token punctuation">(</span>remainder_size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        remainder<span class="token operator">-&gt;</span>fd_nextsize <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        remainder<span class="token operator">-&gt;</span>bk_nextsize <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">set_head</span> <span class="token punctuation">(</span>victim<span class="token punctuation">,</span> nb <span class="token operator">|</span> PREV_INUSE <span class="token operator">|</span> <span class="token punctuation">(</span>av <span class="token operator">!=</span> <span class="token operator">&amp;</span>main_arena <span class="token operator">?</span> NON_MAIN_ARENA <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">set_head</span> <span class="token punctuation">(</span>remainder<span class="token punctuation">,</span> remainder_size <span class="token operator">|</span> PREV_INUSE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">set_foot</span> <span class="token punctuation">(</span>remainder<span class="token punctuation">,</span> remainder_size<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">check_malloced_chunk</span> <span class="token punctuation">(</span>av<span class="token punctuation">,</span> victim<span class="token punctuation">,</span> nb<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token function">chunk2mem</span> <span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">alloc_perturb</span> <span class="token punctuation">(</span>p<span class="token punctuation">,</span> bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> p<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="从unsortedbin中移除" tabindex="-1"><a class="header-anchor" href="#从unsortedbin中移除" aria-hidden="true">#</a> 从unsortedbin中移除</h3><blockquote><p>在这里已经将chunk从unsortdbin中移除</p></blockquote><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code> <span class="token function">unsorted_chunks</span> <span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token operator">-&gt;</span>bk <span class="token operator">=</span> bck<span class="token punctuation">;</span>
 bck<span class="token operator">-&gt;</span>fd <span class="token operator">=</span> <span class="token function">unsorted_chunks</span> <span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="大小刚好相等情况" tabindex="-1"><a class="header-anchor" href="#大小刚好相等情况" aria-hidden="true">#</a> 大小刚好相等情况</h3><ul><li><p>如果chunk和当前需要的chunk大小一致 则直接返回chunk 并且设置物理意义上紧挨着的下一个chunk的size中p为0也就是free状态</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token function">set_inuse_bit_at_offset</span> <span class="token punctuation">(</span>victim<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li><li><p>如果开启了tcache机制 且tcache未满则将chunk放入tcache中</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>tcache_nb <span class="token operator">&amp;&amp;</span> tcache<span class="token operator">-&gt;</span>counts<span class="token punctuation">[</span>tc_idx<span class="token punctuation">]</span> <span class="token operator">&lt;</span> mp_<span class="token punctuation">.</span>tcache_count<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">tcache_put</span> <span class="token punctuation">(</span>victim<span class="token punctuation">,</span> tc_idx<span class="token punctuation">)</span><span class="token punctuation">;</span> 
    return_cached <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">continue</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>然后直接返回</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token function">check_malloced_chunk</span> <span class="token punctuation">(</span>av<span class="token punctuation">,</span> victim<span class="token punctuation">,</span> nb<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token function">chunk2mem</span> <span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">alloc_perturb</span> <span class="token punctuation">(</span>p<span class="token punctuation">,</span> bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> p<span class="token punctuation">;</span>  <span class="token comment">/* 返回内存指针 */</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><h3 id="归类入链操作" tabindex="-1"><a class="header-anchor" href="#归类入链操作" aria-hidden="true">#</a> 归类入链操作<span id="largebin"></span></h3><blockquote><p>这里主要是将unsortedbin合并后的 入small链表或者large链表的操作</p><p>这里的fwd和bck记好了 我们从unsortedbin抠出来的chunk就要合并进入fwd和bck的中间</p><p>这后面的操作往往是先让fwd到指定的位置 然后bck通过fwd-&gt;bk来进行的定位</p></blockquote><h3 id="small-和-large最终入bin操作" tabindex="-1"><a class="header-anchor" href="#small-和-large最终入bin操作" aria-hidden="true">#</a> small 和 large最终入bin操作</h3><blockquote><p>这里把最后的部分 直接提前 拿出来 因为smallbin和largebin的入链操作都含这个代码</p><p>largebin还有chunk size的入链操作 以及其他的复杂检查</p></blockquote><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token function">mark_bin</span> <span class="token punctuation">(</span>av<span class="token punctuation">,</span> victim_index<span class="token punctuation">)</span><span class="token punctuation">;</span>
victim<span class="token operator">-&gt;</span>bk <span class="token operator">=</span> bck<span class="token punctuation">;</span>
victim<span class="token operator">-&gt;</span>fd <span class="token operator">=</span> fwd<span class="token punctuation">;</span>
fwd<span class="token operator">-&gt;</span>bk <span class="token operator">=</span> victim<span class="token punctuation">;</span>
bck<span class="token operator">-&gt;</span>fd <span class="token operator">=</span> victim<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="smallbin的fwd-bck赋值" tabindex="-1"><a class="header-anchor" href="#smallbin的fwd-bck赋值" aria-hidden="true">#</a> smallbin的fwd bck赋值</h3><ul><li><p>如果属于small bin则进行fwd和bck的赋值</p><blockquote><p>small bin 的链表表头赋值给 bck:bck = bin_at (av, victim_index);</p><p>首个chunk赋值给fwd :fwd = bck-&gt;fd;</p></blockquote><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">in_smallbin_range</span> <span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    victim_index <span class="token operator">=</span> <span class="token function">smallbin_index</span> <span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    bck <span class="token operator">=</span> <span class="token function">bin_at</span> <span class="token punctuation">(</span>av<span class="token punctuation">,</span> victim_index<span class="token punctuation">)</span><span class="token punctuation">;</span>
    fwd <span class="token operator">=</span> bck<span class="token operator">-&gt;</span>fd<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><h3 id="largebin-入bin链和chunk-size链" tabindex="-1"><a class="header-anchor" href="#largebin-入bin链和chunk-size链" aria-hidden="true">#</a> largebin 入bin链和chunk size链</h3><ul><li><p>如果属于large_bins同理进行赋值 然后判断该插入什么合适的位置</p><blockquote><p>因为largebin是按照大小进行的排序 由大到小 所以最小的在链表最后</p></blockquote><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code>victim_index <span class="token operator">=</span> <span class="token function">largebin_index</span> <span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
bck <span class="token operator">=</span> <span class="token function">bin_at</span> <span class="token punctuation">(</span>av<span class="token punctuation">,</span> victim_index<span class="token punctuation">)</span><span class="token punctuation">;</span>
fwd <span class="token operator">=</span> bck<span class="token operator">-&gt;</span>fd<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><p>判断large是否有空闲chunk:</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>fwd <span class="token operator">!=</span> bck<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li><li><p>如果当前chunk比最后一位chunk还小则直接加入链表末尾</p><blockquote><p>bck是头 bck-&gt;bk应该就是最后一位</p><p>然后要加入fwd和bck之间 我们应该先调整fwd和bck 所以bck改为链表最后一位 fwd改为链表头</p><p>bck&lt;-----&gt;chunk&lt;-----&gt;fwd</p></blockquote><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token operator">&lt;</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token function">chunksize_nomask</span> <span class="token punctuation">(</span>bck<span class="token operator">-&gt;</span>bk<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    fwd <span class="token operator">=</span> bck<span class="token punctuation">;</span>
    bck <span class="token operator">=</span> bck<span class="token operator">-&gt;</span>bk<span class="token punctuation">;</span>
    victim<span class="token operator">-&gt;</span>fd_nextsize <span class="token operator">=</span> fwd<span class="token operator">-&gt;</span>fd<span class="token punctuation">;</span>
    victim<span class="token operator">-&gt;</span>bk_nextsize <span class="token operator">=</span> fwd<span class="token operator">-&gt;</span>fd<span class="token operator">-&gt;</span>bk_nextsize<span class="token punctuation">;</span>
    fwd<span class="token operator">-&gt;</span>fd<span class="token operator">-&gt;</span>bk_nextsize <span class="token operator">=</span> victim<span class="token operator">-&gt;</span>bk_nextsize<span class="token operator">-&gt;</span>fd_nextsize <span class="token operator">=</span> victim<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>否则进行遍历判断 匹配第一个小于等于 当前chunk的</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> size <span class="token operator">&lt;</span> <span class="token function">chunksize_nomask</span> <span class="token punctuation">(</span>fwd<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    fwd <span class="token operator">=</span> fwd<span class="token operator">-&gt;</span>fd_nextsize<span class="token punctuation">;</span>
    <span class="token function">assert</span> <span class="token punctuation">(</span><span class="token function">chunk_main_arena</span> <span class="token punctuation">(</span>fwd<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>如果该chunk与当前chunk相同则让chunk插入fwd之后 所以</p><blockquote><p>因为large bin是按照大小进行的排序 所以我们为了不额外修改chunk size链表 直接将chunk链接到fwd后面</p></blockquote><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> size<span class="token operator">==</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token function">chunksize_nomask</span> <span class="token punctuation">(</span>fwd<span class="token punctuation">)</span><span class="token punctuation">)</span>
    fwd <span class="token operator">=</span> fwd<span class="token operator">-&gt;</span>fd<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p><strong>当我们需求的chunk size大于large中所有的chunk size的情况</strong> 执行largebin的入chunk_size链操作:<span id="attack"></span></p><blockquote><p>这里我理解的是largebin存在两条链 也就是chunk size的链 和fd bk构成的bins链 这里先是入的chunk size的链</p></blockquote><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code>victim<span class="token operator">-&gt;</span>fd_nextsize <span class="token operator">=</span> fwd<span class="token punctuation">;</span>
victim<span class="token operator">-&gt;</span>bk_nextsize <span class="token operator">=</span> fwd<span class="token operator">-&gt;</span>bk_nextsize<span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__glibc_unlikely</span> <span class="token punctuation">(</span>fwd<span class="token operator">-&gt;</span>bk_nextsize<span class="token operator">-&gt;</span>fd_nextsize <span class="token operator">!=</span> fwd<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token function">malloc_printerr</span> <span class="token punctuation">(</span><span class="token string">&quot;malloc(): largebin double linked list corrupted (nextsize)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
fwd<span class="token operator">-&gt;</span>bk_nextsize <span class="token operator">=</span> victim<span class="token punctuation">;</span>
victim<span class="token operator">-&gt;</span>bk_nextsize<span class="token operator">-&gt;</span>fd_nextsize <span class="token operator">=</span> victim<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><p>这里就是重点了 也就是large bin的入链操作</p></li><li><p>首先这是初始状态</p></li></ul></li></ul><p><img src="https://awaqwqa.github.io/img/large_bin_attack/start.png" alt="status01" loading="lazy"> <img src="https://awaqwqa.github.io/img/large_bin_attack/status02.png" alt="status1" loading="lazy"><img src="https://awaqwqa.github.io/img/large_bin_attack/status03.png" alt="status1" loading="lazy"><img src="https://awaqwqa.github.io/img/large_bin_attack/status04.png" alt="status1" loading="lazy"></p><ul><li><p>让bck等于fwd-&gt;bk 也就是把bck提到fwd前方 并且进行安全检查</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code>bck <span class="token operator">=</span> fwd<span class="token operator">-&gt;</span>bk<span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>bck<span class="token operator">-&gt;</span>fd <span class="token operator">!=</span> fwd<span class="token punctuation">)</span>
    <span class="token function">malloc_printerr</span> <span class="token punctuation">(</span><span class="token string">&quot;malloc(): largebin double linked list corrupted (bk)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>最后就是执行入链操作了</p><blockquote><p>在一开始的时候提过</p></blockquote><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token function">mark_bin</span> <span class="token punctuation">(</span>av<span class="token punctuation">,</span> victim_index<span class="token punctuation">)</span><span class="token punctuation">;</span>
victim<span class="token operator">-&gt;</span>bk <span class="token operator">=</span> bck<span class="token punctuation">;</span>
victim<span class="token operator">-&gt;</span>fd <span class="token operator">=</span> fwd<span class="token punctuation">;</span>
fwd<span class="token operator">-&gt;</span>bk <span class="token operator">=</span> victim<span class="token punctuation">;</span>
bck<span class="token operator">-&gt;</span>fd <span class="token operator">=</span> victim<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul></li></ul><h3 id="从largebin中获取chunk" tabindex="-1"><a class="header-anchor" href="#从largebin中获取chunk" aria-hidden="true">#</a> 从largebin中获取chunk</h3><ul><li><p>largebin情况</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">in_smallbin_range</span> <span class="token punctuation">(</span>nb<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li></ul><h3 id="chunk脱链-remainder-chunk入链" tabindex="-1"><a class="header-anchor" href="#chunk脱链-remainder-chunk入链" aria-hidden="true">#</a> chunk脱链 remainder chunk入链</h3><blockquote><p>首先是判断情况 我们只处理这一种情况:largebin中有chunk 然后largebin中最大的chunk大于我们的需求</p><p>接下来的代码都是从largebin中获取chunk</p></blockquote><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>victim <span class="token operator">=</span> <span class="token function">first</span> <span class="token punctuation">(</span>bin<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> bin <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token function">chunksize_nomask</span> <span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token operator">&gt;=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>nb<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ul><li><p>取最小的chunk 反方向循环 找到刚好大于等于我们所需chunk size的 chunk</p><blockquote><p>如果一个大小的chunk链表中有多个chunk 优先取第二个 不轻易改变chunk size链表的值</p></blockquote><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token comment">// 取largebin的最后一个chunk 也就是最小的那个chunk </span>
victim <span class="token operator">=</span> victim<span class="token operator">-&gt;</span>bk_nextsize<span class="token punctuation">;</span>
<span class="token comment">// 取首个大于所需的chunk size的large chunk</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>size <span class="token operator">=</span> <span class="token function">chunksize</span> <span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>nb<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    victim <span class="token operator">=</span> victim<span class="token operator">-&gt;</span>bk_nextsize<span class="token punctuation">;</span>

<span class="token comment">/* Avoid removing the first entry for a size so that the skip
                 list does not have to be rerouted.  */</span>
<span class="token comment">//  这里避免删除chunk size链中的首个chunk 避免我们修改chunk size链表 所以我们取第二个</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>victim <span class="token operator">!=</span> <span class="token function">last</span> <span class="token punctuation">(</span>bin<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">chunksize_nomask</span> <span class="token punctuation">(</span>victim<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token function">chunksize_nomask</span> <span class="token punctuation">(</span>victim<span class="token operator">-&gt;</span>fd<span class="token punctuation">)</span><span class="token punctuation">)</span>
    victim <span class="token operator">=</span> victim<span class="token operator">-&gt;</span>fd<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>chunk 通过unlink脱链 remainder chunk入unsortedbin链</p><blockquote><p>安全检查 是否切割后的chunk大于minsize 与安全检查 largebin第一个chunk和头的互锁状态</p></blockquote><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code> <span class="token comment">// 算剩余的remainder_size</span>
 remainder_size <span class="token operator">=</span> size <span class="token operator">-</span> nb<span class="token punctuation">;</span>
 <span class="token comment">// 对 我们large bin中的chunk 进行unlink操作</span>
 <span class="token function">unlink_chunk</span> <span class="token punctuation">(</span>av<span class="token punctuation">,</span> victim<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/* Exhaust */</span>
<span class="token comment">// 安全检查 如果切割的chunk 小于Minsize 则 设置下一个chunk p为0</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>remainder_size <span class="token operator">&lt;</span> MINSIZE<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token function">set_inuse_bit_at_offset</span> <span class="token punctuation">(</span>victim<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>av <span class="token operator">!=</span> <span class="token operator">&amp;</span>main_arena<span class="token punctuation">)</span>
		<span class="token function">set_non_main_arena</span> <span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
     remainder <span class="token operator">=</span> <span class="token function">chunk_at_offset</span> <span class="token punctuation">(</span>victim<span class="token punctuation">,</span> nb<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/* We cannot assume the unsorted list is empty and therefore
                     have to perform a complete insert here.  */</span>
    <span class="token comment">// 根据注释大概知道是进行完整的插入操作</span>
    <span class="token comment">// 取得unsorted_chunk bin链表的的头</span>
    bck <span class="token operator">=</span> <span class="token function">unsorted_chunks</span><span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 取 第一个chunk</span>
    fwd <span class="token operator">=</span> bck<span class="token operator">-&gt;</span>fd<span class="token punctuation">;</span>
    <span class="token comment">// 安全检查:检查第一个chunk的bk是否为unsorted bin的头</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__glibc_unlikely</span> <span class="token punctuation">(</span>fwd<span class="token operator">-&gt;</span>bk <span class="token operator">!=</span> bck<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">malloc_printerr</span> <span class="token punctuation">(</span><span class="token string">&quot;malloc(): corrupted unsorted chunks&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// remainder 入unsortedbin</span>
    remainder<span class="token operator">-&gt;</span>bk <span class="token operator">=</span> bck<span class="token punctuation">;</span>
    remainder<span class="token operator">-&gt;</span>fd <span class="token operator">=</span> fwd<span class="token punctuation">;</span>
    bck<span class="token operator">-&gt;</span>fd <span class="token operator">=</span> remainder<span class="token punctuation">;</span>
    fwd<span class="token operator">-&gt;</span>bk <span class="token operator">=</span> remainder<span class="token punctuation">;</span>
    <span class="token comment">// 如果是remiander 则将fd_nextsize bk_nextsize 设置为null</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">in_smallbin_range</span> <span class="token punctuation">(</span>remainder_size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        remainder<span class="token operator">-&gt;</span>fd_nextsize <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        remainder<span class="token operator">-&gt;</span>bk_nextsize <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 这里应该是设置head的一系列操作</span>
    <span class="token function">set_head</span> <span class="token punctuation">(</span>victim<span class="token punctuation">,</span> nb <span class="token operator">|</span> PREV_INUSE <span class="token operator">|</span>
              <span class="token punctuation">(</span>av <span class="token operator">!=</span> <span class="token operator">&amp;</span>main_arena <span class="token operator">?</span> NON_MAIN_ARENA <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">set_head</span> <span class="token punctuation">(</span>remainder<span class="token punctuation">,</span> remainder_size <span class="token operator">|</span> PREV_INUSE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// foot就是下一个chunk的prev_size部分 </span>
    <span class="token function">set_foot</span> <span class="token punctuation">(</span>remainder<span class="token punctuation">,</span> remainder_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><h3 id="返回被切割后的chunk" tabindex="-1"><a class="header-anchor" href="#返回被切割后的chunk" aria-hidden="true">#</a> 返回被切割后的chunk</h3><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token function">check_malloced_chunk</span> <span class="token punctuation">(</span>av<span class="token punctuation">,</span> victim<span class="token punctuation">,</span> nb<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token function">chunk2mem</span> <span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">alloc_perturb</span> <span class="token punctuation">(</span>p<span class="token punctuation">,</span> bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> p<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="从topchunk中获取chunk" tabindex="-1"><a class="header-anchor" href="#从topchunk中获取chunk" aria-hidden="true">#</a> 从topchunk中获取chunk</h3><blockquote><p>我是大概浏览的 大概意思是去剩下的chunk中寻找 如果没找到就去topchunk分配 如果topchunk不够就去系统申请</p></blockquote><h3 id="int-free-源码" tabindex="-1"><a class="header-anchor" href="#int-free-源码" aria-hidden="true">#</a> _int_free_源码</h3><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code>
<span class="token keyword">static</span> <span class="token keyword">void</span>
<span class="token function">_int_free</span> <span class="token punctuation">(</span>mstate av<span class="token punctuation">,</span> mchunkptr p<span class="token punctuation">,</span> <span class="token keyword">int</span> have_lock<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  INTERNAL_SIZE_T size<span class="token punctuation">;</span>        <span class="token comment">/* its size */</span>
  mfastbinptr <span class="token operator">*</span>fb<span class="token punctuation">;</span>             <span class="token comment">/* associated fastbin */</span>
  mchunkptr nextchunk<span class="token punctuation">;</span>         <span class="token comment">/* next contiguous chunk */</span>
  INTERNAL_SIZE_T nextsize<span class="token punctuation">;</span>    <span class="token comment">/* its size */</span>
  <span class="token keyword">int</span> nextinuse<span class="token punctuation">;</span>               <span class="token comment">/* true if nextchunk is used */</span>
  INTERNAL_SIZE_T prevsize<span class="token punctuation">;</span>    <span class="token comment">/* size of previous contiguous chunk */</span>
  mchunkptr bck<span class="token punctuation">;</span>               <span class="token comment">/* misc temp for linking */</span>
  mchunkptr fwd<span class="token punctuation">;</span>               <span class="token comment">/* misc temp for linking */</span>
  <span class="token comment">// 获取size大小 </span>
  size <span class="token operator">=</span> <span class="token function">chunksize</span> <span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* Little security check which won&#39;t hurt performance: the
     allocator never wrapps around at the end of the address space.
     Therefore we can exclude some size values which might appear
     here by accident or by &quot;design&quot; from some intruder.  */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uintptr_t</span><span class="token punctuation">)</span> p <span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token class-name">uintptr_t</span><span class="token punctuation">)</span> <span class="token operator">-</span>size<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
      <span class="token operator">||</span> <span class="token function">__builtin_expect</span> <span class="token punctuation">(</span><span class="token function">misaligned_chunk</span> <span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token function">malloc_printerr</span> <span class="token punctuation">(</span><span class="token string">&quot;free(): invalid pointer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">/* We know that each chunk is at least MINSIZE bytes in size or a
     multiple of MALLOC_ALIGNMENT.  */</span>
    <span class="token comment">//  要大于MINSIZE 以及内存对齐?</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__glibc_unlikely</span> <span class="token punctuation">(</span>size <span class="token operator">&lt;</span> MINSIZE <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">aligned_OK</span> <span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token function">malloc_printerr</span> <span class="token punctuation">(</span><span class="token string">&quot;free(): invalid size&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">check_inuse_chunk</span><span class="token punctuation">(</span>av<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">USE_TCACHE</span></span>
  <span class="token punctuation">{</span>
    <span class="token class-name">size_t</span> tc_idx <span class="token operator">=</span> <span class="token function">csize2tidx</span> <span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>tcache
	<span class="token operator">&amp;&amp;</span> tc_idx <span class="token operator">&lt;</span> mp_<span class="token punctuation">.</span>tcache_bins
	<span class="token operator">&amp;&amp;</span> tcache<span class="token operator">-&gt;</span>counts<span class="token punctuation">[</span>tc_idx<span class="token punctuation">]</span> <span class="token operator">&lt;</span> mp_<span class="token punctuation">.</span>tcache_count<span class="token punctuation">)</span>
      <span class="token punctuation">{</span>
	<span class="token function">tcache_put</span> <span class="token punctuation">(</span>p<span class="token punctuation">,</span> tc_idx<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

  <span class="token comment">/*
    If eligible, place chunk on a fastbin so it can be found
    and used quickly in malloc.
  */</span>
    <span class="token comment">//  如果是fastbin区间的</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">get_max_fast</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">TRIM_FASTBINS</span></span>
      <span class="token comment">/*
	If TRIM_FASTBINS set, don&#39;t place chunks
	bordering top into fastbins
      */</span>
      <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token function">chunk_at_offset</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> size<span class="token punctuation">)</span> <span class="token operator">!=</span> av<span class="token operator">-&gt;</span>top<span class="token punctuation">)</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
      <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// chunk的size值 得大于chunk最小值 得小于该区域分配的最大size</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span> <span class="token punctuation">(</span><span class="token function">chunksize_nomask</span> <span class="token punctuation">(</span><span class="token function">chunk_at_offset</span> <span class="token punctuation">(</span>p<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&lt;=</span> <span class="token number">2</span> <span class="token operator">*</span> SIZE_SZ<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">||</span> <span class="token function">__builtin_expect</span> <span class="token punctuation">(</span><span class="token function">chunksize</span> <span class="token punctuation">(</span><span class="token function">chunk_at_offset</span> <span class="token punctuation">(</span>p<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&gt;=</span> av<span class="token operator">-&gt;</span>system_mem<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	    bool fail <span class="token operator">=</span> true<span class="token punctuation">;</span>
	<span class="token comment">/* We might not have a lock at this point and concurrent modifications
	   of system_mem might result in a false positive.  Redo the test after
	   getting the lock.  */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>have_lock<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token function">__libc_lock_lock</span> <span class="token punctuation">(</span>av<span class="token operator">-&gt;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            fail <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">chunksize_nomask</span> <span class="token punctuation">(</span><span class="token function">chunk_at_offset</span> <span class="token punctuation">(</span>p<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">2</span> <span class="token operator">*</span> SIZE_SZ
                <span class="token operator">||</span> <span class="token function">chunksize</span> <span class="token punctuation">(</span><span class="token function">chunk_at_offset</span> <span class="token punctuation">(</span>p<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> av<span class="token operator">-&gt;</span>system_mem<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">__libc_lock_unlock</span> <span class="token punctuation">(</span>av<span class="token operator">-&gt;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>fail<span class="token punctuation">)</span>
            <span class="token function">malloc_printerr</span> <span class="token punctuation">(</span><span class="token string">&quot;free(): invalid next size (fast)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token comment">// 清空chunk中除了prev_size 和size的地方</span>
    <span class="token function">free_perturb</span> <span class="token punctuation">(</span><span class="token function">chunk2mem</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">,</span> size <span class="token operator">-</span> <span class="token number">2</span> <span class="token operator">*</span> SIZE_SZ<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">atomic_store_relaxed</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>av<span class="token operator">-&gt;</span>have_fastchunks<span class="token punctuation">,</span> true<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 获取对应fastbin链</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> idx <span class="token operator">=</span> <span class="token function">fastbin_index</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    fb <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token function">fastbin</span> <span class="token punctuation">(</span>av<span class="token punctuation">,</span> idx<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* Atomically link P to its fastbin: P-&gt;FD = *FB; *FB = P;  */</span>
    <span class="token comment">// 将块 P 插入到 fastbin 中。首先，它将当前 fastbin 的头部指针的值赋给块 P 的 FD 字段</span>
    mchunkptr old <span class="token operator">=</span> <span class="token operator">*</span>fb<span class="token punctuation">,</span> old2<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>SINGLE_THREAD_P<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token comment">/* Check that the top of the bin is not the record we are going to
	   add (i.e., double free).  */</span>
       <span class="token comment">// 检查fastbin的头部chunk是否为当前free的chunk</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span> <span class="token punctuation">(</span>old <span class="token operator">==</span> p<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token function">malloc_printerr</span> <span class="token punctuation">(</span><span class="token string">&quot;double free or corruption (fasttop)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// p-&gt;old</span>
        p<span class="token operator">-&gt;</span>fd <span class="token operator">=</span> old<span class="token punctuation">;</span>
        <span class="token operator">*</span>fb <span class="token operator">=</span> p<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span>
        <span class="token keyword">do</span><span class="token punctuation">{</span>
        <span class="token comment">/* Check that the top of the bin is not the record we are going to
            add (i.e., double free).  */</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span> <span class="token punctuation">(</span>old <span class="token operator">==</span> p<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token function">malloc_printerr</span> <span class="token punctuation">(</span><span class="token string">&quot;double free or corruption (fasttop)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            p<span class="token operator">-&gt;</span>fd <span class="token operator">=</span> old2 <span class="token operator">=</span> old<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>old <span class="token operator">=</span> <span class="token function">catomic_compare_and_exchange_val_rel</span> <span class="token punctuation">(</span>fb<span class="token punctuation">,</span> p<span class="token punctuation">,</span> old2<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token operator">!=</span> old2<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/* Check that size of fastbin chunk at the top is the same as
        size of the chunk that we are adding.  We can dereference OLD
        only if we have the lock, otherwise it might have already been
        allocated again.  */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>have_lock <span class="token operator">&amp;&amp;</span> old <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token operator">&amp;&amp;</span> <span class="token function">__builtin_expect</span> <span class="token punctuation">(</span><span class="token function">fastbin_index</span> <span class="token punctuation">(</span><span class="token function">chunksize</span> <span class="token punctuation">(</span>old<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> idx<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token function">malloc_printerr</span> <span class="token punctuation">(</span><span class="token string">&quot;invalid fastbin entry (free)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/*
    Consolidate other non-mmapped chunks as they arrive.
  */</span>
    <span class="token comment">// 如果释放的chunk不属于fastbin 且不是mmap分配的 就获取下一个chunk的指针 nextchunk和nextsize</span>
    <span class="token comment">// 如果前一个chunk空闲 就合并 通过unlink将该chunk脱离出来</span>
    <span class="token comment">// 如果取出来的chunk下一个chunk也是free chunk 且不为top chunk 则也设置为空闲 </span>
    <span class="token comment">// 去除unsortedbin头指针 将合并后的chunk 塞入unsortedbin中</span>
    <span class="token comment">// 如果为top chunk则直接合并</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">chunk_is_mmapped</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">/* If we&#39;re single-threaded, don&#39;t lock the arena.  */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>SINGLE_THREAD_P<span class="token punctuation">)</span>
      have_lock <span class="token operator">=</span> true<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>have_lock<span class="token punctuation">)</span>
      <span class="token function">__libc_lock_lock</span> <span class="token punctuation">(</span>av<span class="token operator">-&gt;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>

    nextchunk <span class="token operator">=</span> <span class="token function">chunk_at_offset</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* Lightweight tests: check whether the block is already the
       top block.  */</span>
    <span class="token comment">//    检查是否等于头一个chunk</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__glibc_unlikely</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> av<span class="token operator">-&gt;</span>top<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token function">malloc_printerr</span> <span class="token punctuation">(</span><span class="token string">&quot;double free or corruption (top)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/* Or whether the next chunk is beyond the boundaries of the arena.  */</span>
    <span class="token comment">// 查看下一个chunk是否大于整个内存空间的边界</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span> <span class="token punctuation">(</span><span class="token function">contiguous</span> <span class="token punctuation">(</span>av<span class="token punctuation">)</span>
			  <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> nextchunk
			  <span class="token operator">&gt;=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> av<span class="token operator">-&gt;</span>top <span class="token operator">+</span> <span class="token function">chunksize</span><span class="token punctuation">(</span>av<span class="token operator">-&gt;</span>top<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	    <span class="token function">malloc_printerr</span> <span class="token punctuation">(</span><span class="token string">&quot;double free or corruption (out)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/* Or whether the block is actually not marked used.  */</span>
    <span class="token comment">// 如果通过nextchunk查看下一个chunk是free状态 也就是当前我们要free的chunk 是free状态 则报错double free</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__glibc_unlikely</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">prev_inuse</span><span class="token punctuation">(</span>nextchunk<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token function">malloc_printerr</span> <span class="token punctuation">(</span><span class="token string">&quot;double free or corruption (!prev)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 获取物理上下一个chunk的大小</span>
    nextsize <span class="token operator">=</span> <span class="token function">chunksize</span><span class="token punctuation">(</span>nextchunk<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 进行2*size+sz&lt;size&lt;system_mem的传统检查</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span> <span class="token punctuation">(</span><span class="token function">chunksize_nomask</span> <span class="token punctuation">(</span>nextchunk<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">2</span> <span class="token operator">*</span> SIZE_SZ<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token operator">||</span> <span class="token function">__builtin_expect</span> <span class="token punctuation">(</span>nextsize <span class="token operator">&gt;=</span> av<span class="token operator">-&gt;</span>system_mem<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token function">malloc_printerr</span> <span class="token punctuation">(</span><span class="token string">&quot;free(): invalid next size (normal)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 清空要free的chunk </span>
    <span class="token function">free_perturb</span> <span class="token punctuation">(</span><span class="token function">chunk2mem</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">,</span> size <span class="token operator">-</span> <span class="token number">2</span> <span class="token operator">*</span> SIZE_SZ<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 如果当前chunk的p为0也就是下一个chunk为freechunk则进行合并</span>
    <span class="token comment">/* consolidate backward */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">prev_inuse</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 获取prev_size作为上一个chunk的size大小</span>
      prevsize <span class="token operator">=</span> <span class="token function">prev_size</span> <span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// size+prevsize也就是新的chunk的大小</span>
      size <span class="token operator">+=</span> prevsize<span class="token punctuation">;</span>
      <span class="token comment">// 获取上一个chunk的头指针</span>
      p <span class="token operator">=</span> <span class="token function">chunk_at_offset</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span> prevsize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 进行unlink操作</span>
      <span class="token function">unlink</span><span class="token punctuation">(</span>av<span class="token punctuation">,</span> p<span class="token punctuation">,</span> bck<span class="token punctuation">,</span> fwd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 如果下一个chunk不为top chunk </span>
    <span class="token comment">// 下一个chunk也是free chunk 则继续进行合并</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>nextchunk <span class="token operator">!=</span> av<span class="token operator">-&gt;</span>top<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">/* get and clear inuse bit */</span>
      <span class="token comment">// 应该是根据指针 和size 算出下一个chunk的size p位置</span>
      nextinuse <span class="token operator">=</span> <span class="token function">inuse_bit_at_offset</span><span class="token punctuation">(</span>nextchunk<span class="token punctuation">,</span> nextsize<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">/* consolidate forward */</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>nextinuse<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">unlink</span><span class="token punctuation">(</span>av<span class="token punctuation">,</span> nextchunk<span class="token punctuation">,</span> bck<span class="token punctuation">,</span> fwd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        size <span class="token operator">+=</span> nextsize<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span>
      <span class="token comment">// 设置nextchunk size p 的部分清空</span>
      <span class="token function">clear_inuse_bit_at_offset</span><span class="token punctuation">(</span>nextchunk<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">/*
	Place the chunk in unsorted chunk list. Chunks are
	not placed into regular bins until after they have
	been given one chance to be used in malloc.
      */</span>

      bck <span class="token operator">=</span> <span class="token function">unsorted_chunks</span><span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">;</span>
      fwd <span class="token operator">=</span> bck<span class="token operator">-&gt;</span>fd<span class="token punctuation">;</span>
    <span class="token comment">//   检查unsortedbin是否合法</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__glibc_unlikely</span> <span class="token punctuation">(</span>fwd<span class="token operator">-&gt;</span>bk <span class="token operator">!=</span> bck<span class="token punctuation">)</span><span class="token punctuation">)</span>
	        <span class="token function">malloc_printerr</span> <span class="token punctuation">(</span><span class="token string">&quot;free(): corrupted unsorted chunks&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// p入unsortedbin链</span>
      p<span class="token operator">-&gt;</span>fd <span class="token operator">=</span> fwd<span class="token punctuation">;</span>
      p<span class="token operator">-&gt;</span>bk <span class="token operator">=</span> bck<span class="token punctuation">;</span>
    <span class="token comment">//   属于largebin大小则设置fd_nextsize bk_nextsize为null</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">in_smallbin_range</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        p<span class="token operator">-&gt;</span>fd_nextsize <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        p<span class="token operator">-&gt;</span>bk_nextsize <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	  <span class="token punctuation">}</span>
    <span class="token comment">// 正式入链</span>
      bck<span class="token operator">-&gt;</span>fd <span class="token operator">=</span> p<span class="token punctuation">;</span>
      fwd<span class="token operator">-&gt;</span>bk <span class="token operator">=</span> p<span class="token punctuation">;</span>
    <span class="token comment">//正常设置size 和foot</span>
      <span class="token function">set_head</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> size <span class="token operator">|</span> PREV_INUSE<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">set_foot</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token function">check_free_chunk</span><span class="token punctuation">(</span>av<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/*
      If the chunk borders the current high end of memory,
      consolidate into top
    */</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
      size <span class="token operator">+=</span> nextsize<span class="token punctuation">;</span>
      <span class="token function">set_head</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> size <span class="token operator">|</span> PREV_INUSE<span class="token punctuation">)</span><span class="token punctuation">;</span>
      av<span class="token operator">-&gt;</span>top <span class="token operator">=</span> p<span class="token punctuation">;</span>
      <span class="token function">check_chunk</span><span class="token punctuation">(</span>av<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/*
      If freeing a large space, consolidate possibly-surrounding
      chunks. Then, if the total unused topmost memory exceeds trim
      threshold, ask malloc_trim to reduce top.

      Unless max_fast is 0, we don&#39;t know if there are fastbins
      bordering top, so we cannot tell for sure whether threshold
      has been reached unless fastbins are consolidated.  But we
      don&#39;t want to consolidate on each free.  As a compromise,
      consolidation is performed if FASTBIN_CONSOLIDATION_THRESHOLD
      is reached.
    */</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> FASTBIN_CONSOLIDATION_THRESHOLD<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">atomic_load_relaxed</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>av<span class="token operator">-&gt;</span>have_fastchunks<span class="token punctuation">)</span><span class="token punctuation">)</span>
	    <span class="token function">malloc_consolidate</span><span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>av <span class="token operator">==</span> <span class="token operator">&amp;</span>main_arena<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">MORECORE_CANNOT_TRIM</span></span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">chunksize</span><span class="token punctuation">(</span>av<span class="token operator">-&gt;</span>top<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span>
	    <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span>mp_<span class="token punctuation">.</span>trim_threshold<span class="token punctuation">)</span><span class="token punctuation">)</span>
	  <span class="token function">systrim</span><span class="token punctuation">(</span>mp_<span class="token punctuation">.</span>top_pad<span class="token punctuation">,</span> av<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
	<span class="token comment">/* Always try heap_trim(), even if the top chunk is not
	   large, because the corresponding heap might go away.  */</span>
	heap_info <span class="token operator">*</span>heap <span class="token operator">=</span> <span class="token function">heap_for_ptr</span><span class="token punctuation">(</span><span class="token function">top</span><span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">assert</span><span class="token punctuation">(</span>heap<span class="token operator">-&gt;</span>ar_ptr <span class="token operator">==</span> av<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">heap_trim</span><span class="token punctuation">(</span>heap<span class="token punctuation">,</span> mp_<span class="token punctuation">.</span>top_pad<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>have_lock<span class="token punctuation">)</span>
      <span class="token function">__libc_lock_unlock</span> <span class="token punctuation">(</span>av<span class="token operator">-&gt;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">/*
    If the chunk was allocated via mmap, release via munmap().
  */</span>

  <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">munmap_chunk</span> <span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="漏洞利用" tabindex="-1"><a class="header-anchor" href="#漏洞利用" aria-hidden="true">#</a> 漏洞利用</h2><blockquote><p>我们主要是利用:<a href="#attack">largechunk中最大的chunk还是小于我们所需求的chunk大小</a>这种情况 我们来详细分析一下这个流程中究竟干了什么</p></blockquote><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code>victim<span class="token operator">-&gt;</span>fd_nextsize <span class="token operator">=</span> fwd<span class="token punctuation">;</span>
victim<span class="token operator">-&gt;</span>bk_nextsize <span class="token operator">=</span> fwd<span class="token operator">-&gt;</span>bk_nextsize<span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__glibc_unlikely</span> <span class="token punctuation">(</span>fwd<span class="token operator">-&gt;</span>bk_nextsize<span class="token operator">-&gt;</span>fd_nextsize <span class="token operator">!=</span> fwd<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token function">malloc_printerr</span> <span class="token punctuation">(</span><span class="token string">&quot;malloc(): largebin double linked list corrupted (nextsize)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
fwd<span class="token operator">-&gt;</span>bk_nextsize <span class="token operator">=</span> victim<span class="token punctuation">;</span>
victim<span class="token operator">-&gt;</span>bk_nextsize<span class="token operator">-&gt;</span>fd_nextsize <span class="token operator">=</span> victim<span class="token punctuation">;</span>
<span class="token comment">// 以及</span>
victim<span class="token operator">-&gt;</span>bk <span class="token operator">=</span> bck<span class="token punctuation">;</span>
victim<span class="token operator">-&gt;</span>fd <span class="token operator">=</span> fwd<span class="token punctuation">;</span>
fwd<span class="token operator">-&gt;</span>bk <span class="token operator">=</span> victim<span class="token punctuation">;</span>
bck<span class="token operator">-&gt;</span>fd <span class="token operator">=</span> victim<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><p>我们可以发现 这里的代码 危险的地方在于 如果现在我们能够修改largebin中fwd位置的chunk 我们就能够泄露victim的地址</p><blockquote><p>我们主要利用这两行代码</p></blockquote><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;
bck-&gt;fd = victim;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>如何实现？比如</p><ul><li>我们修改largebin中的chunk 也就是fwd的bk为我们想要泄露到的<code>目标地址-0x10</code>时 <ul><li>所以fwd-&gt;bk-&gt;fd也就是<code>目标地址</code></li><li>阅读前后逻辑我们知道这段代码中bck=fwd-&gt;bk</li><li>bck-&gt;fd 最后被赋值victim</li><li>所以也就是fwd-&gt;bk-&gt;fd被赋值victim 也就是目标地址赋值victim</li></ul></li><li>我们修改fwd的bk_nextsize为<code>目标地址-0x20</code><ul><li>所以fwd-&gt;bk_nextsize-&gt;fd_nextsize等于目标地址</li><li>然后也因为victim-&gt;bk_nextsize = fwd-&gt;bk_nextsize; 和victim-&gt;bk_nextsize-&gt;fd_nextsize = victim所以等价替换</li><li>fwd-&gt;bk_nextsize-&gt;fd_nextsize=victim也就是目标地址等于victim</li></ul></li></ul></li></ul>`,46);function x(w,z){const a=p("ExternalLinkIcon");return o(),c("div",null,[u,n("blockquote",null,[n("p",null,[s("参考文章:"),k,s("wiki:"),n("a",r,[s("Large Bin Attack - CTF Wiki (ctf-wiki.org)"),t(a)]),d,s("源码级调试glibc:"),n("a",v,[s("源码级调试glibc_glibc cannot be compiled without optimization-CSDN博客"),t(a)]),m,s("源码分析:"),n("a",b,[s("glibc 2.31 malloc与free 源码分析（持续更新） - PwnKi - 博客园 (cnblogs.com)"),t(a)]),s("+"),n("a",f,[s("glibc malloc源码分析 - PwnKi - 博客园 (cnblogs.com)"),t(a)]),h,s("详细拆分了_int_malloc的流程 并且按照功能分了标题 想要了解对应部分就直接点击标题跳转即可"),_,s("第一次阅读glibc的源码然后进行分析 有错误的地方请大佬指正")])]),g])}const I=e(l,[["render",x],["__file","largeBinAttack.html.vue"]]);export{I as default};
