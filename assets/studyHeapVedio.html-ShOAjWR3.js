import{_ as n}from"./plugin-vue_export-helper-x3n3nnut.js";import{o as s,c as a,e as t}from"./app-td6Y8yha.js";const e={},o=t(`<h1 id="ntustisc-pwn-2学习笔记" tabindex="-1"><a class="header-anchor" href="#ntustisc-pwn-2学习笔记" aria-hidden="true">#</a> NTUSTISC - Pwn 2学习笔记</h1><blockquote><p>查看glibc的源码网址:https://elixir.bootlin.com/glibc/glibc-2.23/source/malloc/malloc.c</p></blockquote><h2 id="tsl-了解" tabindex="-1"><a class="header-anchor" href="#tsl-了解" aria-hidden="true">#</a> TSL 了解</h2><h3 id="gdb-如何查-fs" tabindex="-1"><a class="header-anchor" href="#gdb-如何查-fs" aria-hidden="true">#</a> gdb 如何查 fs？</h3><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token keyword">print</span> <span class="token punctuation">(</span>void<span class="token punctuation">)</span>arch_prctl<span class="token punctuation">(</span>option_num<span class="token punctuation">,</span>addr<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ul><li><p>option_num 是决定是我们的操作 比如0x1003就是取fs的值</p></li><li><p>addr就是取fs放在什么地方</p></li><li><p>pwngdb的话直接输入<code>tls</code>也可以查到</p></li></ul><h2 id="bin" tabindex="-1"><a class="header-anchor" href="#bin" aria-hidden="true">#</a> bin</h2><h3 id="free-源码分析" tabindex="-1"><a class="header-anchor" href="#free-源码分析" aria-hidden="true">#</a> free 源码分析</h3><ul><li>运行<code>_int_free</code>函数</li><li>如果<code>size</code>小于get_max_fast()就进入<code>fastbin</code></li><li>通过fastbin_index(size)获取对应大小的<code>fastbin</code></li><li><code>fastbin(av,idx)</code>获取fastbin的位置</li><li>然后chunk入链</li></ul><h3 id="malloc源码分析" tabindex="-1"><a class="header-anchor" href="#malloc源码分析" aria-hidden="true">#</a> malloc源码分析</h3><ul><li>运行<code>_int_malloc</code>函数</li><li>先获取我们真正需要的 <code>chunk</code> 大小</li><li>判断是否是<code>fastbin</code>范围</li><li>获取对应大小的<code>fastbin</code>然后获取位置</li><li>然后 chunk出链</li></ul><h3 id="fastbin" tabindex="-1"><a class="header-anchor" href="#fastbin" aria-hidden="true">#</a> Fastbin</h3><ul><li>fd指向下一个<code>free chunk</code>的<code>chunk head</code>(也就是下一个free的chunk)</li><li>不去修改p</li></ul><h3 id="tcache" tabindex="-1"><a class="header-anchor" href="#tcache" aria-hidden="true">#</a> Tcache</h3><ul><li><p>从libc2.26开始引入</p></li><li><p>从0x20到0x410</p></li><li><p>每个tcache最多收取7个chunk</p></li><li><p>用结构<code>tcache_perthread_struct</code>管理<code>tcache</code></p><ul><li>存在于<code>TLS</code></li><li>一共两个部分 一个是对应大小的tcache bin的链表(每个最多存7个chunk) 一个是对应链表的元素数量</li></ul></li><li><p>chunk的bk是一串随机的安全数 防止double free的</p></li><li><p>fd指向的是 下一个<code>free chunk</code>的<code>mem</code>(也就是payload的部分)</p></li></ul><h2 id="fastbin-dup" tabindex="-1"><a class="header-anchor" href="#fastbin-dup" aria-hidden="true">#</a> Fastbin dup</h2><blockquote><p>算是一个正式的攻击手段</p></blockquote><ul><li><p>利用<code>double free</code>让整个链表陷入循环</p><blockquote><p>比如现在fastBin-&gt;chunk1-&gt;chunk2 然后此时<code>chunk1</code>的fd指向<code>chunk2</code>然后我们再次free <code>chunk2</code>那么chunk2的fd指向<code>chunk1</code>就会变成:<br>fastBin-&gt;chunk2-&gt;chunk1-&gt;chunk2-&gt;chunk1的死循环</p></blockquote></li><li><p>然后我们<code>malloc</code>一下 获取了<code>chunk2</code>然后此时链表:<code>fastbin-&gt;chunk1-&gt;chunk2-&gt;chunk1...</code></p></li><li><p>然后我们修改<code>chunk2</code>fd指向我们想要修改的地方 那么链表:<code>fastbin-&gt;chunk1-&gt;chunk2-&gt;addr_we_want</code></p></li><li><p>那么我们<code>malloc</code>三次获取我们想要的地址的读写权</p><blockquote><p>记住是我们想要写入地址-0x10 因为还有<code>prev_size</code>+<code>size</code></p></blockquote></li><li><p>然后根据源码 我们可以知道</p><ul><li>size检查</li></ul><blockquote><p>我们的size得&gt;=2*SIZE_SZ然后必须&lt;=av-&gt;system_mem</p></blockquote><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span> <span class="token punctuation">(</span><span class="token function">chunk_at_offset</span> <span class="token punctuation">(</span>p<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token operator">-&gt;</span>size <span class="token operator">&lt;=</span> <span class="token number">2</span> <span class="token operator">*</span> SIZE_SZ<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token operator">||</span> <span class="token function">__builtin_expect</span> <span class="token punctuation">(</span><span class="token function">chunksize</span> <span class="token punctuation">(</span><span class="token function">chunk_at_offset</span> <span class="token punctuation">(</span>p<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">)</span>
			     <span class="token operator">&gt;=</span> av<span class="token operator">-&gt;</span>system_mem<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">{</span>
	<span class="token comment">/* We might not have a lock at this point and concurrent modifications
	   of system_mem might have let to a false positive.  Redo the test
	   after getting the lock.  */</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>have_lock
	    <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token function">assert</span> <span class="token punctuation">(</span>locked <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		  <span class="token function">mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>av<span class="token operator">-&gt;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
		  locked <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
		  <span class="token function">chunk_at_offset</span> <span class="token punctuation">(</span>p<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token operator">-&gt;</span>size <span class="token operator">&lt;=</span> <span class="token number">2</span> <span class="token operator">*</span> SIZE_SZ
		    <span class="token operator">||</span> <span class="token function">chunksize</span> <span class="token punctuation">(</span><span class="token function">chunk_at_offset</span> <span class="token punctuation">(</span>p<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> av<span class="token operator">-&gt;</span>system_mem<span class="token punctuation">;</span>
	      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	  <span class="token punctuation">{</span>
	    errstr <span class="token operator">=</span> <span class="token string">&quot;free(): invalid next size (fast)&quot;</span><span class="token punctuation">;</span>
	    <span class="token keyword">goto</span> errout<span class="token punctuation">;</span>
	  <span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> have_lock<span class="token punctuation">)</span>
	  <span class="token punctuation">{</span>
	    <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token function">mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>av<span class="token operator">-&gt;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
	    locked <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	  <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><p>检查<code>double chunk</code></p><blockquote><p>仅仅是检查bin中第一个chunk是否是<code>相同</code>的chunk</p></blockquote><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token function">free_perturb</span> <span class="token punctuation">(</span><span class="token function">chunk2mem</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">,</span> size <span class="token operator">-</span> <span class="token number">2</span> <span class="token operator">*</span> SIZE_SZ<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">set_fastchunks</span><span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> idx <span class="token operator">=</span> <span class="token function">fastbin_index</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    fb <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token function">fastbin</span> <span class="token punctuation">(</span>av<span class="token punctuation">,</span> idx<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* Atomically link P to its fastbin: P-&gt;FD = *FB; *FB = P;  */</span>
    mchunkptr old <span class="token operator">=</span> <span class="token operator">*</span>fb<span class="token punctuation">,</span> old2<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> old_idx <span class="token operator">=</span> <span class="token operator">~</span><span class="token number">0u</span><span class="token punctuation">;</span>
    <span class="token keyword">do</span>
      <span class="token punctuation">{</span>
	<span class="token comment">/* Check that the top of the bin is not the record we are going to add
	   (i.e., double free).  */</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span> <span class="token punctuation">(</span>old <span class="token operator">==</span> p<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	  <span class="token punctuation">{</span>
	    errstr <span class="token operator">=</span> <span class="token string">&quot;double free or corruption (fasttop)&quot;</span><span class="token punctuation">;</span>
	    <span class="token keyword">goto</span> errout<span class="token punctuation">;</span>
	  <span class="token punctuation">}</span>
	<span class="token comment">/* Check that size of fastbin chunk at the top is the same as
	   size of the chunk that we are adding.  We can dereference OLD
	   only if we have the lock, otherwise it might have already been
	   deallocated.  See use of OLD_IDX below for the actual check.  */</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>have_lock <span class="token operator">&amp;&amp;</span> old <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
	  old_idx <span class="token operator">=</span> <span class="token function">fastbin_index</span><span class="token punctuation">(</span><span class="token function">chunksize</span><span class="token punctuation">(</span>old<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	p<span class="token operator">-&gt;</span>fd <span class="token operator">=</span> old2 <span class="token operator">=</span> old<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>old <span class="token operator">=</span> <span class="token function">catomic_compare_and_exchange_val_rel</span> <span class="token punctuation">(</span>fb<span class="token punctuation">,</span> p<span class="token punctuation">,</span> old2<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> old2<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>have_lock <span class="token operator">&amp;&amp;</span> old <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token operator">&amp;&amp;</span> <span class="token function">__builtin_expect</span> <span class="token punctuation">(</span>old_idx <span class="token operator">!=</span> idx<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">{</span>
	errstr <span class="token operator">=</span> <span class="token string">&quot;invalid fastbin entry (free)&quot;</span><span class="token punctuation">;</span>
	<span class="token keyword">goto</span> errout<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><h3 id="tcache利用" tabindex="-1"><a class="header-anchor" href="#tcache利用" aria-hidden="true">#</a> Tcache利用</h3><blockquote><p>大多数性质和fastbin是一样的 但是<code>calloc</code>是不会拿<code>tcache</code>的 所以我们一般把tcache填满来绕过</p></blockquote></li></ul>`,18),p=[o];function c(i,l){return s(),a("div",null,p)}const r=n(e,[["render",c],["__file","studyHeapVedio.html.vue"]]);export{r as default};
