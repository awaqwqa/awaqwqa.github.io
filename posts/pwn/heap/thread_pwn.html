<!doctype html>
<html lang="en-US" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.0" />
    <meta name="theme" content="VuePress Theme Hope 2.0.0-rc.10" />
    <style>
      html {
        background: var(--bg-color, #fff);
      }

      html[data-theme="dark"] {
        background: var(--bg-color, #1d1e1f);
      }

      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <meta property="og:url" content="https://mister-hope.github.io/posts/pwn/heap/thread_pwn.html"><meta property="og:site_name" content="Blog"><meta property="og:title" content="多线程pwn(ptmalloc)"><meta property="og:description" content="多线程pwn(ptmalloc) 参考文章:ptmalloc堆概述-多线程支持_ptmalloc主arena存在的意义-CSDN博客 推荐(讲得很清晰):ptmalloc源码分析 - 主分配区和非主分配区Arena的实现（04）_malloc main arena-CSDN博客 ptmalloc源码分析 - 分配区状态机malloc_state（02）-CSDN博客 ptmalloc源码分析 - 分配区heap_info结构实现（05）-CSDN博客"><meta property="og:type" content="article"><meta property="og:locale" content="en-US"><meta property="og:updated_time" content="2024-05-06T11:47:02.000Z"><meta property="article:author" content="Elegy"><meta property="article:tag" content="pwn"><meta property="article:tag" content="thread"><meta property="article:tag" content="heap"><meta property="article:modified_time" content="2024-05-06T11:47:02.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"多线程pwn(ptmalloc)","image":[""],"dateModified":"2024-05-06T11:47:02.000Z","author":[{"@type":"Person","name":"Elegy"}]}</script><title>多线程pwn(ptmalloc) | Blog</title><meta name="description" content="多线程pwn(ptmalloc) 参考文章:ptmalloc堆概述-多线程支持_ptmalloc主arena存在的意义-CSDN博客 推荐(讲得很清晰):ptmalloc源码分析 - 主分配区和非主分配区Arena的实现（04）_malloc main arena-CSDN博客 ptmalloc源码分析 - 分配区状态机malloc_state（02）-CSDN博客 ptmalloc源码分析 - 分配区heap_info结构实现（05）-CSDN博客">
    <link rel="preload" href="/assets/style-I9UN-qkK.css" as="style"><link rel="stylesheet" href="/assets/style-I9UN-qkK.css">
    <link rel="modulepreload" href="/assets/app--zBhGYdQ.js"><link rel="modulepreload" href="/assets/thread_pwn.html-nvOQzQ5y.js"><link rel="modulepreload" href="/assets/thread_pwn.html-j0B2pExX.js"><link rel="modulepreload" href="/assets/plugin-vue_export-helper-x3n3nnut.js">
    <link rel="prefetch" href="/assets/index.html-d64lF5z5.js" as="script"><link rel="prefetch" href="/assets/friendLink.html-zr_xV-0i.js" as="script"><link rel="prefetch" href="/assets/sycKernel.html-Fkgiwa3i.js" as="script"><link rel="prefetch" href="/assets/readme_standards.html-pEVNdxIX.js" as="script"><link rel="prefetch" href="/assets/base.html-ECKQmzL9.js" as="script"><link rel="prefetch" href="/assets/frida反调试.html-_6yV3zBe.js" as="script"><link rel="prefetch" href="/assets/objection.html-oYsjUDpx.js" as="script"><link rel="prefetch" href="/assets/xml文件格式分析.html-HCR8DFFP.js" as="script"><link rel="prefetch" href="/assets/RSA.html-i3LWN_iw.js" as="script"><link rel="prefetch" href="/assets/db_study_1.html-hY-rcKqU.js" as="script"><link rel="prefetch" href="/assets/goArchitecture.html-wH43_rkA.js" as="script"><link rel="prefetch" href="/assets/websocket.html-jgj4qoyh.js" as="script"><link rel="prefetch" href="/assets/algorithm_1.html-k0MSIWpr.js" as="script"><link rel="prefetch" href="/assets/build_specified_libc_docker.html-6leHLICp.js" as="script"><link rel="prefetch" href="/assets/git_standards.html-NHHv3Ez-.js" as="script"><link rel="prefetch" href="/assets/git_study.html-qpJp1DA0.js" as="script"><link rel="prefetch" href="/assets/asyncio.html-bNG7HEWb.js" as="script"><link rel="prefetch" href="/assets/c2018-HitCon-gundam(tcahe机制_泄露libc地址).html-ygG5hO5u.js" as="script"><link rel="prefetch" href="/assets/computeChunkSize.html-OabBS5TA.js" as="script"><link rel="prefetch" href="/assets/ez_chunk.html-bGTu0FU5.js" as="script"><link rel="prefetch" href="/assets/high_glibc_overlapping.html-x2iapavU.js" as="script"><link rel="prefetch" href="/assets/house_of_lore.html-e_lNhOgz.js" as="script"><link rel="prefetch" href="/assets/largeBinAttack.html-8I3fGqA1.js" as="script"><link rel="prefetch" href="/assets/studyHeap.html-k4lcrI12.js" as="script"><link rel="prefetch" href="/assets/studyHeapVedio.html-g78EyZnE.js" as="script"><link rel="prefetch" href="/assets/studyHeapVedio2.html-2umXXczC.js" as="script"><link rel="prefetch" href="/assets/unsortedBinLeakLibc.html-XH7fxtfm.js" as="script"><link rel="prefetch" href="/assets/vctf_leak_libc.html-oaheUN0Z.js" as="script"><link rel="prefetch" href="/assets/xyctf_heap_pro.html-ZMtPwtuh.js" as="script"><link rel="prefetch" href="/assets/house_of_apple.html-PqYQUqHo.js" as="script"><link rel="prefetch" href="/assets/io_file.html-Uim73Lpe.js" as="script"><link rel="prefetch" href="/assets/io_file_study2.html-BSDbfpSO.js" as="script"><link rel="prefetch" href="/assets/linux_kernel2.html-DMvbcq2S.js" as="script"><link rel="prefetch" href="/assets/socket.html-p7GxAPCV.js" as="script"><link rel="prefetch" href="/assets/php.html-yKr5yWYy.js" as="script"><link rel="prefetch" href="/assets/8byte(栈迁移).html-DI-O40Yh.js" as="script"><link rel="prefetch" href="/assets/ret2dl.html-tO1F6hlv.js" as="script"><link rel="prefetch" href="/assets/usePatchelf.html-d4-oWJvX.js" as="script"><link rel="prefetch" href="/assets/babyre.html-5Mnk2RGn.js" as="script"><link rel="prefetch" href="/assets/nc(file).html-FOCg92VM.js" as="script"><link rel="prefetch" href="/assets/siscn_pwn1(栈迁移_float数据格式).html-T8XbMrXX.js" as="script"><link rel="prefetch" href="/assets/xyctf.html-U7JXxgQE.js" as="script"><link rel="prefetch" href="/assets/404.html-GbdKBWVO.js" as="script"><link rel="prefetch" href="/assets/index.html-hSZUPkrO.js" as="script"><link rel="prefetch" href="/assets/index.html-pNGu0lUA.js" as="script"><link rel="prefetch" href="/assets/index.html-Xj4Q9xIB.js" as="script"><link rel="prefetch" href="/assets/index.html-PuHu6YHX.js" as="script"><link rel="prefetch" href="/assets/index.html-tLPcYGIY.js" as="script"><link rel="prefetch" href="/assets/index.html-4NfTkLWT.js" as="script"><link rel="prefetch" href="/assets/index.html-4cD2voHP.js" as="script"><link rel="prefetch" href="/assets/index.html-rMNPHRzW.js" as="script"><link rel="prefetch" href="/assets/index.html-24FdbV0X.js" as="script"><link rel="prefetch" href="/assets/index.html-czMqdCgc.js" as="script"><link rel="prefetch" href="/assets/index.html-fSO7t_lT.js" as="script"><link rel="prefetch" href="/assets/index.html-iZBUR2OT.js" as="script"><link rel="prefetch" href="/assets/index.html-l5-YUSgT.js" as="script"><link rel="prefetch" href="/assets/index.html-LNcUfwr4.js" as="script"><link rel="prefetch" href="/assets/index.html-nEruGExL.js" as="script"><link rel="prefetch" href="/assets/index.html-9Aqdve0Y.js" as="script"><link rel="prefetch" href="/assets/index.html-WKQ9YVKS.js" as="script"><link rel="prefetch" href="/assets/index.html-tzE_FC09.js" as="script"><link rel="prefetch" href="/assets/index.html-6QmsITJo.js" as="script"><link rel="prefetch" href="/assets/index.html-ecknHaKX.js" as="script"><link rel="prefetch" href="/assets/index.html-dr1vm6Y5.js" as="script"><link rel="prefetch" href="/assets/index.html-oZ7OrbtP.js" as="script"><link rel="prefetch" href="/assets/index.html-uoti10BU.js" as="script"><link rel="prefetch" href="/assets/index.html-h74VB_iX.js" as="script"><link rel="prefetch" href="/assets/index.html-FX0FUsyi.js" as="script"><link rel="prefetch" href="/assets/index.html-5ejjnIEC.js" as="script"><link rel="prefetch" href="/assets/index.html-OOIKiO_Q.js" as="script"><link rel="prefetch" href="/assets/index.html-mjDNWrju.js" as="script"><link rel="prefetch" href="/assets/index.html-T1yxd-4C.js" as="script"><link rel="prefetch" href="/assets/index.html-vmnwGQ_x.js" as="script"><link rel="prefetch" href="/assets/index.html-kQVPBo8D.js" as="script"><link rel="prefetch" href="/assets/index.html-OJk1c0ek.js" as="script"><link rel="prefetch" href="/assets/index.html-5kdxgiAV.js" as="script"><link rel="prefetch" href="/assets/index.html-kYz9mkQs.js" as="script"><link rel="prefetch" href="/assets/index.html-T0M1RHdG.js" as="script"><link rel="prefetch" href="/assets/index.html-kZKZ9YNl.js" as="script"><link rel="prefetch" href="/assets/index.html-ToVv3Ha4.js" as="script"><link rel="prefetch" href="/assets/index.html-eNdUahdf.js" as="script"><link rel="prefetch" href="/assets/index.html-tf1pjMmD.js" as="script"><link rel="prefetch" href="/assets/index.html-5qmzGUj6.js" as="script"><link rel="prefetch" href="/assets/index.html-G-06IUJG.js" as="script"><link rel="prefetch" href="/assets/index.html-RbJyN7x6.js" as="script"><link rel="prefetch" href="/assets/index.html-wkxvpnTw.js" as="script"><link rel="prefetch" href="/assets/index.html-2qwayshd.js" as="script"><link rel="prefetch" href="/assets/index.html-Ix21QJuL.js" as="script"><link rel="prefetch" href="/assets/index.html-QJFi238y.js" as="script"><link rel="prefetch" href="/assets/index.html-wOO6TPmu.js" as="script"><link rel="prefetch" href="/assets/index.html-IRzW8Ehl.js" as="script"><link rel="prefetch" href="/assets/index.html-YZMti94B.js" as="script"><link rel="prefetch" href="/assets/index.html-tkJfiFUZ.js" as="script"><link rel="prefetch" href="/assets/index.html-c-XZEzeF.js" as="script"><link rel="prefetch" href="/assets/index.html-e9cfnpw9.js" as="script"><link rel="prefetch" href="/assets/index.html-VE33PuXf.js" as="script"><link rel="prefetch" href="/assets/friendLink.html-sQ1rRthq.js" as="script"><link rel="prefetch" href="/assets/sycKernel.html-zKUEayz7.js" as="script"><link rel="prefetch" href="/assets/readme_standards.html-tbT40Uog.js" as="script"><link rel="prefetch" href="/assets/base.html-aS57iuIg.js" as="script"><link rel="prefetch" href="/assets/frida反调试.html-aUK3HGaT.js" as="script"><link rel="prefetch" href="/assets/objection.html-nZgiDAJL.js" as="script"><link rel="prefetch" href="/assets/xml文件格式分析.html-97kSGrGt.js" as="script"><link rel="prefetch" href="/assets/RSA.html-Jb2KJfZB.js" as="script"><link rel="prefetch" href="/assets/db_study_1.html-U-HFVmwV.js" as="script"><link rel="prefetch" href="/assets/goArchitecture.html-6ON7v4dm.js" as="script"><link rel="prefetch" href="/assets/websocket.html-Yl_i56rj.js" as="script"><link rel="prefetch" href="/assets/algorithm_1.html-ia6w45zo.js" as="script"><link rel="prefetch" href="/assets/build_specified_libc_docker.html-jwtYWagB.js" as="script"><link rel="prefetch" href="/assets/git_standards.html-2-MWFN9J.js" as="script"><link rel="prefetch" href="/assets/git_study.html-m4TV71zE.js" as="script"><link rel="prefetch" href="/assets/asyncio.html-l9KsbJCk.js" as="script"><link rel="prefetch" href="/assets/c2018-HitCon-gundam(tcahe机制_泄露libc地址).html-2YClyZ_1.js" as="script"><link rel="prefetch" href="/assets/computeChunkSize.html-ioKwn1OY.js" as="script"><link rel="prefetch" href="/assets/ez_chunk.html-ld3j3HVh.js" as="script"><link rel="prefetch" href="/assets/high_glibc_overlapping.html-amvbCNga.js" as="script"><link rel="prefetch" href="/assets/house_of_lore.html-_fnDEFHq.js" as="script"><link rel="prefetch" href="/assets/largeBinAttack.html-shb4qNJV.js" as="script"><link rel="prefetch" href="/assets/studyHeap.html-Kh69efq5.js" as="script"><link rel="prefetch" href="/assets/studyHeapVedio.html-inlvZk3a.js" as="script"><link rel="prefetch" href="/assets/studyHeapVedio2.html-qBhR55Fk.js" as="script"><link rel="prefetch" href="/assets/unsortedBinLeakLibc.html-4K6RQQ3D.js" as="script"><link rel="prefetch" href="/assets/vctf_leak_libc.html-09_v7tUY.js" as="script"><link rel="prefetch" href="/assets/xyctf_heap_pro.html-OHryDk_J.js" as="script"><link rel="prefetch" href="/assets/house_of_apple.html-mPHCRcjy.js" as="script"><link rel="prefetch" href="/assets/io_file.html-_N4V-XCC.js" as="script"><link rel="prefetch" href="/assets/io_file_study2.html-pXJ_6PnM.js" as="script"><link rel="prefetch" href="/assets/linux_kernel2.html-6vrAFplw.js" as="script"><link rel="prefetch" href="/assets/socket.html-2nesNwR1.js" as="script"><link rel="prefetch" href="/assets/php.html-AVC7fHY_.js" as="script"><link rel="prefetch" href="/assets/8byte(栈迁移).html-I44KqPPF.js" as="script"><link rel="prefetch" href="/assets/ret2dl.html-a3rsX5BX.js" as="script"><link rel="prefetch" href="/assets/usePatchelf.html-ohgP3p0j.js" as="script"><link rel="prefetch" href="/assets/babyre.html-thpyYdin.js" as="script"><link rel="prefetch" href="/assets/nc(file).html-OTTw40sC.js" as="script"><link rel="prefetch" href="/assets/siscn_pwn1(栈迁移_float数据格式).html-MduvxUpe.js" as="script"><link rel="prefetch" href="/assets/xyctf.html-IZxUqvlC.js" as="script"><link rel="prefetch" href="/assets/404.html-ZGxUBrll.js" as="script"><link rel="prefetch" href="/assets/index.html-Lpyeiiez.js" as="script"><link rel="prefetch" href="/assets/index.html--T2ZhD4b.js" as="script"><link rel="prefetch" href="/assets/index.html-dBA20Uc4.js" as="script"><link rel="prefetch" href="/assets/index.html-hJYdvB5f.js" as="script"><link rel="prefetch" href="/assets/index.html-nGICaO09.js" as="script"><link rel="prefetch" href="/assets/index.html-isudf8Ik.js" as="script"><link rel="prefetch" href="/assets/index.html-QVVZUW13.js" as="script"><link rel="prefetch" href="/assets/index.html-8E5g5n2e.js" as="script"><link rel="prefetch" href="/assets/index.html-lBp2kxjv.js" as="script"><link rel="prefetch" href="/assets/index.html-GRGTLp4A.js" as="script"><link rel="prefetch" href="/assets/index.html-usi6TSg_.js" as="script"><link rel="prefetch" href="/assets/index.html-BfF-nC9A.js" as="script"><link rel="prefetch" href="/assets/index.html-HWzC0tvp.js" as="script"><link rel="prefetch" href="/assets/index.html-92p6XaIJ.js" as="script"><link rel="prefetch" href="/assets/index.html-QQypJWZK.js" as="script"><link rel="prefetch" href="/assets/index.html-9RARVx2g.js" as="script"><link rel="prefetch" href="/assets/index.html-r3gicau4.js" as="script"><link rel="prefetch" href="/assets/index.html-jfk4-a1R.js" as="script"><link rel="prefetch" href="/assets/index.html-nLBIJb3Q.js" as="script"><link rel="prefetch" href="/assets/index.html-5koNIqyX.js" as="script"><link rel="prefetch" href="/assets/index.html-gFTBxfpc.js" as="script"><link rel="prefetch" href="/assets/index.html-MGtxhZmK.js" as="script"><link rel="prefetch" href="/assets/index.html-Xr9Stom2.js" as="script"><link rel="prefetch" href="/assets/index.html-cdFSvHl1.js" as="script"><link rel="prefetch" href="/assets/index.html-iygHVS_Q.js" as="script"><link rel="prefetch" href="/assets/index.html-_urGIHag.js" as="script"><link rel="prefetch" href="/assets/index.html-jDyIFgei.js" as="script"><link rel="prefetch" href="/assets/index.html-OpcR9FCB.js" as="script"><link rel="prefetch" href="/assets/index.html-n-p-qxO2.js" as="script"><link rel="prefetch" href="/assets/index.html-5gjSEksS.js" as="script"><link rel="prefetch" href="/assets/index.html-CZuS5-ly.js" as="script"><link rel="prefetch" href="/assets/index.html-7uWhSr_p.js" as="script"><link rel="prefetch" href="/assets/index.html-ATRQhwUP.js" as="script"><link rel="prefetch" href="/assets/index.html-gikri5Fr.js" as="script"><link rel="prefetch" href="/assets/index.html--NKfsOC-.js" as="script"><link rel="prefetch" href="/assets/index.html-RHQJP_J8.js" as="script"><link rel="prefetch" href="/assets/index.html-0gT3L6uP.js" as="script"><link rel="prefetch" href="/assets/index.html-iovc_Wne.js" as="script"><link rel="prefetch" href="/assets/index.html-nYhBwOOD.js" as="script"><link rel="prefetch" href="/assets/index.html-yVsmhQV2.js" as="script"><link rel="prefetch" href="/assets/index.html-Ghlg90S3.js" as="script"><link rel="prefetch" href="/assets/index.html-oHZDq2gG.js" as="script"><link rel="prefetch" href="/assets/index.html-9dlDELC_.js" as="script"><link rel="prefetch" href="/assets/index.html-ULcwdaHl.js" as="script"><link rel="prefetch" href="/assets/index.html-rIIVCDDy.js" as="script"><link rel="prefetch" href="/assets/index.html-51zfdowO.js" as="script"><link rel="prefetch" href="/assets/index.html-xqU4EfJF.js" as="script"><link rel="prefetch" href="/assets/index.html-51HSGhjF.js" as="script"><link rel="prefetch" href="/assets/index.html-BHLBK3Cp.js" as="script"><link rel="prefetch" href="/assets/index.html-ASdISkjQ.js" as="script"><link rel="prefetch" href="/assets/index.html-mXvt4KGN.js" as="script"><link rel="prefetch" href="/assets/index.html-ysL69_Nf.js" as="script"><link rel="prefetch" href="/assets/photoswipe.esm-08_zHRDQ.js" as="script"><link rel="prefetch" href="/assets/SearchResult-R5kxW9oq.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">Skip to main content</a><!--]--><div class="theme-container has-toc"><!--[--><header id="navbar" class="vp-navbar"><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><!--[--><a class="vp-link vp-brand vp-brand" href="/"><img class="vp-nav-logo" src="https://awaqwqa.github.io/石头门.jpg" aria-hidden><!----><span class="vp-site-name hide-in-pad">Blog</span></a><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-center"><!--[--><!----><!--]--><!--[--><nav class="vp-nav-links"><div class="nav-item hide-in-mobile"><a aria-label="Blog Home" class="vp-link nav-link nav-link" href="/"><span class="font-icon icon fa-fw fa-sm fas fa-home" style=""></span>Blog Home<!----></a></div><div class="nav-item hide-in-mobile"><a aria-label="文章" class="vp-link nav-link active nav-link active" href="/posts/"><span class="font-icon icon fa-fw fa-sm fas fa-article" style=""></span>文章<!----></a></div></nav><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-end"><!--[--><!----><!--]--><!--[--><!----><div class="nav-item vp-repo"><a class="vp-repo-link" href="https://github.com/vuepress-theme-hope/vuepress-theme-hope" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="nav-item hide-in-mobile"><button type="button" id="appearance-switch"><svg xmlns="http://www.w3.org/2000/svg" class="icon auto-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="auto icon" style="display:block;"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm0-840c-198.78 0-360 161.22-360 360 0 198.84 161.22 360 360 360s360-161.16 360-360c0-198.78-161.22-360-360-360zm0 660V212c165.72 0 300 134.34 300 300 0 165.72-134.28 300-300 300z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon dark-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="dark icon" style="display:none;"><path d="M524.8 938.667h-4.267a439.893 439.893 0 0 1-313.173-134.4 446.293 446.293 0 0 1-11.093-597.334A432.213 432.213 0 0 1 366.933 90.027a42.667 42.667 0 0 1 45.227 9.386 42.667 42.667 0 0 1 10.24 42.667 358.4 358.4 0 0 0 82.773 375.893 361.387 361.387 0 0 0 376.747 82.774 42.667 42.667 0 0 1 54.187 55.04 433.493 433.493 0 0 1-99.84 154.88 438.613 438.613 0 0 1-311.467 128z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon light-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="light icon" style="display:none;"><path d="M952 552h-80a40 40 0 0 1 0-80h80a40 40 0 0 1 0 80zM801.88 280.08a41 41 0 0 1-57.96-57.96l57.96-58a41.04 41.04 0 0 1 58 58l-58 57.96zM512 752a240 240 0 1 1 0-480 240 240 0 0 1 0 480zm0-560a40 40 0 0 1-40-40V72a40 40 0 0 1 80 0v80a40 40 0 0 1-40 40zm-289.88 88.08-58-57.96a41.04 41.04 0 0 1 58-58l57.96 58a41 41 0 0 1-57.96 57.96zM192 512a40 40 0 0 1-40 40H72a40 40 0 0 1 0-80h80a40 40 0 0 1 40 40zm30.12 231.92a41 41 0 0 1 57.96 57.96l-57.96 58a41.04 41.04 0 0 1-58-58l58-57.96zM512 832a40 40 0 0 1 40 40v80a40 40 0 0 1-80 0v-80a40 40 0 0 1 40-40zm289.88-88.08 58 57.96a41.04 41.04 0 0 1-58 58l-57.96-58a41 41 0 0 1 57.96-57.96z"></path></svg></button></div><!--[--><button type="button" class="search-pro-button" aria-label="Search"><svg xmlns="http://www.w3.org/2000/svg" class="icon search-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="search icon"><path d="M192 480a256 256 0 1 1 512 0 256 256 0 0 1-512 0m631.776 362.496-143.2-143.168A318.464 318.464 0 0 0 768 480c0-176.736-143.264-320-320-320S128 303.264 128 480s143.264 320 320 320a318.016 318.016 0 0 0 184.16-58.592l146.336 146.368c12.512 12.48 32.768 12.48 45.28 0 12.48-12.512 12.48-32.768 0-45.28"></path></svg><div class="search-pro-placeholder">Search</div><div class="search-pro-key-hints"><kbd class="search-pro-key">Ctrl</kbd><kbd class="search-pro-key">K</kbd></div></button><!--]--><!--]--><!--[--><!----><!--]--><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar"><!--[--><!----><!--]--><ul class="vp-sidebar-links"><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><!----><span class="vp-sidebar-title">Android</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><!----><span class="vp-sidebar-title">Development</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable active" type="button"><!----><span class="vp-sidebar-title">Pwn</span><span class="vp-arrow down"></span></button><ul class="vp-sidebar-links"><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><!----><span class="vp-sidebar-title">Competition</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable active" type="button"><!----><span class="vp-sidebar-title">Heap</span><span class="vp-arrow down"></span></button><ul class="vp-sidebar-links"><li><!--[--><a aria-label="c2018-HitCon-gundam(tcahe机制+泄露libc地址)" class="vp-link nav-link vp-sidebar-link vp-sidebar-page nav-link vp-sidebar-link vp-sidebar-page" href="/posts/pwn/heap/c2018-HitCon-gundam(tcahe%E6%9C%BA%E5%88%B6_%E6%B3%84%E9%9C%B2libc%E5%9C%B0%E5%9D%80).html"><!---->c2018-HitCon-gundam(tcahe机制+泄露libc地址)<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="ezChunk(unlink+offbynull)" class="vp-link nav-link vp-sidebar-link vp-sidebar-page nav-link vp-sidebar-link vp-sidebar-page" href="/posts/pwn/heap/ez_chunk.html"><!---->ezChunk(unlink+offbynull)<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="House of lore学习" class="vp-link nav-link vp-sidebar-link vp-sidebar-page nav-link vp-sidebar-link vp-sidebar-page" href="/posts/pwn/heap/house_of_lore.html"><!---->House of lore学习<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="large Bin Attack学习（_int_malloc源码细读 ）" class="vp-link nav-link vp-sidebar-link vp-sidebar-page nav-link vp-sidebar-link vp-sidebar-page" href="/posts/pwn/heap/largeBinAttack.html"><!---->large Bin Attack学习（_int_malloc源码细读 ）<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="NTUSTISC - Pwn 2学习笔记" class="vp-link nav-link vp-sidebar-link vp-sidebar-page nav-link vp-sidebar-link vp-sidebar-page" href="/posts/pwn/heap/studyHeapVedio.html"><!---->NTUSTISC - Pwn 2学习笔记<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="NTUSTISC-PWN3阅读笔记（1）" class="vp-link nav-link vp-sidebar-link vp-sidebar-page nav-link vp-sidebar-link vp-sidebar-page" href="/posts/pwn/heap/studyHeapVedio2.html"><!---->NTUSTISC-PWN3阅读笔记（1）<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="vctf apples leak libc操作复现(高版本的overlapping)" class="vp-link nav-link vp-sidebar-link vp-sidebar-page nav-link vp-sidebar-link vp-sidebar-page" href="/posts/pwn/heap/vctf_leak_libc.html"><!---->vctf apples leak libc操作复现(高版本的overlapping)<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="xyctf ptmp的做题记录(glibc2.35下的exit函数打法)" class="vp-link nav-link vp-sidebar-link vp-sidebar-page nav-link vp-sidebar-link vp-sidebar-page" href="/posts/pwn/heap/xyctf_heap_pro.html"><!---->xyctf ptmp的做题记录(glibc2.35下的exit函数打法)<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="写一个计算chunk大小的程序" class="vp-link nav-link vp-sidebar-link vp-sidebar-page nav-link vp-sidebar-link vp-sidebar-page" href="/posts/pwn/heap/computeChunkSize.html"><!---->写一个计算chunk大小的程序<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="多线程pwn(ptmalloc)" class="vp-link nav-link active vp-sidebar-link vp-sidebar-page active nav-link active vp-sidebar-link vp-sidebar-page active" href="/posts/pwn/heap/thread_pwn.html"><!---->多线程pwn(ptmalloc)<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a aria-label="主分配区 和 非主分配区" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/posts/pwn/heap/thread_pwn.html#主分配区-和-非主分配区"><!---->主分配区 和 非主分配区<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="多线程分配" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/posts/pwn/heap/thread_pwn.html#多线程分配"><!---->多线程分配<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a aria-label="流程" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/posts/pwn/heap/thread_pwn.html#流程"><!---->流程<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="调用链:" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/posts/pwn/heap/thread_pwn.html#调用链"><!---->调用链:<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="arena_get" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/posts/pwn/heap/thread_pwn.html#arena-get"><!---->arena_get<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="arena_get2" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/posts/pwn/heap/thread_pwn.html#arena-get2"><!---->arena_get2<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="_int_new_arena(new arena)" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/posts/pwn/heap/thread_pwn.html#int-new-arena-new-arena"><!---->_int_new_arena(new arena)<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="reused_arena" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/posts/pwn/heap/thread_pwn.html#reused-arena"><!---->reused_arena<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul></li></ul><!--]--></li><li><!--[--><a aria-label="深入学习堆结构" class="vp-link nav-link vp-sidebar-link vp-sidebar-page nav-link vp-sidebar-link vp-sidebar-page" href="/posts/pwn/heap/studyHeap.html"><!---->深入学习堆结构<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="记一次失败的UnsoretedBin 泄露libc（2024hgameWeek3 [1]）" class="vp-link nav-link vp-sidebar-link vp-sidebar-page nav-link vp-sidebar-link vp-sidebar-page" href="/posts/pwn/heap/unsortedBinLeakLibc.html"><!---->记一次失败的UnsoretedBin 泄露libc（2024hgameWeek3 [1]）<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="记一次高版本glibc(2.34)下常规overlapping失败的原因（vctf 2024 apples）" class="vp-link nav-link vp-sidebar-link vp-sidebar-page nav-link vp-sidebar-link vp-sidebar-page" href="/posts/pwn/heap/high_glibc_overlapping.html"><!---->记一次高版本glibc(2.34)下常规overlapping失败的原因（vctf 2024 apples）<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li></ul></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><!----><span class="vp-sidebar-title">Io File</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><!----><span class="vp-sidebar-title">Linux</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><!----><span class="vp-sidebar-title">Php Pwn</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><!----><span class="vp-sidebar-title">Stack</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><!----><span class="vp-sidebar-title">Tool Skill</span><span class="vp-arrow end"></span></button><!----></section></li></ul></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><!----><span class="vp-sidebar-title">Re</span><span class="vp-arrow end"></span></button><!----></section></li><li><!--[--><a aria-label="友情链接" class="vp-link nav-link vp-sidebar-link vp-sidebar-page nav-link vp-sidebar-link vp-sidebar-page" href="/posts/friendLink.html"><!---->友情链接<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><!----><span class="vp-sidebar-title">密码学</span><span class="vp-arrow end"></span></button><!----></section></li><li><!--[--><a aria-label="面试准备(热更)" class="vp-link nav-link vp-sidebar-link vp-sidebar-page nav-link vp-sidebar-link vp-sidebar-page" href="/posts/sycKernel.html"><!---->面试准备(热更)<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li></ul><!--[--><!----><!--]--></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!--[--><!----><!--]--><!----><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><!---->多线程pwn(ptmalloc)</h1><div class="page-info"><span class="page-author-info" aria-label="Author🖊" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><span class="page-author-item">Elegy</span></span><span property="author" content="Elegy"></span></span><!----><span class="page-date-info" aria-label="Writing Date📅" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2024-05-06T11:47:02.000Z"></span><!----><span class="page-reading-time-info" aria-label="Reading Time⌛" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>About 7 min</span><meta property="timeRequired" content="PT7M"></span><!----><span class="page-tag-info" aria-label="Tag🏷" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon tag-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="tag icon"><path d="M939.902 458.563L910.17 144.567c-1.507-16.272-14.465-29.13-30.737-30.737L565.438 84.098h-.402c-3.215 0-5.726 1.005-7.634 2.913l-470.39 470.39a10.004 10.004 0 000 14.164l365.423 365.424c1.909 1.908 4.42 2.913 7.132 2.913s5.223-1.005 7.132-2.913l470.39-470.39c2.01-2.11 3.014-5.023 2.813-8.036zm-240.067-72.121c-35.458 0-64.286-28.828-64.286-64.286s28.828-64.285 64.286-64.285 64.286 28.828 64.286 64.285-28.829 64.286-64.286 64.286z"></path></svg><!--[--><span class="page-tag-item tag0 clickable" role="navigation">pwn</span><span class="page-tag-item tag4 clickable" role="navigation">thread</span><span class="page-tag-item tag1 clickable" role="navigation">heap</span><!--]--><meta property="keywords" content="pwn,thread,heap"></span></div><hr></div><div class="toc-place-holder"><aside id="toc"><!--[--><!----><!--]--><div class="toc-header">On This Page<button type="button" class="print-button" title="Print"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button></div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="#主分配区-和-非主分配区">主分配区 和 非主分配区</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="#多线程分配">多线程分配</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#流程">流程</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#调用链">调用链:</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#arena-get">arena_get</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#arena-get2">arena_get2</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#int-new-arena-new-arena">_int_new_arena(new arena)</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#reused-arena">reused_arena</a></li><!----><!--]--></ul></li><!--]--></ul><div class="toc-marker" style="top:-1.7rem;"></div></div><!--[--><!----><!--]--></aside></div><!--[--><!----><!--]--><div class="theme-hope-content"><h1 id="多线程pwn-ptmalloc" tabindex="-1"><a class="header-anchor" href="#多线程pwn-ptmalloc" aria-hidden="true">#</a> 多线程pwn(ptmalloc)</h1><blockquote><p>参考文章:<a href="https://blog.csdn.net/luozhaotian/article/details/80267185" target="_blank" rel="noopener noreferrer">ptmalloc堆概述-多线程支持_ptmalloc主arena存在的意义-CSDN博客<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>推荐(讲得很清晰):<a href="https://blog.csdn.net/initphp/article/details/127750294" target="_blank" rel="noopener noreferrer">ptmalloc源码分析 - 主分配区和非主分配区Arena的实现（04）_malloc main arena-CSDN博客<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p><a href="https://initphp.blog.csdn.net/article/details/109489720" target="_blank" rel="noopener noreferrer">ptmalloc源码分析 - 分配区状态机malloc_state（02）-CSDN博客<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p><a href="https://initphp.blog.csdn.net/article/details/132564546?spm=1001.2014.3001.5502" target="_blank" rel="noopener noreferrer">ptmalloc源码分析 - 分配区heap_info结构实现（05）-CSDN博客<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p></blockquote><h2 id="主分配区-和-非主分配区" tabindex="-1"><a class="header-anchor" href="#主分配区-和-非主分配区" aria-hidden="true">#</a> 主分配区 和 非主分配区</h2><blockquote><p>ptmalloc通过<strong>malloc_state</strong>结构体来管理内存的分配等一系列操作 我们可以看见我们相对熟悉的<code>fastbinsY</code>和<code>bins</code>也就是我们接触最多的fastbin,unsortedbin,smallbin,largebin等 这里我们主要观察<code>next</code>,<code>next_free</code></p></blockquote><ul><li><p>ptmalloc中用主分配区和非主分配区用来解决线程争夺问题</p></li><li><p>非主分配区用mmap来映射获取内存</p></li><li><p>主分配区和非主分配区用<code>next</code>形成一个<code>环形链表</code>进行管理 <code>next</code>链接的是非主分配区</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token comment">/* 分配区全局链表：分配区链表，主分配区放头部，新加入的分配区放main_arean.next 位置 Linked list */</span>
  <span class="token keyword">struct</span> <span class="token class-name">malloc_state</span> <span class="token operator">*</span>next<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token comment">/**
 * 全局malloc状态管理
 */</span>
<span class="token keyword">struct</span> <span class="token class-name">malloc_state</span>
<span class="token punctuation">{</span>
  <span class="token comment">/* Serialize access. 同步访问互斥锁 */</span>
  <span class="token function">__libc_lock_define</span> <span class="token punctuation">(</span><span class="token punctuation">,</span> mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
  <span class="token comment">/* Flags (formerly in max_fast).
   * 用于标记当前主分配区的状态
   *  */</span>
  <span class="token keyword">int</span> flags<span class="token punctuation">;</span>
 
  <span class="token comment">/* Set if the fastbin chunks contain recently inserted free blocks.  */</span>
  <span class="token comment">/* Note this is a bool but not all targets support atomics on booleans.  */</span>
  <span class="token comment">/* 用于标记是否有fastchunk */</span>
  <span class="token keyword">int</span> have_fastchunks<span class="token punctuation">;</span>
 
  <span class="token comment">/* Fastbins fast bins。
   * fast bins是bins的高速缓冲区，大约有10个定长队列。
   * 当用户释放一块不大于max_fast（默认值64）的chunk（一般小内存）的时候，会默认会被放到fast bins上。
   * */</span>
  mfastbinptr fastbinsY<span class="token punctuation">[</span>NFASTBINS<span class="token punctuation">]</span><span class="token punctuation">;</span>
 
  <span class="token comment">/* Base of the topmost chunk -- not otherwise kept in a bin */</span>
  <span class="token comment">/* Top chunk ：并不是所有的chunk都会被放到bins上。
   * top chunk相当于分配区的顶部空闲内存，当bins上都不能满足内存分配要求的时候，就会来top chunk上分配。 */</span>
  mchunkptr top<span class="token punctuation">;</span>
 
  <span class="token comment">/* The remainder from the most recent split of a small request */</span>
  mchunkptr last_remainder<span class="token punctuation">;</span>
 
  <span class="token comment">/* Normal bins packed as described above
   * 常规 bins chunk的链表数组
   * 1. unsorted bin：是bins的一个缓冲区。当用户释放的内存大于max_fast或者fast bins合并后的chunk都会进入unsorted bin上
   * 2. small bins和large bins。small bins和large bins是真正用来放置chunk双向链表的。每个bin之间相差8个字节，并且通过上面的这个列表，
   * 可以快速定位到合适大小的空闲chunk。
   * 3. 下标1是unsorted bin，2到63是small bin，64到126是large bin，共126个bin
   * */</span>
  mchunkptr bins<span class="token punctuation">[</span>NBINS <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
 
  <span class="token comment">/* Bitmap of bins
   * 表示bin数组当中某一个下标的bin是否为空，用来在分配的时候加速
   * */</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> binmap<span class="token punctuation">[</span>BINMAPSIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
 
  <span class="token comment">/* 分配区全局链表：分配区链表，主分配区放头部，新加入的分配区放main_arean.next 位置 Linked list */</span>
  <span class="token keyword">struct</span> <span class="token class-name">malloc_state</span> <span class="token operator">*</span>next<span class="token punctuation">;</span>
 
  <span class="token comment">/* 分配区空闲链表 Linked list for free arenas.  Access to this field is serialized
     by free_list_lock in arena.c.  */</span>
  <span class="token keyword">struct</span> <span class="token class-name">malloc_state</span> <span class="token operator">*</span>next_free<span class="token punctuation">;</span>
 
  <span class="token comment">/* Number of threads attached to this arena.  0 if the arena is on
     the free list.  Access to this field is serialized by
     free_list_lock in arena.c.  */</span>
    <span class="token comment">// 空闲链表的状态记录，0-空闲，n-正在使用中，关联的线程个数（一个分配区可以给多个线程使用）</span>
  INTERNAL_SIZE_T attached_threads<span class="token punctuation">;</span>
 
  <span class="token comment">/* Memory allocated from the system in this arena.  */</span>
  INTERNAL_SIZE_T system_mem<span class="token punctuation">;</span>
  INTERNAL_SIZE_T max_system_mem<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="多线程分配" tabindex="-1"><a class="header-anchor" href="#多线程分配" aria-hidden="true">#</a> 多线程分配</h2><blockquote><p>malloc/arena.c/_int_new_arena函数中</p></blockquote><h3 id="流程" tabindex="-1"><a class="header-anchor" href="#流程" aria-hidden="true">#</a> 流程</h3><ul><li><p>线程中malloc 会检查线程中是否存在<code>分配区</code>，如果存在直接加锁，并且进行内存分配</p></li><li><p>否则通过<code>next</code>遍历链表查看有未加锁<code>分配区</code> 然后加锁分配</p></li><li><p>如果无的话 会<code>ptamlloc</code>一个新的分配区 加入<code>malloc_state-&gt;next</code> 然后加锁进行分配</p><blockquote><p>下方是malloc一个新的分区的情况</p></blockquote><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token function">__libc_lock_init</span> <span class="token punctuation">(</span>a<span class="token operator">-&gt;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">__libc_lock_lock</span> <span class="token punctuation">(</span>list_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* Add the new arena to the global list.  */</span>
a<span class="token operator">-&gt;</span>next <span class="token operator">=</span> main_arena<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
<span class="token comment">/* FIXME: The barrier is an attempt to synchronize with read access
     in reused_arena, which does not acquire list_lock while
     traversing the list.  */</span>
<span class="token function">atomic_write_barrier</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
main_arena<span class="token punctuation">.</span>next <span class="token operator">=</span> a<span class="token punctuation">;</span>
<span class="token function">__libc_lock_unlock</span> <span class="token punctuation">(</span>list_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">__libc_lock_lock</span> <span class="token punctuation">(</span>free_list_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">detach_arena</span> <span class="token punctuation">(</span>replaced_arena<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">__libc_lock_unlock</span> <span class="token punctuation">(</span>free_list_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><h3 id="调用链" tabindex="-1"><a class="header-anchor" href="#调用链" aria-hidden="true">#</a> 调用链:</h3><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code>__libc_malloc<span class="token operator">-&gt;</span>
    	arena_get
    	arena_get2<span class="token operator">-&gt;</span>
    		_int_new_arena
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>先调用arena_get失败则调用arena_get2然后arena_get2中如果分配没有满则调用_int_new_arena满了调用<strong>reused_arena</strong></li></ul><h3 id="arena-get" tabindex="-1"><a class="header-anchor" href="#arena-get" aria-hidden="true">#</a> arena_get</h3><blockquote><p>调用主要是__libc_malloc函数中</p></blockquote><ul><li><p>从<code>thread_arena</code>中获取分配区 如果成功则加锁 没有成功则通过<code>arena_get2</code>进行分配区的申请与初始化</p><blockquote><p>每个线程都会设置这么一个变量<code>thread_arena</code> 该变量保存对应的分配区。如果是主线程，则thread_arena设置成main_arena。</p><p><code>main_arena</code>是在ptamlloc_init的时候初始化的 主线程对应主分配区</p></blockquote><div class="language-C line-numbers-mode" data-ext="C"><pre class="language-C"><code>#define arena_get(ptr, size) do { \
      ptr = thread_arena;						      \
      arena_lock (ptr, size);						      \
  } while (0)
static mstate
arena_get_retry (mstate ar_ptr, size_t bytes)
{
  LIBC_PROBE (memory_arena_retry, 2, bytes, ar_ptr);
  if (ar_ptr != &amp;main_arena)
    {
      __libc_lock_unlock (ar_ptr-&gt;mutex);
      ar_ptr = &amp;main_arena;
      __libc_lock_lock (ar_ptr-&gt;mutex);
    }
  else
    {
      __libc_lock_unlock (ar_ptr-&gt;mutex);
      ar_ptr = arena_get2 (bytes, ar_ptr);
    }

  return ar_ptr;
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://awaqwqa.github.io/img/thread_pwn/image-20240506184605509.png" alt="image-20240506184605509" tabindex="0" loading="lazy"><figcaption>image-20240506184605509</figcaption></figure></li></ul><h3 id="arena-get2" tabindex="-1"><a class="header-anchor" href="#arena-get2" aria-hidden="true">#</a> <strong>arena_get2</strong></h3><blockquote><p>这里出现的<code>arena</code>数量的上限 64位数量是<code>8*cores+1</code> 32位是<code>2*cores+1</code></p></blockquote><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code>
<span class="token keyword">static</span> mstate
<span class="token function">arena_get2</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span> size<span class="token punctuation">,</span> mstate avoid_arena<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  mstate a<span class="token punctuation">;</span>

  <span class="token keyword">static</span> <span class="token class-name">size_t</span> narenas_limit<span class="token punctuation">;</span>
    <span class="token comment">// 从空闲链表中获取一个分配区，如果空闲链表中有该分配区，则直接使用，返回结果</span>
  a <span class="token operator">=</span> <span class="token function">get_free_list</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 获取失败的情况</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>a <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      <span class="token comment">/* Nothing immediately available, so generate a new arena.  */</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>narenas_limit <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>mp_<span class="token punctuation">.</span>arena_max <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
            narenas_limit <span class="token operator">=</span> mp_<span class="token punctuation">.</span>arena_max<span class="token punctuation">;</span>
          <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>narenas <span class="token operator">&gt;</span> mp_<span class="token punctuation">.</span>arena_test<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
              <span class="token keyword">int</span> n <span class="token operator">=</span> <span class="token function">__get_nprocs_sched</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

              <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">&gt;=</span> <span class="token number">1</span><span class="token punctuation">)</span>
                narenas_limit <span class="token operator">=</span> <span class="token function">NARENAS_FROM_NCORES</span> <span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token keyword">else</span>
                <span class="token comment">/* We have no information about the system.  Assume two
                   cores.  */</span>
                narenas_limit <span class="token operator">=</span> <span class="token function">NARENAS_FROM_NCORES</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    repeat<span class="token operator">:</span><span class="token punctuation">;</span>
      <span class="token class-name">size_t</span> n <span class="token operator">=</span> narenas<span class="token punctuation">;</span>
      <span class="token comment">/* NB: the following depends on the fact that (size_t)0 - 1 is a
         very large number and that the underflow is OK.  If arena_max
         is set the value of arena_test is irrelevant.  If arena_test
         is set but narenas is not yet larger or equal to arena_test
         narenas_limit is 0.  There is no possibility for narenas to
         be too big for the test to always fail since there is not
         enough address space to create that many arenas.  */</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__glibc_unlikely</span> <span class="token punctuation">(</span>n <span class="token operator">&lt;=</span> narenas_limit <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">catomic_compare_and_exchange_bool_acq</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>narenas<span class="token punctuation">,</span> n <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">goto</span> repeat<span class="token punctuation">;</span>
          a <span class="token operator">=</span> <span class="token function">_int_new_arena</span> <span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
	  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__glibc_unlikely</span> <span class="token punctuation">(</span>a <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token function">catomic_decrement</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>narenas<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token keyword">else</span>
          <span class="token comment">// 如果</span>
        a <span class="token operator">=</span> <span class="token function">reused_arena</span> <span class="token punctuation">(</span>avoid_arena<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token keyword">return</span> a<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="int-new-arena-new-arena" tabindex="-1"><a class="header-anchor" href="#int-new-arena-new-arena" aria-hidden="true">#</a> <strong>_int_new_arena</strong>(new arena)</h3><blockquote><p>创建一个非主分配区</p></blockquote><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token comment">/**
 * 初始化一个新的分配区arena
 * 该函数主要创建：非主分配区
 * 主分配区在ptmalloc_init中初始化，并且设置了全局变量main_arena的值
 */</span>
<span class="token keyword">static</span> mstate <span class="token function">_int_new_arena</span><span class="token punctuation">(</span><span class="token class-name">size_t</span> size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	mstate a<span class="token punctuation">;</span>
	heap_info <span class="token operator">*</span>h<span class="token punctuation">;</span>
	<span class="token keyword">char</span> <span class="token operator">*</span>ptr<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">long</span> misalign<span class="token punctuation">;</span>
 
	<span class="token comment">/* 分配一个heap_info，用于记录堆的信息，非主分配区一般都是通过MMAP向系统申请内存；非主分配区申请后，是不能被销毁的 */</span>
	<span class="token comment">// new_heap是仅仅在非主分配区使用的</span>
    h <span class="token operator">=</span> <span class="token function">new_heap</span><span class="token punctuation">(</span>size <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>h<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>a<span class="token punctuation">)</span> <span class="token operator">+</span> MALLOC_ALIGNMENT<span class="token punctuation">)</span><span class="token punctuation">,</span>
			mp_<span class="token punctuation">.</span>top_pad<span class="token punctuation">)</span><span class="token punctuation">;</span>å
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>h<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">/* Maybe size is too large to fit in a single heap.  So, just try
		 to create a minimally-sized arena and let _int_malloc() attempt
		 to deal with the large request via mmap_chunk().  */</span>
		h <span class="token operator">=</span> <span class="token function">new_heap</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>h<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>a<span class="token punctuation">)</span> <span class="token operator">+</span> MALLOC_ALIGNMENT<span class="token punctuation">,</span> mp_<span class="token punctuation">.</span>top_pad<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>h<span class="token punctuation">)</span>
			<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	a <span class="token operator">=</span> h<span class="token operator">-&gt;</span>ar_ptr <span class="token operator">=</span> <span class="token punctuation">(</span>mstate<span class="token punctuation">)</span><span class="token punctuation">(</span>h <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//heap_info-&gt;ar_ptr的值设置成mstate的分配区状态机的数据结构</span>
 
	<span class="token function">malloc_init_state</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//初始化mstate</span>
	a<span class="token operator">-&gt;</span>attached_threads <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">//设置进程关联个数</span>
	<span class="token comment">/*a-&gt;next = NULL;*/</span>
	a<span class="token operator">-&gt;</span>system_mem <span class="token operator">=</span> a<span class="token operator">-&gt;</span>max_system_mem <span class="token operator">=</span> h<span class="token operator">-&gt;</span>size<span class="token punctuation">;</span>
 
	<span class="token comment">/* Set up the top chunk, with proper alignment. */</span>
	ptr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>a <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	misalign <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token function">chunk2mem</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span> <span class="token operator">&amp;</span> MALLOC_ALIGN_MASK<span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>misalign <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
		ptr <span class="token operator">+=</span> MALLOC_ALIGNMENT <span class="token operator">-</span> misalign<span class="token punctuation">;</span>
	<span class="token function">top</span> <span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span>mchunkptr<span class="token punctuation">)</span> ptr<span class="token punctuation">;</span>
	<span class="token function">set_head</span><span class="token punctuation">(</span><span class="token function">top</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> h <span class="token operator">+</span> h<span class="token operator">-&gt;</span>size<span class="token punctuation">)</span> <span class="token operator">-</span> ptr<span class="token punctuation">)</span> <span class="token operator">|</span> PREV_INUSE<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
	<span class="token function">LIBC_PROBE</span><span class="token punctuation">(</span>memory_arena_new<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> a<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
	mstate replaced_arena <span class="token operator">=</span> thread_arena<span class="token punctuation">;</span>
	thread_arena <span class="token operator">=</span> a<span class="token punctuation">;</span> <span class="token comment">//将当前线程设置mstate</span>
	<span class="token function">__libc_lock_init</span><span class="token punctuation">(</span>a<span class="token operator">-&gt;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//初始化分配区锁</span>
 
	<span class="token function">__libc_lock_lock</span><span class="token punctuation">(</span>list_lock<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//加上分配区锁</span>
 
	<span class="token comment">/* 将新的分配区加入到全局链表上，新申请的分配区都会放入主分配区的下一个位置*/</span>
	<span class="token comment">/* Add the new arena to the global list.  */</span>
	a<span class="token operator">-&gt;</span>next <span class="token operator">=</span> main_arena<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
	<span class="token comment">/* FIXME: The barrier is an attempt to synchronize with read access
	 in reused_arena, which does not acquire list_lock while
	 traversing the list.  */</span>
	<span class="token function">atomic_write_barrier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	main_arena<span class="token punctuation">.</span>next <span class="token operator">=</span> a<span class="token punctuation">;</span>
	<span class="token function">__libc_lock_unlock</span><span class="token punctuation">(</span>list_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
	<span class="token comment">/* 调整attached_threads状态*/</span>
	<span class="token function">__libc_lock_lock</span><span class="token punctuation">(</span>free_list_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">detach_arena</span><span class="token punctuation">(</span>replaced_arena<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">__libc_lock_unlock</span><span class="token punctuation">(</span>free_list_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
 
	 __malloc_fork_lock_parent<span class="token punctuation">.</span>  <span class="token operator">*</span><span class="token operator">/</span>
 
	<span class="token function">__libc_lock_lock</span><span class="token punctuation">(</span>a<span class="token operator">-&gt;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//解除分配区锁</span>
 
	<span class="token keyword">return</span> a<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
 
<span class="token comment">/* Remove the arena from the free list (if it is present).
 free_list_lock must have been acquired by the caller.
 移动链表地址，移除free_list上的分配区结构*/</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">remove_from_free_list</span><span class="token punctuation">(</span>mstate arena<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	mstate <span class="token operator">*</span>previous <span class="token operator">=</span> <span class="token operator">&amp;</span>free_list<span class="token punctuation">;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span>mstate p <span class="token operator">=</span> free_list<span class="token punctuation">;</span> p <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> p <span class="token operator">=</span> p<span class="token operator">-&gt;</span>next_free<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">assert</span><span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>attached_threads <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> arena<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">/* Remove the requested arena from the list.  */</span>
			<span class="token operator">*</span>previous <span class="token operator">=</span> p<span class="token operator">-&gt;</span>next_free<span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span>
			previous <span class="token operator">=</span> <span class="token operator">&amp;</span>p<span class="token operator">-&gt;</span>next_free<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="reused-arena" tabindex="-1"><a class="header-anchor" href="#reused-arena" aria-hidden="true">#</a> <strong>reused_arena</strong></h3><blockquote><p>简单来说就是遍历整个分配区表判断是否有锁 没锁就能用 这样就可以实现循环利用</p></blockquote></div><!--[--><!----><!--]--><footer class="page-meta"><div class="meta-item edit-link"><a href="https://github.com/vuepress-theme-hope/vuepress-theme-hope/edit/main/src/posts/pwn/heap/thread_pwn.md" rel="noopener noreferrer" target="_blank" aria-label="Edit this page on GitHub" class="nav-link label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->Edit this page on GitHub<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="meta-item git-info"><div class="update-time"><span class="label">Last update: </span><!----></div><div class="contributors"><span class="label">Contributors: </span><!--[--><!--[--><span class="contributor" title="email: 88972629+awaqwqa@users.noreply.github.com">awaqwqa</span><!--]--><!--]--></div></div></footer><nav class="vp-page-nav"><a aria-label="写一个计算chunk大小的程序" class="vp-link nav-link prev nav-link prev" href="/posts/pwn/heap/computeChunkSize.html"><div class="hint"><span class="arrow start"></span>Prev</div><div class="link"><!---->写一个计算chunk大小的程序</div></a><a aria-label="深入学习堆结构" class="vp-link nav-link next nav-link next" href="/posts/pwn/heap/studyHeap.html"><div class="hint">Next<span class="arrow end"></span></div><div class="link">深入学习堆结构<!----></div></a></nav><!----><!--[--><!----><!--]--><!--]--></main><!--]--><footer class="vp-footer-wrapper"><div class="vp-footer">Default footer</div><div class="vp-copyright">Copyright © 2024 Elegy</div></footer></div><!--]--><!----><!----><!--]--></div>
    <script type="module" src="/assets/app--zBhGYdQ.js" defer></script>
  </body>
</html>
