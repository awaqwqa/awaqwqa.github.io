<!doctype html>
<html lang="en-US" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.0" />
    <meta name="theme" content="VuePress Theme Hope 2.0.0-rc.10" />
    <style>
      html {
        background: var(--bg-color, #fff);
      }

      html[data-theme="dark"] {
        background: var(--bg-color, #1d1e1f);
      }

      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <meta property="og:url" content="https://mister-hope.github.io/posts/pwn/heap/largeBinAttack.html"><meta property="og:site_name" content="Blog"><meta property="og:title" content="large Bin Attack学习（_int_malloc源码细读 ）"><meta property="og:description" content="large Bin Attack学习（_int_malloc源码细读 ） 参考文章:wiki:Large Bin Attack - CTF Wiki (ctf-wiki.org)源码级调试glibc:源码级调试glibc_glibc cannot be compiled without optimization-CSDN博客源码分析:glibc 2.31 malloc与free 源码分析（持续更新） - PwnKi - 博客园 (cnblogs.com)+glibc malloc源码分析 - PwnKi - 博客园 (cnblogs.com)详细拆分了_int_malloc的流程 并且按照功能分了标题 想要了解对应部分就直接点击标题跳转即可第一次阅读glibc的源码然后进行分析 有错误的地方请大佬指正"><meta property="og:type" content="article"><meta property="og:locale" content="en-US"><meta property="og:updated_time" content="2024-03-10T17:43:45.000Z"><meta property="article:author" content="Elegy"><meta property="article:tag" content="pwn"><meta property="article:tag" content="heap"><meta property="article:modified_time" content="2024-03-10T17:43:45.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"large Bin Attack学习（_int_malloc源码细读 ）","image":[""],"dateModified":"2024-03-10T17:43:45.000Z","author":[{"@type":"Person","name":"Elegy"}]}</script><title>large Bin Attack学习（_int_malloc源码细读 ） | Blog</title><meta name="description" content="large Bin Attack学习（_int_malloc源码细读 ） 参考文章:wiki:Large Bin Attack - CTF Wiki (ctf-wiki.org)源码级调试glibc:源码级调试glibc_glibc cannot be compiled without optimization-CSDN博客源码分析:glibc 2.31 malloc与free 源码分析（持续更新） - PwnKi - 博客园 (cnblogs.com)+glibc malloc源码分析 - PwnKi - 博客园 (cnblogs.com)详细拆分了_int_malloc的流程 并且按照功能分了标题 想要了解对应部分就直接点击标题跳转即可第一次阅读glibc的源码然后进行分析 有错误的地方请大佬指正">
    <link rel="preload" href="/assets/style-I9UN-qkK.css" as="style"><link rel="stylesheet" href="/assets/style-I9UN-qkK.css">
    <link rel="modulepreload" href="/assets/app-sBtzFhHn.js"><link rel="modulepreload" href="/assets/largeBinAttack.html-8I3fGqA1.js"><link rel="modulepreload" href="/assets/largeBinAttack.html-HAE6tChP.js"><link rel="modulepreload" href="/assets/plugin-vue_export-helper-x3n3nnut.js">
    <link rel="prefetch" href="/assets/index.html-d64lF5z5.js" as="script"><link rel="prefetch" href="/assets/readme_standards.html-pEVNdxIX.js" as="script"><link rel="prefetch" href="/assets/base.html-ECKQmzL9.js" as="script"><link rel="prefetch" href="/assets/frida反调试.html-_6yV3zBe.js" as="script"><link rel="prefetch" href="/assets/objection.html-oYsjUDpx.js" as="script"><link rel="prefetch" href="/assets/xml文件格式分析.html-HCR8DFFP.js" as="script"><link rel="prefetch" href="/assets/sycKernel.html-gggiZcDz.js" as="script"><link rel="prefetch" href="/assets/build_specified_libc_docker.html-6leHLICp.js" as="script"><link rel="prefetch" href="/assets/git_standards.html-NHHv3Ez-.js" as="script"><link rel="prefetch" href="/assets/git_study.html-qpJp1DA0.js" as="script"><link rel="prefetch" href="/assets/asyncio.html-bNG7HEWb.js" as="script"><link rel="prefetch" href="/assets/c2018-HitCon-gundam(tcahe机制_泄露libc地址).html-ygG5hO5u.js" as="script"><link rel="prefetch" href="/assets/computeChunkSize.html-OabBS5TA.js" as="script"><link rel="prefetch" href="/assets/ez_chunk.html-bGTu0FU5.js" as="script"><link rel="prefetch" href="/assets/high_glibc_overlapping.html-x2iapavU.js" as="script"><link rel="prefetch" href="/assets/house_of_lore.html-e_lNhOgz.js" as="script"><link rel="prefetch" href="/assets/studyHeap.html-k4lcrI12.js" as="script"><link rel="prefetch" href="/assets/studyHeapVedio.html-g78EyZnE.js" as="script"><link rel="prefetch" href="/assets/studyHeapVedio2.html-2umXXczC.js" as="script"><link rel="prefetch" href="/assets/thread_pwn.html-nvOQzQ5y.js" as="script"><link rel="prefetch" href="/assets/unsortedBinLeakLibc.html-XH7fxtfm.js" as="script"><link rel="prefetch" href="/assets/vctf_leak_libc.html-oaheUN0Z.js" as="script"><link rel="prefetch" href="/assets/xyctf_heap_pro.html-ZMtPwtuh.js" as="script"><link rel="prefetch" href="/assets/house_of_apple.html-PqYQUqHo.js" as="script"><link rel="prefetch" href="/assets/io_file.html-Uim73Lpe.js" as="script"><link rel="prefetch" href="/assets/io_file_study2.html-BSDbfpSO.js" as="script"><link rel="prefetch" href="/assets/socket.html-p7GxAPCV.js" as="script"><link rel="prefetch" href="/assets/php.html-yKr5yWYy.js" as="script"><link rel="prefetch" href="/assets/8byte(栈迁移).html-DI-O40Yh.js" as="script"><link rel="prefetch" href="/assets/ret2dl.html-tO1F6hlv.js" as="script"><link rel="prefetch" href="/assets/usePatchelf.html-d4-oWJvX.js" as="script"><link rel="prefetch" href="/assets/babyre.html-5Mnk2RGn.js" as="script"><link rel="prefetch" href="/assets/nc(file).html-FOCg92VM.js" as="script"><link rel="prefetch" href="/assets/siscn_pwn1(栈迁移_float数据格式).html-T8XbMrXX.js" as="script"><link rel="prefetch" href="/assets/xyctf.html-U7JXxgQE.js" as="script"><link rel="prefetch" href="/assets/404.html-GbdKBWVO.js" as="script"><link rel="prefetch" href="/assets/index.html-pNGu0lUA.js" as="script"><link rel="prefetch" href="/assets/index.html-hSZUPkrO.js" as="script"><link rel="prefetch" href="/assets/index.html-Xj4Q9xIB.js" as="script"><link rel="prefetch" href="/assets/index.html-l5-YUSgT.js" as="script"><link rel="prefetch" href="/assets/index.html-24FdbV0X.js" as="script"><link rel="prefetch" href="/assets/index.html-czMqdCgc.js" as="script"><link rel="prefetch" href="/assets/index.html-fSO7t_lT.js" as="script"><link rel="prefetch" href="/assets/index.html-iZBUR2OT.js" as="script"><link rel="prefetch" href="/assets/index.html-LNcUfwr4.js" as="script"><link rel="prefetch" href="/assets/index.html-nEruGExL.js" as="script"><link rel="prefetch" href="/assets/index.html-9Aqdve0Y.js" as="script"><link rel="prefetch" href="/assets/index.html-WKQ9YVKS.js" as="script"><link rel="prefetch" href="/assets/index.html-tzE_FC09.js" as="script"><link rel="prefetch" href="/assets/index.html-6QmsITJo.js" as="script"><link rel="prefetch" href="/assets/index.html-ecknHaKX.js" as="script"><link rel="prefetch" href="/assets/index.html-dr1vm6Y5.js" as="script"><link rel="prefetch" href="/assets/index.html-oZ7OrbtP.js" as="script"><link rel="prefetch" href="/assets/index.html-uoti10BU.js" as="script"><link rel="prefetch" href="/assets/index.html-h74VB_iX.js" as="script"><link rel="prefetch" href="/assets/index.html-FX0FUsyi.js" as="script"><link rel="prefetch" href="/assets/index.html-5ejjnIEC.js" as="script"><link rel="prefetch" href="/assets/index.html-OOIKiO_Q.js" as="script"><link rel="prefetch" href="/assets/index.html-mjDNWrju.js" as="script"><link rel="prefetch" href="/assets/index.html-vmnwGQ_x.js" as="script"><link rel="prefetch" href="/assets/index.html-kQVPBo8D.js" as="script"><link rel="prefetch" href="/assets/index.html-OJk1c0ek.js" as="script"><link rel="prefetch" href="/assets/index.html-5kdxgiAV.js" as="script"><link rel="prefetch" href="/assets/index.html-kYz9mkQs.js" as="script"><link rel="prefetch" href="/assets/index.html-T1yxd-4C.js" as="script"><link rel="prefetch" href="/assets/index.html-tf1pjMmD.js" as="script"><link rel="prefetch" href="/assets/index.html-5qmzGUj6.js" as="script"><link rel="prefetch" href="/assets/index.html-G-06IUJG.js" as="script"><link rel="prefetch" href="/assets/index.html-RbJyN7x6.js" as="script"><link rel="prefetch" href="/assets/index.html-wkxvpnTw.js" as="script"><link rel="prefetch" href="/assets/index.html-2qwayshd.js" as="script"><link rel="prefetch" href="/assets/index.html-Ix21QJuL.js" as="script"><link rel="prefetch" href="/assets/index.html-QJFi238y.js" as="script"><link rel="prefetch" href="/assets/index.html-IRzW8Ehl.js" as="script"><link rel="prefetch" href="/assets/index.html-YZMti94B.js" as="script"><link rel="prefetch" href="/assets/index.html-tkJfiFUZ.js" as="script"><link rel="prefetch" href="/assets/index.html-c-XZEzeF.js" as="script"><link rel="prefetch" href="/assets/index.html-e9cfnpw9.js" as="script"><link rel="prefetch" href="/assets/index.html-is3Y65og.js" as="script"><link rel="prefetch" href="/assets/readme_standards.html-UJYDfic-.js" as="script"><link rel="prefetch" href="/assets/base.html-GQpeHwT6.js" as="script"><link rel="prefetch" href="/assets/frida反调试.html-ZILEnFwB.js" as="script"><link rel="prefetch" href="/assets/objection.html-EhkmHbpX.js" as="script"><link rel="prefetch" href="/assets/xml文件格式分析.html-Cln7swiD.js" as="script"><link rel="prefetch" href="/assets/sycKernel.html-3SR2Bk6z.js" as="script"><link rel="prefetch" href="/assets/build_specified_libc_docker.html-1_N5IdlK.js" as="script"><link rel="prefetch" href="/assets/git_standards.html-_WYDj2qg.js" as="script"><link rel="prefetch" href="/assets/git_study.html-yf32ak77.js" as="script"><link rel="prefetch" href="/assets/asyncio.html-zXKE1-35.js" as="script"><link rel="prefetch" href="/assets/c2018-HitCon-gundam(tcahe机制_泄露libc地址).html-bfLfK5rJ.js" as="script"><link rel="prefetch" href="/assets/computeChunkSize.html-j69fdG2b.js" as="script"><link rel="prefetch" href="/assets/ez_chunk.html-p3sE1aL3.js" as="script"><link rel="prefetch" href="/assets/high_glibc_overlapping.html-_NZPcbNX.js" as="script"><link rel="prefetch" href="/assets/house_of_lore.html-cpfp2vPB.js" as="script"><link rel="prefetch" href="/assets/studyHeap.html-3Ugu3yqQ.js" as="script"><link rel="prefetch" href="/assets/studyHeapVedio.html-7OAK3dyq.js" as="script"><link rel="prefetch" href="/assets/studyHeapVedio2.html-g5lhgAcv.js" as="script"><link rel="prefetch" href="/assets/thread_pwn.html-n1EgQHog.js" as="script"><link rel="prefetch" href="/assets/unsortedBinLeakLibc.html-fS9cQH6e.js" as="script"><link rel="prefetch" href="/assets/vctf_leak_libc.html-ifh86vVO.js" as="script"><link rel="prefetch" href="/assets/xyctf_heap_pro.html-Px2E18Kq.js" as="script"><link rel="prefetch" href="/assets/house_of_apple.html-KriuqbpK.js" as="script"><link rel="prefetch" href="/assets/io_file.html-AY3cxR1Q.js" as="script"><link rel="prefetch" href="/assets/io_file_study2.html-vvO-Gw6b.js" as="script"><link rel="prefetch" href="/assets/socket.html-F8za58YR.js" as="script"><link rel="prefetch" href="/assets/php.html-kDg0MUM5.js" as="script"><link rel="prefetch" href="/assets/8byte(栈迁移).html-4xAC0dsc.js" as="script"><link rel="prefetch" href="/assets/ret2dl.html-qe8_WzTk.js" as="script"><link rel="prefetch" href="/assets/usePatchelf.html-5zLHCdsJ.js" as="script"><link rel="prefetch" href="/assets/babyre.html-gNn9pWer.js" as="script"><link rel="prefetch" href="/assets/nc(file).html-UKNqbqSC.js" as="script"><link rel="prefetch" href="/assets/siscn_pwn1(栈迁移_float数据格式).html-sEZLvcPb.js" as="script"><link rel="prefetch" href="/assets/xyctf.html-yOylodQP.js" as="script"><link rel="prefetch" href="/assets/404.html-oPiH4nFG.js" as="script"><link rel="prefetch" href="/assets/index.html-wogyMiYS.js" as="script"><link rel="prefetch" href="/assets/index.html-oArxeJax.js" as="script"><link rel="prefetch" href="/assets/index.html-uPi1DBjs.js" as="script"><link rel="prefetch" href="/assets/index.html-5BYGnxS4.js" as="script"><link rel="prefetch" href="/assets/index.html-Dr5NQgYQ.js" as="script"><link rel="prefetch" href="/assets/index.html-bkYDQCQs.js" as="script"><link rel="prefetch" href="/assets/index.html-DmIDYEna.js" as="script"><link rel="prefetch" href="/assets/index.html-6vyDSbYv.js" as="script"><link rel="prefetch" href="/assets/index.html-FAik6qCB.js" as="script"><link rel="prefetch" href="/assets/index.html-PWg7_Jyb.js" as="script"><link rel="prefetch" href="/assets/index.html-MwGtg2zy.js" as="script"><link rel="prefetch" href="/assets/index.html-9fCrCm9a.js" as="script"><link rel="prefetch" href="/assets/index.html-unNKztR4.js" as="script"><link rel="prefetch" href="/assets/index.html-g3RHH0cw.js" as="script"><link rel="prefetch" href="/assets/index.html-_mGWVGF3.js" as="script"><link rel="prefetch" href="/assets/index.html-vCle3H5Z.js" as="script"><link rel="prefetch" href="/assets/index.html-hpa-KBux.js" as="script"><link rel="prefetch" href="/assets/index.html-CTaQZcik.js" as="script"><link rel="prefetch" href="/assets/index.html-G4SsOCVX.js" as="script"><link rel="prefetch" href="/assets/index.html-hytExE8P.js" as="script"><link rel="prefetch" href="/assets/index.html-SAqxUf5J.js" as="script"><link rel="prefetch" href="/assets/index.html-WI4AuZWw.js" as="script"><link rel="prefetch" href="/assets/index.html-Yax3oTDx.js" as="script"><link rel="prefetch" href="/assets/index.html-StMaXHtT.js" as="script"><link rel="prefetch" href="/assets/index.html-Mx5DcfuC.js" as="script"><link rel="prefetch" href="/assets/index.html-SbtIcHL6.js" as="script"><link rel="prefetch" href="/assets/index.html-Vt1LBiMx.js" as="script"><link rel="prefetch" href="/assets/index.html-nO0u1lya.js" as="script"><link rel="prefetch" href="/assets/index.html-eNqVxQpK.js" as="script"><link rel="prefetch" href="/assets/index.html-JZYHwmGl.js" as="script"><link rel="prefetch" href="/assets/index.html-T78lUv9w.js" as="script"><link rel="prefetch" href="/assets/index.html-zfpjZXp-.js" as="script"><link rel="prefetch" href="/assets/index.html-EtMn3ZHk.js" as="script"><link rel="prefetch" href="/assets/index.html-BOc7Ii8a.js" as="script"><link rel="prefetch" href="/assets/index.html-jqTEpv7w.js" as="script"><link rel="prefetch" href="/assets/index.html-vxfb92Ed.js" as="script"><link rel="prefetch" href="/assets/index.html-Qx0BKrF0.js" as="script"><link rel="prefetch" href="/assets/index.html-AMYFDJQG.js" as="script"><link rel="prefetch" href="/assets/index.html-XGoRZfVH.js" as="script"><link rel="prefetch" href="/assets/index.html-AV9xS6FM.js" as="script"><link rel="prefetch" href="/assets/index.html-t_MsEglB.js" as="script"><link rel="prefetch" href="/assets/index.html-A0p_rZ50.js" as="script"><link rel="prefetch" href="/assets/photoswipe.esm-08_zHRDQ.js" as="script"><link rel="prefetch" href="/assets/SearchResult-TvYXEOlL.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">Skip to main content</a><!--]--><div class="theme-container has-toc"><!--[--><header id="navbar" class="vp-navbar"><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><!--[--><a class="vp-link vp-brand vp-brand" href="/"><img class="vp-nav-logo" src="https://awaqwqa.github.io/石头门.jpg" aria-hidden><!----><span class="vp-site-name hide-in-pad">Blog</span></a><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-center"><!--[--><!----><!--]--><!--[--><nav class="vp-nav-links"><div class="nav-item hide-in-mobile"><a aria-label="Blog Home" class="vp-link nav-link nav-link" href="/"><span class="font-icon icon fa-fw fa-sm fas fa-home" style=""></span>Blog Home<!----></a></div><div class="nav-item hide-in-mobile"><a aria-label="文章" class="vp-link nav-link active nav-link active" href="/posts/"><span class="font-icon icon fa-fw fa-sm fas fa-article" style=""></span>文章<!----></a></div></nav><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-end"><!--[--><!----><!--]--><!--[--><!----><div class="nav-item vp-repo"><a class="vp-repo-link" href="https://github.com/vuepress-theme-hope/vuepress-theme-hope" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="nav-item hide-in-mobile"><button type="button" id="appearance-switch"><svg xmlns="http://www.w3.org/2000/svg" class="icon auto-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="auto icon" style="display:block;"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm0-840c-198.78 0-360 161.22-360 360 0 198.84 161.22 360 360 360s360-161.16 360-360c0-198.78-161.22-360-360-360zm0 660V212c165.72 0 300 134.34 300 300 0 165.72-134.28 300-300 300z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon dark-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="dark icon" style="display:none;"><path d="M524.8 938.667h-4.267a439.893 439.893 0 0 1-313.173-134.4 446.293 446.293 0 0 1-11.093-597.334A432.213 432.213 0 0 1 366.933 90.027a42.667 42.667 0 0 1 45.227 9.386 42.667 42.667 0 0 1 10.24 42.667 358.4 358.4 0 0 0 82.773 375.893 361.387 361.387 0 0 0 376.747 82.774 42.667 42.667 0 0 1 54.187 55.04 433.493 433.493 0 0 1-99.84 154.88 438.613 438.613 0 0 1-311.467 128z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon light-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="light icon" style="display:none;"><path d="M952 552h-80a40 40 0 0 1 0-80h80a40 40 0 0 1 0 80zM801.88 280.08a41 41 0 0 1-57.96-57.96l57.96-58a41.04 41.04 0 0 1 58 58l-58 57.96zM512 752a240 240 0 1 1 0-480 240 240 0 0 1 0 480zm0-560a40 40 0 0 1-40-40V72a40 40 0 0 1 80 0v80a40 40 0 0 1-40 40zm-289.88 88.08-58-57.96a41.04 41.04 0 0 1 58-58l57.96 58a41 41 0 0 1-57.96 57.96zM192 512a40 40 0 0 1-40 40H72a40 40 0 0 1 0-80h80a40 40 0 0 1 40 40zm30.12 231.92a41 41 0 0 1 57.96 57.96l-57.96 58a41.04 41.04 0 0 1-58-58l58-57.96zM512 832a40 40 0 0 1 40 40v80a40 40 0 0 1-80 0v-80a40 40 0 0 1 40-40zm289.88-88.08 58 57.96a41.04 41.04 0 0 1-58 58l-57.96-58a41 41 0 0 1 57.96-57.96z"></path></svg></button></div><!--[--><button type="button" class="search-pro-button" aria-label="Search"><svg xmlns="http://www.w3.org/2000/svg" class="icon search-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="search icon"><path d="M192 480a256 256 0 1 1 512 0 256 256 0 0 1-512 0m631.776 362.496-143.2-143.168A318.464 318.464 0 0 0 768 480c0-176.736-143.264-320-320-320S128 303.264 128 480s143.264 320 320 320a318.016 318.016 0 0 0 184.16-58.592l146.336 146.368c12.512 12.48 32.768 12.48 45.28 0 12.48-12.512 12.48-32.768 0-45.28"></path></svg><div class="search-pro-placeholder">Search</div><div class="search-pro-key-hints"><kbd class="search-pro-key">Ctrl</kbd><kbd class="search-pro-key">K</kbd></div></button><!--]--><!--]--><!--[--><!----><!--]--><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar"><!--[--><!----><!--]--><ul class="vp-sidebar-links"><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><!----><span class="vp-sidebar-title">Android</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><!----><span class="vp-sidebar-title">Development</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable active" type="button"><!----><span class="vp-sidebar-title">Pwn</span><span class="vp-arrow down"></span></button><ul class="vp-sidebar-links"><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><!----><span class="vp-sidebar-title">Competition</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable active" type="button"><!----><span class="vp-sidebar-title">Heap</span><span class="vp-arrow down"></span></button><ul class="vp-sidebar-links"><li><!--[--><a aria-label="c2018-HitCon-gundam(tcahe机制+泄露libc地址)" class="vp-link nav-link vp-sidebar-link vp-sidebar-page nav-link vp-sidebar-link vp-sidebar-page" href="/posts/pwn/heap/c2018-HitCon-gundam(tcahe%E6%9C%BA%E5%88%B6_%E6%B3%84%E9%9C%B2libc%E5%9C%B0%E5%9D%80).html"><!---->c2018-HitCon-gundam(tcahe机制+泄露libc地址)<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="ezChunk(unlink+offbynull)" class="vp-link nav-link vp-sidebar-link vp-sidebar-page nav-link vp-sidebar-link vp-sidebar-page" href="/posts/pwn/heap/ez_chunk.html"><!---->ezChunk(unlink+offbynull)<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="House of lore学习" class="vp-link nav-link vp-sidebar-link vp-sidebar-page nav-link vp-sidebar-link vp-sidebar-page" href="/posts/pwn/heap/house_of_lore.html"><!---->House of lore学习<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="large Bin Attack学习（_int_malloc源码细读 ）" class="vp-link nav-link active vp-sidebar-link vp-sidebar-page active nav-link active vp-sidebar-link vp-sidebar-page active" href="/posts/pwn/heap/largeBinAttack.html"><!---->large Bin Attack学习（_int_malloc源码细读 ）<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a aria-label="源码分析(largebin malloc)" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/posts/pwn/heap/largeBinAttack.html#源码分析-largebin-malloc"><!---->源码分析(largebin malloc)<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a aria-label="Unsortedbin的合并/入链/分配操作" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/posts/pwn/heap/largeBinAttack.html#unsortedbin的合并-入链-分配操作"><!---->Unsortedbin的合并/入链/分配操作<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="遍历的开始（梦的开始）" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/posts/pwn/heap/largeBinAttack.html#遍历的开始-梦的开始"><!---->遍历的开始（梦的开始）<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="调试" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/posts/pwn/heap/largeBinAttack.html#调试"><!---->调试<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="安全检查机制" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/posts/pwn/heap/largeBinAttack.html#安全检查机制"><!---->安全检查机制<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="直接返回smallbin_chunk情况" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/posts/pwn/heap/largeBinAttack.html#直接返回smallbin-chunk情况"><!---->直接返回smallbin_chunk情况<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="从unsortedbin中移除" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/posts/pwn/heap/largeBinAttack.html#从unsortedbin中移除"><!---->从unsortedbin中移除<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="大小刚好相等情况" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/posts/pwn/heap/largeBinAttack.html#大小刚好相等情况"><!---->大小刚好相等情况<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="归类入链操作" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/posts/pwn/heap/largeBinAttack.html#归类入链操作"><!---->归类入链操作<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="small 和 large最终入bin操作" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/posts/pwn/heap/largeBinAttack.html#small-和-large最终入bin操作"><!---->small 和 large最终入bin操作<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="smallbin的fwd bck赋值" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/posts/pwn/heap/largeBinAttack.html#smallbin的fwd-bck赋值"><!---->smallbin的fwd bck赋值<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="largebin 入bin链和chunk size链" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/posts/pwn/heap/largeBinAttack.html#largebin-入bin链和chunk-size链"><!---->largebin 入bin链和chunk size链<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="从largebin中获取chunk" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/posts/pwn/heap/largeBinAttack.html#从largebin中获取chunk"><!---->从largebin中获取chunk<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="chunk脱链 remainder chunk入链" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/posts/pwn/heap/largeBinAttack.html#chunk脱链-remainder-chunk入链"><!---->chunk脱链 remainder chunk入链<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="返回被切割后的chunk" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/posts/pwn/heap/largeBinAttack.html#返回被切割后的chunk"><!---->返回被切割后的chunk<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="从topchunk中获取chunk" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/posts/pwn/heap/largeBinAttack.html#从topchunk中获取chunk"><!---->从topchunk中获取chunk<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="_int_free_源码" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/posts/pwn/heap/largeBinAttack.html#int-free-源码"><!---->_int_free_源码<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul></li><li class="vp-sidebar-sub-header"><a aria-label="漏洞利用" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/posts/pwn/heap/largeBinAttack.html#漏洞利用"><!---->漏洞利用<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul><!--]--></li><li><!--[--><a aria-label="NTUSTISC - Pwn 2学习笔记" class="vp-link nav-link vp-sidebar-link vp-sidebar-page nav-link vp-sidebar-link vp-sidebar-page" href="/posts/pwn/heap/studyHeapVedio.html"><!---->NTUSTISC - Pwn 2学习笔记<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="NTUSTISC-PWN3阅读笔记（1）" class="vp-link nav-link vp-sidebar-link vp-sidebar-page nav-link vp-sidebar-link vp-sidebar-page" href="/posts/pwn/heap/studyHeapVedio2.html"><!---->NTUSTISC-PWN3阅读笔记（1）<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="vctf apples leak libc操作复现(高版本的overlapping)" class="vp-link nav-link vp-sidebar-link vp-sidebar-page nav-link vp-sidebar-link vp-sidebar-page" href="/posts/pwn/heap/vctf_leak_libc.html"><!---->vctf apples leak libc操作复现(高版本的overlapping)<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="xyctf ptmp的做题记录(glibc2.35下的exit函数打法)" class="vp-link nav-link vp-sidebar-link vp-sidebar-page nav-link vp-sidebar-link vp-sidebar-page" href="/posts/pwn/heap/xyctf_heap_pro.html"><!---->xyctf ptmp的做题记录(glibc2.35下的exit函数打法)<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="写一个计算chunk大小的程序" class="vp-link nav-link vp-sidebar-link vp-sidebar-page nav-link vp-sidebar-link vp-sidebar-page" href="/posts/pwn/heap/computeChunkSize.html"><!---->写一个计算chunk大小的程序<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="多线程pwn(ptmalloc)" class="vp-link nav-link vp-sidebar-link vp-sidebar-page nav-link vp-sidebar-link vp-sidebar-page" href="/posts/pwn/heap/thread_pwn.html"><!---->多线程pwn(ptmalloc)<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="深入学习堆结构" class="vp-link nav-link vp-sidebar-link vp-sidebar-page nav-link vp-sidebar-link vp-sidebar-page" href="/posts/pwn/heap/studyHeap.html"><!---->深入学习堆结构<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="记一次失败的UnsoretedBin 泄露libc（2024hgameWeek3 [1]）" class="vp-link nav-link vp-sidebar-link vp-sidebar-page nav-link vp-sidebar-link vp-sidebar-page" href="/posts/pwn/heap/unsortedBinLeakLibc.html"><!---->记一次失败的UnsoretedBin 泄露libc（2024hgameWeek3 [1]）<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="记一次高版本glibc(2.34)下常规overlapping失败的原因（vctf 2024 apples）" class="vp-link nav-link vp-sidebar-link vp-sidebar-page nav-link vp-sidebar-link vp-sidebar-page" href="/posts/pwn/heap/high_glibc_overlapping.html"><!---->记一次高版本glibc(2.34)下常规overlapping失败的原因（vctf 2024 apples）<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li></ul></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><!----><span class="vp-sidebar-title">Io File</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><!----><span class="vp-sidebar-title">Linux</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><!----><span class="vp-sidebar-title">Php Pwn</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><!----><span class="vp-sidebar-title">Stack</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><!----><span class="vp-sidebar-title">Tool Skill</span><span class="vp-arrow end"></span></button><!----></section></li><li><!--[--><a aria-label="面试准备(热更)" class="vp-link nav-link vp-sidebar-link vp-sidebar-page nav-link vp-sidebar-link vp-sidebar-page" href="/posts/pwn/sycKernel.html"><!---->面试准备(热更)<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li></ul></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><!----><span class="vp-sidebar-title">Re</span><span class="vp-arrow end"></span></button><!----></section></li></ul><!--[--><!----><!--]--></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!--[--><!----><!--]--><!----><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><!---->large Bin Attack学习（_int_malloc源码细读 ）</h1><div class="page-info"><span class="page-author-info" aria-label="Author🖊" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><span class="page-author-item">Elegy</span></span><span property="author" content="Elegy"></span></span><!----><span class="page-date-info" aria-label="Writing Date📅" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2024-03-08T08:56:20.000Z"></span><!----><span class="page-reading-time-info" aria-label="Reading Time⌛" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>About 15 min</span><meta property="timeRequired" content="PT15M"></span><!----><span class="page-tag-info" aria-label="Tag🏷" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon tag-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="tag icon"><path d="M939.902 458.563L910.17 144.567c-1.507-16.272-14.465-29.13-30.737-30.737L565.438 84.098h-.402c-3.215 0-5.726 1.005-7.634 2.913l-470.39 470.39a10.004 10.004 0 000 14.164l365.423 365.424c1.909 1.908 4.42 2.913 7.132 2.913s5.223-1.005 7.132-2.913l470.39-470.39c2.01-2.11 3.014-5.023 2.813-8.036zm-240.067-72.121c-35.458 0-64.286-28.828-64.286-64.286s28.828-64.285 64.286-64.285 64.286 28.828 64.286 64.285-28.829 64.286-64.286 64.286z"></path></svg><!--[--><span class="page-tag-item tag0 clickable" role="navigation">pwn</span><span class="page-tag-item tag1 clickable" role="navigation">heap</span><!--]--><meta property="keywords" content="pwn,heap"></span></div><hr></div><div class="toc-place-holder"><aside id="toc"><!--[--><!----><!--]--><div class="toc-header">On This Page<button type="button" class="print-button" title="Print"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button></div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="#源码分析-largebin-malloc">源码分析(largebin malloc)</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#unsortedbin的合并-入链-分配操作">Unsortedbin的合并/入链/分配操作</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#遍历的开始-梦的开始">遍历的开始（梦的开始）</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#调试">调试</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#安全检查机制">安全检查机制</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#直接返回smallbin-chunk情况">直接返回smallbin_chunk情况</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#从unsortedbin中移除">从unsortedbin中移除</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#大小刚好相等情况">大小刚好相等情况</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#归类入链操作">归类入链操作</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#small-和-large最终入bin操作">small 和 large最终入bin操作</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#smallbin的fwd-bck赋值">smallbin的fwd bck赋值</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#largebin-入bin链和chunk-size链">largebin 入bin链和chunk size链</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#从largebin中获取chunk">从largebin中获取chunk</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#chunk脱链-remainder-chunk入链">chunk脱链 remainder chunk入链</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#返回被切割后的chunk">返回被切割后的chunk</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#从topchunk中获取chunk">从topchunk中获取chunk</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#int-free-源码">_int_free_源码</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="#漏洞利用">漏洞利用</a></li><!----><!--]--></ul><div class="toc-marker" style="top:-1.7rem;"></div></div><!--[--><!----><!--]--></aside></div><!--[--><!----><!--]--><div class="theme-hope-content"><h1 id="large-bin-attack学习-int-malloc源码细读" tabindex="-1"><a class="header-anchor" href="#large-bin-attack学习-int-malloc源码细读" aria-hidden="true">#</a> large Bin Attack学习（_int_malloc源码细读 ）</h1><blockquote><p>参考文章:<br>wiki:<a href="https://ctf-wiki.org/pwn/linux/user-mode/heap/ptmalloc2/large-bin-attack/" target="_blank" rel="noopener noreferrer">Large Bin Attack - CTF Wiki (ctf-wiki.org)<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a><br>源码级调试glibc:<a href="https://blog.csdn.net/astrotycoon/article/details/52662685" target="_blank" rel="noopener noreferrer">源码级调试glibc_glibc cannot be compiled without optimization-CSDN博客<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a><br>源码分析:<a href="https://www.cnblogs.com/luoleqi/p/15520621.html" target="_blank" rel="noopener noreferrer">glibc 2.31 malloc与free 源码分析（持续更新） - PwnKi - 博客园 (cnblogs.com)<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>+<a href="https://www.cnblogs.com/luoleqi/p/12731875.html#_int_malloc" target="_blank" rel="noopener noreferrer">glibc malloc源码分析 - PwnKi - 博客园 (cnblogs.com)<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a><br>详细拆分了_int_malloc的流程 并且按照功能分了标题 想要了解对应部分就直接点击标题跳转即可<br>第一次阅读glibc的源码然后进行分析 有错误的地方请大佬指正</p></blockquote><h2 id="源码分析-largebin-malloc" tabindex="-1"><a class="header-anchor" href="#源码分析-largebin-malloc" aria-hidden="true">#</a> 源码分析(largebin malloc)</h2><blockquote><p>每次去看别人文章分析总结的 总感觉比较难记住 每个libc版本的区别 然后也没彻底理解一些操作 所以进行阅读源码</p><p>然后重点是检查机制部分 如果只想看重点就直接跳转到<a href="#largebin">largebin入链操作</a></p></blockquote><ul><li><p>然后在正式阅读源码之前 我们先理清楚largebin的结构（去除了头部的fd_nextsize/bk_nextsize 为了图片干净一点）</p><figure><img src="https://awaqwqa.github.io/img/large_bin_attack/largebin_attack.png" alt="largebin_struct" tabindex="0" loading="lazy"><figcaption>largebin_struct</figcaption></figure><ul><li><p>我们可以简化一下 去除尾链的fd和头链的bk方便我们理清逻辑</p><figure><img src="https://awaqwqa.github.io/img/large_bin_attack/struct.png" alt="large_struct" tabindex="0" loading="lazy"><figcaption>large_struct</figcaption></figure></li><li><p>大概就是这个样子 也就是bin头部通过fd/bk链接chunk size链表的头部和尾部 然后chunk size链表之间通过fd_nextsize/bk_nextsize链接</p></li><li><p>chunksize链表中 同一个大小的chunk通过fd/bk进行链接</p></li><li><p>所以largebin的fd和bk和其他的双向链不同我们不能通过从bin一路通过fd返回到large bin的头部</p></li></ul></li></ul><h3 id="unsortedbin的合并-入链-分配操作" tabindex="-1"><a class="header-anchor" href="#unsortedbin的合并-入链-分配操作" aria-hidden="true">#</a> Unsortedbin的合并/入链/分配操作</h3><h3 id="遍历的开始-梦的开始" tabindex="-1"><a class="header-anchor" href="#遍历的开始-梦的开始" aria-hidden="true">#</a> 遍历的开始（梦的开始）</h3><blockquote><p>后面的操作中最重要的就是Victim变量 这个变量是当前循环到的unsortedbin chunk<br>bck变量 也就是bck &lt;-------&gt; victim 这个关系</p></blockquote><ul><li><p>从unsorted_chunk最后一位开始遍历 直到碰到unsorted_bin的头部 我在这里 没很确定是否unsortedbin可不可以指向自己 我们可以调试看看</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>victim <span class="token operator">=</span> <span class="token function">unsorted_chunks</span> <span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token operator">-&gt;</span>bk<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token function">unsorted_chunks</span> <span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    bck <span class="token operator">=</span> victim<span class="token operator">-&gt;</span>bk<span class="token punctuation">;</span>
    size <span class="token operator">=</span> <span class="token function">chunksize</span> <span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">/* 计算 size */</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><h3 id="调试" tabindex="-1"><a class="header-anchor" href="#调试" aria-hidden="true">#</a> 调试</h3><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>unsortedbin
all: 0x555555559680 —▸ 0x7ffff7fb9be0 <span class="token punctuation">(</span>main_arena+96<span class="token punctuation">)</span> ◂— 0x555555559680
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><p>然后查看chunk结构</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>Free chunk <span class="token punctuation">(</span>unsortedbin<span class="token punctuation">)</span> <span class="token operator">|</span> PREV_INUSE
Addr: 0x555555559680
Size: 0x90 <span class="token punctuation">(</span>with flag bits: 0x91<span class="token punctuation">)</span>
fd: 0x7ffff7fb9be0
bk: 0x7ffff7fb9be0
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>查看unsortedbin的大小</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>pwndbg<span class="token operator">&gt;</span> tel  0x7ffff7fb9be0
00:0000│ rdx r10 r11 0x7ffff7fb9be0 <span class="token punctuation">(</span>main_arena+96<span class="token punctuation">)</span> —▸ 0x5555555597a0 ◂— 0x0
01:0008│             0x7ffff7fb9be8 <span class="token punctuation">(</span>main_arena+104<span class="token punctuation">)</span> ◂— 0x0
02:0010│             0x7ffff7fb9bf0 <span class="token punctuation">(</span>main_arena+112<span class="token punctuation">)</span> —▸ 0x555555559680 ◂— 0x0
03:0018│             0x7ffff7fb9bf8 <span class="token punctuation">(</span>main_arena+120<span class="token punctuation">)</span> —▸ 0x555555559680 ◂— 0x0
04:0020│             0x7ffff7fb9c00 <span class="token punctuation">(</span>main_arena+128<span class="token punctuation">)</span> —▸ 0x7ffff7fb9bf0 <span class="token punctuation">(</span>main_arena+112<span class="token punctuation">)</span> —▸ 0x555555559680 ◂— 0x0
05:0028│             0x7ffff7fb9c08 <span class="token punctuation">(</span>main_arena+136<span class="token punctuation">)</span> —▸ 0x7ffff7fb9bf0 <span class="token punctuation">(</span>main_arena+112<span class="token punctuation">)</span> —▸ 0x555555559680 ◂— 0x0
06:0030│             0x7ffff7fb9c10 <span class="token punctuation">(</span>main_arena+144<span class="token punctuation">)</span> —▸ 0x7ffff7fb9c00 <span class="token punctuation">(</span>main_arena+128<span class="token punctuation">)</span> —▸ 0x7ffff7fb9bf0 <span class="token punctuation">(</span>main_arena+112<span class="token punctuation">)</span> —▸ 0x555555559680 ◂— 0x0
07:0038│             0x7ffff7fb9c18 <span class="token punctuation">(</span>main_arena+152<span class="token punctuation">)</span> —▸ 0x7ffff7fb9c00 <span class="token punctuation">(</span>main_arena+128<span class="token punctuation">)</span> —▸ 0x7ffff7fb9bf0 <span class="token punctuation">(</span>main_arena+112<span class="token punctuation">)</span> —▸ 0x555555559680 ◂— 0x0
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>可以发现fd bk都是指向的unsortedbin中第一个chunk 我们清空unsortedbin看看</p><div class="language-shelll line-numbers-mode" data-ext="shelll"><pre class="language-shelll"><code>pwndbg&gt; tel 0x7ffff7fb9be0
00:0000│ rsi r11 0x7ffff7fb9be0 (main_arena+96) —▸ 0x555555559830 ◂— 0x0
01:0008│         0x7ffff7fb9be8 (main_arena+104) —▸ 0x555555559710 ◂— 0x90
02:0010│         0x7ffff7fb9bf0 (main_arena+112) —▸ 0x7ffff7fb9be0 (main_arena+96) —▸ 0x555555559830 ◂— 0x0
03:0018│         0x7ffff7fb9bf8 (main_arena+120) —▸ 0x7ffff7fb9be0 (main_arena+96) —▸ 0x555555559830 ◂— 0x0
04:0020│         0x7ffff7fb9c00 (main_arena+128) —▸ 0x7ffff7fb9bf0 (main_arena+112) —▸ 0x7ffff7fb9be0 (main_arena+96) —▸ 0x555555559830 ◂— 0x0
05:0028│         0x7ffff7fb9c08 (main_arena+136) —▸ 0x7ffff7fb9bf0 (main_arena+112) —▸ 0x7ffff7fb9be0 (main_arena+96) —▸ 0x555555559830 ◂— 0x0
06:0030│         0x7ffff7fb9c10 (main_arena+144) —▸ 0x7ffff7fb9c00 (main_arena+128) —▸ 0x7ffff7fb9bf0 (main_arena+112) —▸ 0x7ffff7fb9be0 (main_arena+96) —▸ 0x555555559830 ◂— ...
07:0038│         0x7ffff7fb9c18 (main_arena+152) —▸ 0x7ffff7fb9c00 (main_arena+128) —▸ 0x7ffff7fb9bf0 (main_arena+112) —▸ 0x7ffff7fb9be0 (main_arena+96) —▸ 0x55555555983
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>我们会发现fd和bk都是指向了自己本身也就是main_arena+96这个位置</li></ul></li></ul><h3 id="安全检查机制" tabindex="-1"><a class="header-anchor" href="#安全检查机制" aria-hidden="true">#</a> 安全检查机制</h3><blockquote><p>这里的安全机制全是对unsortedbin中的chunk进行的检查</p></blockquote><ul><li><p>不能小于2*SIZE_SZ不能大于av-&gt;system_men也就是该分配去的内存分配总量</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__glibc_unlikely</span> <span class="token punctuation">(</span>size <span class="token operator">&lt;=</span> <span class="token number">2</span> <span class="token operator">*</span> SIZE_SZ<span class="token punctuation">)</span>
              <span class="token operator">||</span> <span class="token function">__glibc_unlikely</span> <span class="token punctuation">(</span>size <span class="token operator">&gt;</span> av<span class="token operator">-&gt;</span>system_mem<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token function">malloc_printerr</span> <span class="token punctuation">(</span><span class="token string">&quot;malloc(): invalid size (unsorted)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><p>对next chunk(物理意义上的紧挨着)也进行一样的操作</p><blockquote><p>mchunkptr next = chunk_at_offset (victim, size); /* 获得指向内存空间中当前 chunk 的下一个chunk 的指针 */</p></blockquote><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__glibc_unlikely</span> <span class="token punctuation">(</span><span class="token function">chunksize_nomask</span> <span class="token punctuation">(</span>next<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">2</span> <span class="token operator">*</span> SIZE_SZ<span class="token punctuation">)</span><span class="token operator">||</span> <span class="token function">__glibc_unlikely</span> <span class="token punctuation">(</span><span class="token function">chunksize_nomask</span> <span class="token punctuation">(</span>next<span class="token punctuation">)</span> <span class="token operator">&gt;</span> av<span class="token operator">-&gt;</span>system_mem<span class="token punctuation">)</span><span class="token punctuation">)</span>
     <span class="token function">malloc_printerr</span> <span class="token punctuation">(</span><span class="token string">&quot;malloc(): invalid next size (unsorted)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div></li></ul></li><li><p>检查next chunk的prev_size 是否等于当前的chunk size</p><blockquote><p>size = chunksize (victim); /* 计算 size */</p></blockquote><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token comment">/* 如果 next chunk 中记录前一个 chunk 大小的 prev_size 与 size 不符，则报错 */</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__glibc_unlikely</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">prev_size</span> <span class="token punctuation">(</span>next<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token operator">~</span><span class="token punctuation">(</span>SIZE_BITS<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> size<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token function">malloc_printerr</span> <span class="token punctuation">(</span><span class="token string">&quot;malloc(): mismatching next-&gt;prev_size (unsorted)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>检查bck的fd是否为当前chunk 或者当前chunk的fd是否是bin的头结点</p><blockquote><p>bck = victim-&gt;bk;</p><p>victim = unsorted_chunks (av)-&gt;bk)</p><p>应该就是检查下一个chunk是否是合法的</p></blockquote><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__glibc_unlikely</span> <span class="token punctuation">(</span>bck<span class="token operator">-&gt;</span>fd <span class="token operator">!=</span> victim<span class="token punctuation">)</span>
              <span class="token operator">||</span> <span class="token function">__glibc_unlikely</span> <span class="token punctuation">(</span>victim<span class="token operator">-&gt;</span>fd <span class="token operator">!=</span> <span class="token function">unsorted_chunks</span> <span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token function">malloc_printerr</span> <span class="token punctuation">(</span><span class="token string">&quot;malloc(): unsorted double linked list corrupted&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>检查当前chunk是否是free的 通过next chunk的p值</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code> <span class="token comment">/* 如果 next chunk 中的显示前一个 chunk 是否正在使用的标志位为1，*/</span>
 <span class="token comment">/* 即前一个 chunk 正在使用，则报错 */</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__glibc_unlikely</span> <span class="token punctuation">(</span><span class="token function">prev_inuse</span> <span class="token punctuation">(</span>next<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
 	<span class="token function">malloc_printerr</span> <span class="token punctuation">(</span><span class="token string">&quot;malloc(): invalid next-&gt;prev_inuse (unsorted)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><h3 id="直接返回smallbin-chunk情况" tabindex="-1"><a class="header-anchor" href="#直接返回smallbin-chunk情况" aria-hidden="true">#</a> 直接返回smallbin_chunk情况</h3><blockquote><p>然后就是从unsortedbin割small chunk 如果符合条件</p><ul><li><p>所需chunk大小在smallbin的范围之内</p></li><li><p>bck为unsortedbin的头 也就是unsortedbin中仅有一个chunk</p></li><li><p>victim为last remainder chunk 也就是分割过一次</p></li><li><p>大小刚好大于所需nb大小+Minsize(这里猜测就是一个最小chunk 这样才能切割)</p></li></ul><p>满足以上条件 就直接分割 然后将victim返回给用户</p></blockquote><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">in_smallbin_range</span> <span class="token punctuation">(</span>nb<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
    bck <span class="token operator">==</span> <span class="token function">unsorted_chunks</span> <span class="token punctuation">(</span>av<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
    victim <span class="token operator">==</span> av<span class="token operator">-&gt;</span>last_remainder <span class="token operator">&amp;&amp;</span>
    <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>size<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>nb <span class="token operator">+</span> MINSIZE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    remainder_size <span class="token operator">=</span> size <span class="token operator">-</span> nb<span class="token punctuation">;</span>
    remainder <span class="token operator">=</span> <span class="token function">chunk_at_offset</span> <span class="token punctuation">(</span>victim<span class="token punctuation">,</span> nb<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">unsorted_chunks</span> <span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token operator">-&gt;</span>bk <span class="token operator">=</span> <span class="token function">unsorted_chunks</span> <span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token operator">-&gt;</span>fd <span class="token operator">=</span> remainder<span class="token punctuation">;</span>
    av<span class="token operator">-&gt;</span>last_remainder <span class="token operator">=</span> remainder<span class="token punctuation">;</span>
    remainder<span class="token operator">-&gt;</span>bk <span class="token operator">=</span> remainder<span class="token operator">-&gt;</span>fd <span class="token operator">=</span> <span class="token function">unsorted_chunks</span> <span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">in_smallbin_range</span> <span class="token punctuation">(</span>remainder_size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        remainder<span class="token operator">-&gt;</span>fd_nextsize <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        remainder<span class="token operator">-&gt;</span>bk_nextsize <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">set_head</span> <span class="token punctuation">(</span>victim<span class="token punctuation">,</span> nb <span class="token operator">|</span> PREV_INUSE <span class="token operator">|</span> <span class="token punctuation">(</span>av <span class="token operator">!=</span> <span class="token operator">&amp;</span>main_arena <span class="token operator">?</span> NON_MAIN_ARENA <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">set_head</span> <span class="token punctuation">(</span>remainder<span class="token punctuation">,</span> remainder_size <span class="token operator">|</span> PREV_INUSE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">set_foot</span> <span class="token punctuation">(</span>remainder<span class="token punctuation">,</span> remainder_size<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">check_malloced_chunk</span> <span class="token punctuation">(</span>av<span class="token punctuation">,</span> victim<span class="token punctuation">,</span> nb<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token function">chunk2mem</span> <span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">alloc_perturb</span> <span class="token punctuation">(</span>p<span class="token punctuation">,</span> bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> p<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="从unsortedbin中移除" tabindex="-1"><a class="header-anchor" href="#从unsortedbin中移除" aria-hidden="true">#</a> 从unsortedbin中移除</h3><blockquote><p>在这里已经将chunk从unsortdbin中移除</p></blockquote><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code> <span class="token function">unsorted_chunks</span> <span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token operator">-&gt;</span>bk <span class="token operator">=</span> bck<span class="token punctuation">;</span>
 bck<span class="token operator">-&gt;</span>fd <span class="token operator">=</span> <span class="token function">unsorted_chunks</span> <span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="大小刚好相等情况" tabindex="-1"><a class="header-anchor" href="#大小刚好相等情况" aria-hidden="true">#</a> 大小刚好相等情况</h3><ul><li><p>如果chunk和当前需要的chunk大小一致 则直接返回chunk 并且设置物理意义上紧挨着的下一个chunk的size中p为0也就是free状态</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token function">set_inuse_bit_at_offset</span> <span class="token punctuation">(</span>victim<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li><li><p>如果开启了tcache机制 且tcache未满则将chunk放入tcache中</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>tcache_nb <span class="token operator">&amp;&amp;</span> tcache<span class="token operator">-&gt;</span>counts<span class="token punctuation">[</span>tc_idx<span class="token punctuation">]</span> <span class="token operator">&lt;</span> mp_<span class="token punctuation">.</span>tcache_count<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">tcache_put</span> <span class="token punctuation">(</span>victim<span class="token punctuation">,</span> tc_idx<span class="token punctuation">)</span><span class="token punctuation">;</span> 
    return_cached <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">continue</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>然后直接返回</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token function">check_malloced_chunk</span> <span class="token punctuation">(</span>av<span class="token punctuation">,</span> victim<span class="token punctuation">,</span> nb<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token function">chunk2mem</span> <span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">alloc_perturb</span> <span class="token punctuation">(</span>p<span class="token punctuation">,</span> bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> p<span class="token punctuation">;</span>  <span class="token comment">/* 返回内存指针 */</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><h3 id="归类入链操作" tabindex="-1"><a class="header-anchor" href="#归类入链操作" aria-hidden="true">#</a> 归类入链操作<span id="largebin"></span></h3><blockquote><p>这里主要是将unsortedbin合并后的 入small链表或者large链表的操作</p><p>这里的fwd和bck记好了 我们从unsortedbin抠出来的chunk就要合并进入fwd和bck的中间</p><p>这后面的操作往往是先让fwd到指定的位置 然后bck通过fwd-&gt;bk来进行的定位</p></blockquote><h3 id="small-和-large最终入bin操作" tabindex="-1"><a class="header-anchor" href="#small-和-large最终入bin操作" aria-hidden="true">#</a> small 和 large最终入bin操作</h3><blockquote><p>这里把最后的部分 直接提前 拿出来 因为smallbin和largebin的入链操作都含这个代码</p><p>largebin还有chunk size的入链操作 以及其他的复杂检查</p></blockquote><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token function">mark_bin</span> <span class="token punctuation">(</span>av<span class="token punctuation">,</span> victim_index<span class="token punctuation">)</span><span class="token punctuation">;</span>
victim<span class="token operator">-&gt;</span>bk <span class="token operator">=</span> bck<span class="token punctuation">;</span>
victim<span class="token operator">-&gt;</span>fd <span class="token operator">=</span> fwd<span class="token punctuation">;</span>
fwd<span class="token operator">-&gt;</span>bk <span class="token operator">=</span> victim<span class="token punctuation">;</span>
bck<span class="token operator">-&gt;</span>fd <span class="token operator">=</span> victim<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="smallbin的fwd-bck赋值" tabindex="-1"><a class="header-anchor" href="#smallbin的fwd-bck赋值" aria-hidden="true">#</a> smallbin的fwd bck赋值</h3><ul><li><p>如果属于small bin则进行fwd和bck的赋值</p><blockquote><p>small bin 的链表表头赋值给 bck:bck = bin_at (av, victim_index);</p><p>首个chunk赋值给fwd :fwd = bck-&gt;fd;</p></blockquote><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">in_smallbin_range</span> <span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    victim_index <span class="token operator">=</span> <span class="token function">smallbin_index</span> <span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    bck <span class="token operator">=</span> <span class="token function">bin_at</span> <span class="token punctuation">(</span>av<span class="token punctuation">,</span> victim_index<span class="token punctuation">)</span><span class="token punctuation">;</span>
    fwd <span class="token operator">=</span> bck<span class="token operator">-&gt;</span>fd<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><h3 id="largebin-入bin链和chunk-size链" tabindex="-1"><a class="header-anchor" href="#largebin-入bin链和chunk-size链" aria-hidden="true">#</a> largebin 入bin链和chunk size链</h3><ul><li><p>如果属于large_bins同理进行赋值 然后判断该插入什么合适的位置</p><blockquote><p>因为largebin是按照大小进行的排序 由大到小 所以最小的在链表最后</p></blockquote><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code>victim_index <span class="token operator">=</span> <span class="token function">largebin_index</span> <span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
bck <span class="token operator">=</span> <span class="token function">bin_at</span> <span class="token punctuation">(</span>av<span class="token punctuation">,</span> victim_index<span class="token punctuation">)</span><span class="token punctuation">;</span>
fwd <span class="token operator">=</span> bck<span class="token operator">-&gt;</span>fd<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><p>判断large是否有空闲chunk:</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>fwd <span class="token operator">!=</span> bck<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li><li><p>如果当前chunk比最后一位chunk还小则直接加入链表末尾</p><blockquote><p>bck是头 bck-&gt;bk应该就是最后一位</p><p>然后要加入fwd和bck之间 我们应该先调整fwd和bck 所以bck改为链表最后一位 fwd改为链表头</p><p>bck&lt;-----&gt;chunk&lt;-----&gt;fwd</p></blockquote><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token operator">&lt;</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token function">chunksize_nomask</span> <span class="token punctuation">(</span>bck<span class="token operator">-&gt;</span>bk<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    fwd <span class="token operator">=</span> bck<span class="token punctuation">;</span>
    bck <span class="token operator">=</span> bck<span class="token operator">-&gt;</span>bk<span class="token punctuation">;</span>
    victim<span class="token operator">-&gt;</span>fd_nextsize <span class="token operator">=</span> fwd<span class="token operator">-&gt;</span>fd<span class="token punctuation">;</span>
    victim<span class="token operator">-&gt;</span>bk_nextsize <span class="token operator">=</span> fwd<span class="token operator">-&gt;</span>fd<span class="token operator">-&gt;</span>bk_nextsize<span class="token punctuation">;</span>
    fwd<span class="token operator">-&gt;</span>fd<span class="token operator">-&gt;</span>bk_nextsize <span class="token operator">=</span> victim<span class="token operator">-&gt;</span>bk_nextsize<span class="token operator">-&gt;</span>fd_nextsize <span class="token operator">=</span> victim<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>否则进行遍历判断 匹配第一个小于等于 当前chunk的</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> size <span class="token operator">&lt;</span> <span class="token function">chunksize_nomask</span> <span class="token punctuation">(</span>fwd<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    fwd <span class="token operator">=</span> fwd<span class="token operator">-&gt;</span>fd_nextsize<span class="token punctuation">;</span>
    <span class="token function">assert</span> <span class="token punctuation">(</span><span class="token function">chunk_main_arena</span> <span class="token punctuation">(</span>fwd<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>如果该chunk与当前chunk相同则让chunk插入fwd之后 所以</p><blockquote><p>因为large bin是按照大小进行的排序 所以我们为了不额外修改chunk size链表 直接将chunk链接到fwd后面</p></blockquote><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> size<span class="token operator">==</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token function">chunksize_nomask</span> <span class="token punctuation">(</span>fwd<span class="token punctuation">)</span><span class="token punctuation">)</span>
    fwd <span class="token operator">=</span> fwd<span class="token operator">-&gt;</span>fd<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p><strong>当我们需求的chunk size大于large中所有的chunk size的情况</strong> 执行largebin的入chunk_size链操作:<span id="attack"></span></p><blockquote><p>这里我理解的是largebin存在两条链 也就是chunk size的链 和fd bk构成的bins链 这里先是入的chunk size的链</p></blockquote><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code>victim<span class="token operator">-&gt;</span>fd_nextsize <span class="token operator">=</span> fwd<span class="token punctuation">;</span>
victim<span class="token operator">-&gt;</span>bk_nextsize <span class="token operator">=</span> fwd<span class="token operator">-&gt;</span>bk_nextsize<span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__glibc_unlikely</span> <span class="token punctuation">(</span>fwd<span class="token operator">-&gt;</span>bk_nextsize<span class="token operator">-&gt;</span>fd_nextsize <span class="token operator">!=</span> fwd<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token function">malloc_printerr</span> <span class="token punctuation">(</span><span class="token string">&quot;malloc(): largebin double linked list corrupted (nextsize)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
fwd<span class="token operator">-&gt;</span>bk_nextsize <span class="token operator">=</span> victim<span class="token punctuation">;</span>
victim<span class="token operator">-&gt;</span>bk_nextsize<span class="token operator">-&gt;</span>fd_nextsize <span class="token operator">=</span> victim<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><p>这里就是重点了 也就是large bin的入链操作</p></li><li><p>首先这是初始状态</p></li></ul></li></ul><p><img src="https://awaqwqa.github.io/img/large_bin_attack/start.png" alt="status01" loading="lazy"> <img src="https://awaqwqa.github.io/img/large_bin_attack/status02.png" alt="status1" loading="lazy"><img src="https://awaqwqa.github.io/img/large_bin_attack/status03.png" alt="status1" loading="lazy"><img src="https://awaqwqa.github.io/img/large_bin_attack/status04.png" alt="status1" loading="lazy"></p><ul><li><p>让bck等于fwd-&gt;bk 也就是把bck提到fwd前方 并且进行安全检查</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code>bck <span class="token operator">=</span> fwd<span class="token operator">-&gt;</span>bk<span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>bck<span class="token operator">-&gt;</span>fd <span class="token operator">!=</span> fwd<span class="token punctuation">)</span>
    <span class="token function">malloc_printerr</span> <span class="token punctuation">(</span><span class="token string">&quot;malloc(): largebin double linked list corrupted (bk)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>最后就是执行入链操作了</p><blockquote><p>在一开始的时候提过</p></blockquote><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token function">mark_bin</span> <span class="token punctuation">(</span>av<span class="token punctuation">,</span> victim_index<span class="token punctuation">)</span><span class="token punctuation">;</span>
victim<span class="token operator">-&gt;</span>bk <span class="token operator">=</span> bck<span class="token punctuation">;</span>
victim<span class="token operator">-&gt;</span>fd <span class="token operator">=</span> fwd<span class="token punctuation">;</span>
fwd<span class="token operator">-&gt;</span>bk <span class="token operator">=</span> victim<span class="token punctuation">;</span>
bck<span class="token operator">-&gt;</span>fd <span class="token operator">=</span> victim<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul></li></ul><h3 id="从largebin中获取chunk" tabindex="-1"><a class="header-anchor" href="#从largebin中获取chunk" aria-hidden="true">#</a> 从largebin中获取chunk</h3><ul><li><p>largebin情况</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">in_smallbin_range</span> <span class="token punctuation">(</span>nb<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li></ul><h3 id="chunk脱链-remainder-chunk入链" tabindex="-1"><a class="header-anchor" href="#chunk脱链-remainder-chunk入链" aria-hidden="true">#</a> chunk脱链 remainder chunk入链</h3><blockquote><p>首先是判断情况 我们只处理这一种情况:largebin中有chunk 然后largebin中最大的chunk大于我们的需求</p><p>接下来的代码都是从largebin中获取chunk</p></blockquote><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>victim <span class="token operator">=</span> <span class="token function">first</span> <span class="token punctuation">(</span>bin<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> bin <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token function">chunksize_nomask</span> <span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token operator">&gt;=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>nb<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ul><li><p>取最小的chunk 反方向循环 找到刚好大于等于我们所需chunk size的 chunk</p><blockquote><p>如果一个大小的chunk链表中有多个chunk 优先取第二个 不轻易改变chunk size链表的值</p></blockquote><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token comment">// 取largebin的最后一个chunk 也就是最小的那个chunk </span>
victim <span class="token operator">=</span> victim<span class="token operator">-&gt;</span>bk_nextsize<span class="token punctuation">;</span>
<span class="token comment">// 取首个大于所需的chunk size的large chunk</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>size <span class="token operator">=</span> <span class="token function">chunksize</span> <span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>nb<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    victim <span class="token operator">=</span> victim<span class="token operator">-&gt;</span>bk_nextsize<span class="token punctuation">;</span>

<span class="token comment">/* Avoid removing the first entry for a size so that the skip
                 list does not have to be rerouted.  */</span>
<span class="token comment">//  这里避免删除chunk size链中的首个chunk 避免我们修改chunk size链表 所以我们取第二个</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>victim <span class="token operator">!=</span> <span class="token function">last</span> <span class="token punctuation">(</span>bin<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">chunksize_nomask</span> <span class="token punctuation">(</span>victim<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token function">chunksize_nomask</span> <span class="token punctuation">(</span>victim<span class="token operator">-&gt;</span>fd<span class="token punctuation">)</span><span class="token punctuation">)</span>
    victim <span class="token operator">=</span> victim<span class="token operator">-&gt;</span>fd<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>chunk 通过unlink脱链 remainder chunk入unsortedbin链</p><blockquote><p>安全检查 是否切割后的chunk大于minsize 与安全检查 largebin第一个chunk和头的互锁状态</p></blockquote><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code> <span class="token comment">// 算剩余的remainder_size</span>
 remainder_size <span class="token operator">=</span> size <span class="token operator">-</span> nb<span class="token punctuation">;</span>
 <span class="token comment">// 对 我们large bin中的chunk 进行unlink操作</span>
 <span class="token function">unlink_chunk</span> <span class="token punctuation">(</span>av<span class="token punctuation">,</span> victim<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/* Exhaust */</span>
<span class="token comment">// 安全检查 如果切割的chunk 小于Minsize 则 设置下一个chunk p为0</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>remainder_size <span class="token operator">&lt;</span> MINSIZE<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token function">set_inuse_bit_at_offset</span> <span class="token punctuation">(</span>victim<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>av <span class="token operator">!=</span> <span class="token operator">&amp;</span>main_arena<span class="token punctuation">)</span>
		<span class="token function">set_non_main_arena</span> <span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
     remainder <span class="token operator">=</span> <span class="token function">chunk_at_offset</span> <span class="token punctuation">(</span>victim<span class="token punctuation">,</span> nb<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/* We cannot assume the unsorted list is empty and therefore
                     have to perform a complete insert here.  */</span>
    <span class="token comment">// 根据注释大概知道是进行完整的插入操作</span>
    <span class="token comment">// 取得unsorted_chunk bin链表的的头</span>
    bck <span class="token operator">=</span> <span class="token function">unsorted_chunks</span><span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 取 第一个chunk</span>
    fwd <span class="token operator">=</span> bck<span class="token operator">-&gt;</span>fd<span class="token punctuation">;</span>
    <span class="token comment">// 安全检查:检查第一个chunk的bk是否为unsorted bin的头</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__glibc_unlikely</span> <span class="token punctuation">(</span>fwd<span class="token operator">-&gt;</span>bk <span class="token operator">!=</span> bck<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">malloc_printerr</span> <span class="token punctuation">(</span><span class="token string">&quot;malloc(): corrupted unsorted chunks&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// remainder 入unsortedbin</span>
    remainder<span class="token operator">-&gt;</span>bk <span class="token operator">=</span> bck<span class="token punctuation">;</span>
    remainder<span class="token operator">-&gt;</span>fd <span class="token operator">=</span> fwd<span class="token punctuation">;</span>
    bck<span class="token operator">-&gt;</span>fd <span class="token operator">=</span> remainder<span class="token punctuation">;</span>
    fwd<span class="token operator">-&gt;</span>bk <span class="token operator">=</span> remainder<span class="token punctuation">;</span>
    <span class="token comment">// 如果是remiander 则将fd_nextsize bk_nextsize 设置为null</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">in_smallbin_range</span> <span class="token punctuation">(</span>remainder_size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        remainder<span class="token operator">-&gt;</span>fd_nextsize <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        remainder<span class="token operator">-&gt;</span>bk_nextsize <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 这里应该是设置head的一系列操作</span>
    <span class="token function">set_head</span> <span class="token punctuation">(</span>victim<span class="token punctuation">,</span> nb <span class="token operator">|</span> PREV_INUSE <span class="token operator">|</span>
              <span class="token punctuation">(</span>av <span class="token operator">!=</span> <span class="token operator">&amp;</span>main_arena <span class="token operator">?</span> NON_MAIN_ARENA <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">set_head</span> <span class="token punctuation">(</span>remainder<span class="token punctuation">,</span> remainder_size <span class="token operator">|</span> PREV_INUSE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// foot就是下一个chunk的prev_size部分 </span>
    <span class="token function">set_foot</span> <span class="token punctuation">(</span>remainder<span class="token punctuation">,</span> remainder_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><h3 id="返回被切割后的chunk" tabindex="-1"><a class="header-anchor" href="#返回被切割后的chunk" aria-hidden="true">#</a> 返回被切割后的chunk</h3><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token function">check_malloced_chunk</span> <span class="token punctuation">(</span>av<span class="token punctuation">,</span> victim<span class="token punctuation">,</span> nb<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token function">chunk2mem</span> <span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">alloc_perturb</span> <span class="token punctuation">(</span>p<span class="token punctuation">,</span> bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> p<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="从topchunk中获取chunk" tabindex="-1"><a class="header-anchor" href="#从topchunk中获取chunk" aria-hidden="true">#</a> 从topchunk中获取chunk</h3><blockquote><p>我是大概浏览的 大概意思是去剩下的chunk中寻找 如果没找到就去topchunk分配 如果topchunk不够就去系统申请</p></blockquote><h3 id="int-free-源码" tabindex="-1"><a class="header-anchor" href="#int-free-源码" aria-hidden="true">#</a> _int_free_源码</h3><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code>
<span class="token keyword">static</span> <span class="token keyword">void</span>
<span class="token function">_int_free</span> <span class="token punctuation">(</span>mstate av<span class="token punctuation">,</span> mchunkptr p<span class="token punctuation">,</span> <span class="token keyword">int</span> have_lock<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  INTERNAL_SIZE_T size<span class="token punctuation">;</span>        <span class="token comment">/* its size */</span>
  mfastbinptr <span class="token operator">*</span>fb<span class="token punctuation">;</span>             <span class="token comment">/* associated fastbin */</span>
  mchunkptr nextchunk<span class="token punctuation">;</span>         <span class="token comment">/* next contiguous chunk */</span>
  INTERNAL_SIZE_T nextsize<span class="token punctuation">;</span>    <span class="token comment">/* its size */</span>
  <span class="token keyword">int</span> nextinuse<span class="token punctuation">;</span>               <span class="token comment">/* true if nextchunk is used */</span>
  INTERNAL_SIZE_T prevsize<span class="token punctuation">;</span>    <span class="token comment">/* size of previous contiguous chunk */</span>
  mchunkptr bck<span class="token punctuation">;</span>               <span class="token comment">/* misc temp for linking */</span>
  mchunkptr fwd<span class="token punctuation">;</span>               <span class="token comment">/* misc temp for linking */</span>
  <span class="token comment">// 获取size大小 </span>
  size <span class="token operator">=</span> <span class="token function">chunksize</span> <span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* Little security check which won&#39;t hurt performance: the
     allocator never wrapps around at the end of the address space.
     Therefore we can exclude some size values which might appear
     here by accident or by &quot;design&quot; from some intruder.  */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uintptr_t</span><span class="token punctuation">)</span> p <span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token class-name">uintptr_t</span><span class="token punctuation">)</span> <span class="token operator">-</span>size<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
      <span class="token operator">||</span> <span class="token function">__builtin_expect</span> <span class="token punctuation">(</span><span class="token function">misaligned_chunk</span> <span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token function">malloc_printerr</span> <span class="token punctuation">(</span><span class="token string">&quot;free(): invalid pointer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">/* We know that each chunk is at least MINSIZE bytes in size or a
     multiple of MALLOC_ALIGNMENT.  */</span>
    <span class="token comment">//  要大于MINSIZE 以及内存对齐?</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__glibc_unlikely</span> <span class="token punctuation">(</span>size <span class="token operator">&lt;</span> MINSIZE <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">aligned_OK</span> <span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token function">malloc_printerr</span> <span class="token punctuation">(</span><span class="token string">&quot;free(): invalid size&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">check_inuse_chunk</span><span class="token punctuation">(</span>av<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">USE_TCACHE</span></span>
  <span class="token punctuation">{</span>
    <span class="token class-name">size_t</span> tc_idx <span class="token operator">=</span> <span class="token function">csize2tidx</span> <span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>tcache
	<span class="token operator">&amp;&amp;</span> tc_idx <span class="token operator">&lt;</span> mp_<span class="token punctuation">.</span>tcache_bins
	<span class="token operator">&amp;&amp;</span> tcache<span class="token operator">-&gt;</span>counts<span class="token punctuation">[</span>tc_idx<span class="token punctuation">]</span> <span class="token operator">&lt;</span> mp_<span class="token punctuation">.</span>tcache_count<span class="token punctuation">)</span>
      <span class="token punctuation">{</span>
	<span class="token function">tcache_put</span> <span class="token punctuation">(</span>p<span class="token punctuation">,</span> tc_idx<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

  <span class="token comment">/*
    If eligible, place chunk on a fastbin so it can be found
    and used quickly in malloc.
  */</span>
    <span class="token comment">//  如果是fastbin区间的</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">get_max_fast</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">TRIM_FASTBINS</span></span>
      <span class="token comment">/*
	If TRIM_FASTBINS set, don&#39;t place chunks
	bordering top into fastbins
      */</span>
      <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token function">chunk_at_offset</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> size<span class="token punctuation">)</span> <span class="token operator">!=</span> av<span class="token operator">-&gt;</span>top<span class="token punctuation">)</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
      <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// chunk的size值 得大于chunk最小值 得小于该区域分配的最大size</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span> <span class="token punctuation">(</span><span class="token function">chunksize_nomask</span> <span class="token punctuation">(</span><span class="token function">chunk_at_offset</span> <span class="token punctuation">(</span>p<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&lt;=</span> <span class="token number">2</span> <span class="token operator">*</span> SIZE_SZ<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">||</span> <span class="token function">__builtin_expect</span> <span class="token punctuation">(</span><span class="token function">chunksize</span> <span class="token punctuation">(</span><span class="token function">chunk_at_offset</span> <span class="token punctuation">(</span>p<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&gt;=</span> av<span class="token operator">-&gt;</span>system_mem<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	    bool fail <span class="token operator">=</span> true<span class="token punctuation">;</span>
	<span class="token comment">/* We might not have a lock at this point and concurrent modifications
	   of system_mem might result in a false positive.  Redo the test after
	   getting the lock.  */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>have_lock<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token function">__libc_lock_lock</span> <span class="token punctuation">(</span>av<span class="token operator">-&gt;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            fail <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">chunksize_nomask</span> <span class="token punctuation">(</span><span class="token function">chunk_at_offset</span> <span class="token punctuation">(</span>p<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">2</span> <span class="token operator">*</span> SIZE_SZ
                <span class="token operator">||</span> <span class="token function">chunksize</span> <span class="token punctuation">(</span><span class="token function">chunk_at_offset</span> <span class="token punctuation">(</span>p<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> av<span class="token operator">-&gt;</span>system_mem<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">__libc_lock_unlock</span> <span class="token punctuation">(</span>av<span class="token operator">-&gt;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>fail<span class="token punctuation">)</span>
            <span class="token function">malloc_printerr</span> <span class="token punctuation">(</span><span class="token string">&quot;free(): invalid next size (fast)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token comment">// 清空chunk中除了prev_size 和size的地方</span>
    <span class="token function">free_perturb</span> <span class="token punctuation">(</span><span class="token function">chunk2mem</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">,</span> size <span class="token operator">-</span> <span class="token number">2</span> <span class="token operator">*</span> SIZE_SZ<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">atomic_store_relaxed</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>av<span class="token operator">-&gt;</span>have_fastchunks<span class="token punctuation">,</span> true<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 获取对应fastbin链</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> idx <span class="token operator">=</span> <span class="token function">fastbin_index</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    fb <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token function">fastbin</span> <span class="token punctuation">(</span>av<span class="token punctuation">,</span> idx<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* Atomically link P to its fastbin: P-&gt;FD = *FB; *FB = P;  */</span>
    <span class="token comment">// 将块 P 插入到 fastbin 中。首先，它将当前 fastbin 的头部指针的值赋给块 P 的 FD 字段</span>
    mchunkptr old <span class="token operator">=</span> <span class="token operator">*</span>fb<span class="token punctuation">,</span> old2<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>SINGLE_THREAD_P<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token comment">/* Check that the top of the bin is not the record we are going to
	   add (i.e., double free).  */</span>
       <span class="token comment">// 检查fastbin的头部chunk是否为当前free的chunk</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span> <span class="token punctuation">(</span>old <span class="token operator">==</span> p<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token function">malloc_printerr</span> <span class="token punctuation">(</span><span class="token string">&quot;double free or corruption (fasttop)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// p-&gt;old</span>
        p<span class="token operator">-&gt;</span>fd <span class="token operator">=</span> old<span class="token punctuation">;</span>
        <span class="token operator">*</span>fb <span class="token operator">=</span> p<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span>
        <span class="token keyword">do</span><span class="token punctuation">{</span>
        <span class="token comment">/* Check that the top of the bin is not the record we are going to
            add (i.e., double free).  */</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span> <span class="token punctuation">(</span>old <span class="token operator">==</span> p<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token function">malloc_printerr</span> <span class="token punctuation">(</span><span class="token string">&quot;double free or corruption (fasttop)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            p<span class="token operator">-&gt;</span>fd <span class="token operator">=</span> old2 <span class="token operator">=</span> old<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>old <span class="token operator">=</span> <span class="token function">catomic_compare_and_exchange_val_rel</span> <span class="token punctuation">(</span>fb<span class="token punctuation">,</span> p<span class="token punctuation">,</span> old2<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token operator">!=</span> old2<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/* Check that size of fastbin chunk at the top is the same as
        size of the chunk that we are adding.  We can dereference OLD
        only if we have the lock, otherwise it might have already been
        allocated again.  */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>have_lock <span class="token operator">&amp;&amp;</span> old <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token operator">&amp;&amp;</span> <span class="token function">__builtin_expect</span> <span class="token punctuation">(</span><span class="token function">fastbin_index</span> <span class="token punctuation">(</span><span class="token function">chunksize</span> <span class="token punctuation">(</span>old<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> idx<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token function">malloc_printerr</span> <span class="token punctuation">(</span><span class="token string">&quot;invalid fastbin entry (free)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/*
    Consolidate other non-mmapped chunks as they arrive.
  */</span>
    <span class="token comment">// 如果释放的chunk不属于fastbin 且不是mmap分配的 就获取下一个chunk的指针 nextchunk和nextsize</span>
    <span class="token comment">// 如果前一个chunk空闲 就合并 通过unlink将该chunk脱离出来</span>
    <span class="token comment">// 如果取出来的chunk下一个chunk也是free chunk 且不为top chunk 则也设置为空闲 </span>
    <span class="token comment">// 去除unsortedbin头指针 将合并后的chunk 塞入unsortedbin中</span>
    <span class="token comment">// 如果为top chunk则直接合并</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">chunk_is_mmapped</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">/* If we&#39;re single-threaded, don&#39;t lock the arena.  */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>SINGLE_THREAD_P<span class="token punctuation">)</span>
      have_lock <span class="token operator">=</span> true<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>have_lock<span class="token punctuation">)</span>
      <span class="token function">__libc_lock_lock</span> <span class="token punctuation">(</span>av<span class="token operator">-&gt;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>

    nextchunk <span class="token operator">=</span> <span class="token function">chunk_at_offset</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* Lightweight tests: check whether the block is already the
       top block.  */</span>
    <span class="token comment">//    检查是否等于头一个chunk</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__glibc_unlikely</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> av<span class="token operator">-&gt;</span>top<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token function">malloc_printerr</span> <span class="token punctuation">(</span><span class="token string">&quot;double free or corruption (top)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/* Or whether the next chunk is beyond the boundaries of the arena.  */</span>
    <span class="token comment">// 查看下一个chunk是否大于整个内存空间的边界</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span> <span class="token punctuation">(</span><span class="token function">contiguous</span> <span class="token punctuation">(</span>av<span class="token punctuation">)</span>
			  <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> nextchunk
			  <span class="token operator">&gt;=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> av<span class="token operator">-&gt;</span>top <span class="token operator">+</span> <span class="token function">chunksize</span><span class="token punctuation">(</span>av<span class="token operator">-&gt;</span>top<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	    <span class="token function">malloc_printerr</span> <span class="token punctuation">(</span><span class="token string">&quot;double free or corruption (out)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/* Or whether the block is actually not marked used.  */</span>
    <span class="token comment">// 如果通过nextchunk查看下一个chunk是free状态 也就是当前我们要free的chunk 是free状态 则报错double free</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__glibc_unlikely</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">prev_inuse</span><span class="token punctuation">(</span>nextchunk<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token function">malloc_printerr</span> <span class="token punctuation">(</span><span class="token string">&quot;double free or corruption (!prev)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 获取物理上下一个chunk的大小</span>
    nextsize <span class="token operator">=</span> <span class="token function">chunksize</span><span class="token punctuation">(</span>nextchunk<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 进行2*size+sz&lt;size&lt;system_mem的传统检查</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span> <span class="token punctuation">(</span><span class="token function">chunksize_nomask</span> <span class="token punctuation">(</span>nextchunk<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">2</span> <span class="token operator">*</span> SIZE_SZ<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token operator">||</span> <span class="token function">__builtin_expect</span> <span class="token punctuation">(</span>nextsize <span class="token operator">&gt;=</span> av<span class="token operator">-&gt;</span>system_mem<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token function">malloc_printerr</span> <span class="token punctuation">(</span><span class="token string">&quot;free(): invalid next size (normal)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 清空要free的chunk </span>
    <span class="token function">free_perturb</span> <span class="token punctuation">(</span><span class="token function">chunk2mem</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">,</span> size <span class="token operator">-</span> <span class="token number">2</span> <span class="token operator">*</span> SIZE_SZ<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 如果当前chunk的p为0也就是下一个chunk为freechunk则进行合并</span>
    <span class="token comment">/* consolidate backward */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">prev_inuse</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 获取prev_size作为上一个chunk的size大小</span>
      prevsize <span class="token operator">=</span> <span class="token function">prev_size</span> <span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// size+prevsize也就是新的chunk的大小</span>
      size <span class="token operator">+=</span> prevsize<span class="token punctuation">;</span>
      <span class="token comment">// 获取上一个chunk的头指针</span>
      p <span class="token operator">=</span> <span class="token function">chunk_at_offset</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span> prevsize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 进行unlink操作</span>
      <span class="token function">unlink</span><span class="token punctuation">(</span>av<span class="token punctuation">,</span> p<span class="token punctuation">,</span> bck<span class="token punctuation">,</span> fwd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 如果下一个chunk不为top chunk </span>
    <span class="token comment">// 下一个chunk也是free chunk 则继续进行合并</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>nextchunk <span class="token operator">!=</span> av<span class="token operator">-&gt;</span>top<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">/* get and clear inuse bit */</span>
      <span class="token comment">// 应该是根据指针 和size 算出下一个chunk的size p位置</span>
      nextinuse <span class="token operator">=</span> <span class="token function">inuse_bit_at_offset</span><span class="token punctuation">(</span>nextchunk<span class="token punctuation">,</span> nextsize<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">/* consolidate forward */</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>nextinuse<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">unlink</span><span class="token punctuation">(</span>av<span class="token punctuation">,</span> nextchunk<span class="token punctuation">,</span> bck<span class="token punctuation">,</span> fwd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        size <span class="token operator">+=</span> nextsize<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span>
      <span class="token comment">// 设置nextchunk size p 的部分清空</span>
      <span class="token function">clear_inuse_bit_at_offset</span><span class="token punctuation">(</span>nextchunk<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">/*
	Place the chunk in unsorted chunk list. Chunks are
	not placed into regular bins until after they have
	been given one chance to be used in malloc.
      */</span>

      bck <span class="token operator">=</span> <span class="token function">unsorted_chunks</span><span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">;</span>
      fwd <span class="token operator">=</span> bck<span class="token operator">-&gt;</span>fd<span class="token punctuation">;</span>
    <span class="token comment">//   检查unsortedbin是否合法</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__glibc_unlikely</span> <span class="token punctuation">(</span>fwd<span class="token operator">-&gt;</span>bk <span class="token operator">!=</span> bck<span class="token punctuation">)</span><span class="token punctuation">)</span>
	        <span class="token function">malloc_printerr</span> <span class="token punctuation">(</span><span class="token string">&quot;free(): corrupted unsorted chunks&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// p入unsortedbin链</span>
      p<span class="token operator">-&gt;</span>fd <span class="token operator">=</span> fwd<span class="token punctuation">;</span>
      p<span class="token operator">-&gt;</span>bk <span class="token operator">=</span> bck<span class="token punctuation">;</span>
    <span class="token comment">//   属于largebin大小则设置fd_nextsize bk_nextsize为null</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">in_smallbin_range</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        p<span class="token operator">-&gt;</span>fd_nextsize <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        p<span class="token operator">-&gt;</span>bk_nextsize <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	  <span class="token punctuation">}</span>
    <span class="token comment">// 正式入链</span>
      bck<span class="token operator">-&gt;</span>fd <span class="token operator">=</span> p<span class="token punctuation">;</span>
      fwd<span class="token operator">-&gt;</span>bk <span class="token operator">=</span> p<span class="token punctuation">;</span>
    <span class="token comment">//正常设置size 和foot</span>
      <span class="token function">set_head</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> size <span class="token operator">|</span> PREV_INUSE<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">set_foot</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token function">check_free_chunk</span><span class="token punctuation">(</span>av<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/*
      If the chunk borders the current high end of memory,
      consolidate into top
    */</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
      size <span class="token operator">+=</span> nextsize<span class="token punctuation">;</span>
      <span class="token function">set_head</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> size <span class="token operator">|</span> PREV_INUSE<span class="token punctuation">)</span><span class="token punctuation">;</span>
      av<span class="token operator">-&gt;</span>top <span class="token operator">=</span> p<span class="token punctuation">;</span>
      <span class="token function">check_chunk</span><span class="token punctuation">(</span>av<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/*
      If freeing a large space, consolidate possibly-surrounding
      chunks. Then, if the total unused topmost memory exceeds trim
      threshold, ask malloc_trim to reduce top.

      Unless max_fast is 0, we don&#39;t know if there are fastbins
      bordering top, so we cannot tell for sure whether threshold
      has been reached unless fastbins are consolidated.  But we
      don&#39;t want to consolidate on each free.  As a compromise,
      consolidation is performed if FASTBIN_CONSOLIDATION_THRESHOLD
      is reached.
    */</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> FASTBIN_CONSOLIDATION_THRESHOLD<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">atomic_load_relaxed</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>av<span class="token operator">-&gt;</span>have_fastchunks<span class="token punctuation">)</span><span class="token punctuation">)</span>
	    <span class="token function">malloc_consolidate</span><span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>av <span class="token operator">==</span> <span class="token operator">&amp;</span>main_arena<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">MORECORE_CANNOT_TRIM</span></span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">chunksize</span><span class="token punctuation">(</span>av<span class="token operator">-&gt;</span>top<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span>
	    <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span>mp_<span class="token punctuation">.</span>trim_threshold<span class="token punctuation">)</span><span class="token punctuation">)</span>
	  <span class="token function">systrim</span><span class="token punctuation">(</span>mp_<span class="token punctuation">.</span>top_pad<span class="token punctuation">,</span> av<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
	<span class="token comment">/* Always try heap_trim(), even if the top chunk is not
	   large, because the corresponding heap might go away.  */</span>
	heap_info <span class="token operator">*</span>heap <span class="token operator">=</span> <span class="token function">heap_for_ptr</span><span class="token punctuation">(</span><span class="token function">top</span><span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">assert</span><span class="token punctuation">(</span>heap<span class="token operator">-&gt;</span>ar_ptr <span class="token operator">==</span> av<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">heap_trim</span><span class="token punctuation">(</span>heap<span class="token punctuation">,</span> mp_<span class="token punctuation">.</span>top_pad<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>have_lock<span class="token punctuation">)</span>
      <span class="token function">__libc_lock_unlock</span> <span class="token punctuation">(</span>av<span class="token operator">-&gt;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">/*
    If the chunk was allocated via mmap, release via munmap().
  */</span>

  <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">munmap_chunk</span> <span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="漏洞利用" tabindex="-1"><a class="header-anchor" href="#漏洞利用" aria-hidden="true">#</a> 漏洞利用</h2><blockquote><p>我们主要是利用:<a href="#attack">largechunk中最大的chunk还是小于我们所需求的chunk大小</a>这种情况 我们来详细分析一下这个流程中究竟干了什么</p></blockquote><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code>victim<span class="token operator">-&gt;</span>fd_nextsize <span class="token operator">=</span> fwd<span class="token punctuation">;</span>
victim<span class="token operator">-&gt;</span>bk_nextsize <span class="token operator">=</span> fwd<span class="token operator">-&gt;</span>bk_nextsize<span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__glibc_unlikely</span> <span class="token punctuation">(</span>fwd<span class="token operator">-&gt;</span>bk_nextsize<span class="token operator">-&gt;</span>fd_nextsize <span class="token operator">!=</span> fwd<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token function">malloc_printerr</span> <span class="token punctuation">(</span><span class="token string">&quot;malloc(): largebin double linked list corrupted (nextsize)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
fwd<span class="token operator">-&gt;</span>bk_nextsize <span class="token operator">=</span> victim<span class="token punctuation">;</span>
victim<span class="token operator">-&gt;</span>bk_nextsize<span class="token operator">-&gt;</span>fd_nextsize <span class="token operator">=</span> victim<span class="token punctuation">;</span>
<span class="token comment">// 以及</span>
victim<span class="token operator">-&gt;</span>bk <span class="token operator">=</span> bck<span class="token punctuation">;</span>
victim<span class="token operator">-&gt;</span>fd <span class="token operator">=</span> fwd<span class="token punctuation">;</span>
fwd<span class="token operator">-&gt;</span>bk <span class="token operator">=</span> victim<span class="token punctuation">;</span>
bck<span class="token operator">-&gt;</span>fd <span class="token operator">=</span> victim<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><p>我们可以发现 这里的代码 危险的地方在于 如果现在我们能够修改largebin中fwd位置的chunk 我们就能够泄露victim的地址</p><blockquote><p>我们主要利用这两行代码</p></blockquote><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;
bck-&gt;fd = victim;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>如何实现？比如</p><ul><li>我们修改largebin中的chunk 也就是fwd的bk为我们想要泄露到的<code>目标地址-0x10</code>时 <ul><li>所以fwd-&gt;bk-&gt;fd也就是<code>目标地址</code></li><li>阅读前后逻辑我们知道这段代码中bck=fwd-&gt;bk</li><li>bck-&gt;fd 最后被赋值victim</li><li>所以也就是fwd-&gt;bk-&gt;fd被赋值victim 也就是目标地址赋值victim</li></ul></li><li>我们修改fwd的bk_nextsize为<code>目标地址-0x20</code><ul><li>所以fwd-&gt;bk_nextsize-&gt;fd_nextsize等于目标地址</li><li>然后也因为victim-&gt;bk_nextsize = fwd-&gt;bk_nextsize; 和victim-&gt;bk_nextsize-&gt;fd_nextsize = victim所以等价替换</li><li>fwd-&gt;bk_nextsize-&gt;fd_nextsize=victim也就是目标地址等于victim</li></ul></li></ul></li></ul></div><!--[--><!----><!--]--><footer class="page-meta"><div class="meta-item edit-link"><a href="https://github.com/vuepress-theme-hope/vuepress-theme-hope/edit/main/src/posts/pwn/heap/largeBinAttack.md" rel="noopener noreferrer" target="_blank" aria-label="Edit this page on GitHub" class="nav-link label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->Edit this page on GitHub<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="meta-item git-info"><div class="update-time"><span class="label">Last update: </span><!----></div><div class="contributors"><span class="label">Contributors: </span><!--[--><!--[--><span class="contributor" title="email: 88972629+awaqwqa@users.noreply.github.com">awaqwqa</span><!--]--><!--]--></div></div></footer><nav class="vp-page-nav"><a aria-label="House of lore学习" class="vp-link nav-link prev nav-link prev" href="/posts/pwn/heap/house_of_lore.html"><div class="hint"><span class="arrow start"></span>Prev</div><div class="link"><!---->House of lore学习</div></a><a aria-label="NTUSTISC - Pwn 2学习笔记" class="vp-link nav-link next nav-link next" href="/posts/pwn/heap/studyHeapVedio.html"><div class="hint">Next<span class="arrow end"></span></div><div class="link">NTUSTISC - Pwn 2学习笔记<!----></div></a></nav><!----><!--[--><!----><!--]--><!--]--></main><!--]--><footer class="vp-footer-wrapper"><div class="vp-footer">Default footer</div><div class="vp-copyright">Copyright © 2024 Elegy</div></footer></div><!--]--><!----><!----><!--]--></div>
    <script type="module" src="/assets/app-sBtzFhHn.js" defer></script>
  </body>
</html>
